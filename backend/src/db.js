const oracledb = require('oracledb');
const config = require('./config');

oracledb.outFormat = oracledb.OUT_FORMAT_OBJECT;

let pool;

const connectString = `${config.db.host}:${config.db.port}/${config.db.service}`;

async function initPool() {
  if (pool) {
    return pool;
  }

  pool = await oracledb.createPool({
    user: config.db.user,
    password: config.db.password,
    connectString
  });

  await ensureTokensTable();
  return pool;
}

async function getConnection() {
  const activePool = pool || (await initPool());
  return activePool.getConnection();
}

async function closePool() {
  if (pool) {
    await pool.close(0);
    pool = undefined;
  }
}

async function withConnection(fn) {
  const connection = await getConnection();
  try {
    return await fn(connection);
  } finally {
    try {
      await connection.close();
    } catch (err) {
      // No rethrow to avoid masking original errors.
      console.error('Error closing Oracle connection', err);
    }
  }
}

async function ensureTokensTable() {
  await withConnection(async (conn) => {
    const result = await conn.execute(
      'SELECT COUNT(*) AS COUNT FROM user_tables WHERE table_name = :tname',
      ['TOKENS']
    );
    const count =
      (result.rows && result.rows[0] && (result.rows[0].COUNT ?? result.rows[0].count)) || 0;
    if (count > 0) {
      return;
    }

    await conn.execute(`
      CREATE TABLE tokens (
        id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        user_id NUMBER NOT NULL,
        token VARCHAR2(128) NOT NULL UNIQUE,
        expires_at VARCHAR2(50) NOT NULL,
        created_at VARCHAR2(50) DEFAULT TO_CHAR(SYSTIMESTAMP, 'YYYY-MM-DD"T"HH24:MI:SS"Z"'),
        CONSTRAINT fk_tokens_user FOREIGN KEY (user_id) REFERENCES JRGY_USUARIO(COD_USUARIO) ON DELETE CASCADE
      )
    `);
  });
}

module.exports = {
  initPool,
  getConnection,
  closePool,
  withConnection
};
