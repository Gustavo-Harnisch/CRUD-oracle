-- Script seguro para recrear todas las tablas, secuencias y objetos.
-- Ordenado para evitar ORA-00942 y ORA-00955.

-- NOTA (RUT como PK): si deseas migrar usuarios para que usen RUT (8 dígitos sin DV) como clave primaria
-- y login, integra aquí el bloque de migración antes de crear objetos. Ajusta los WHERE a tus usuarios seed
-- (admin=11111111, empleado=22222222, cliente=33333333) que hoy están en:
--   admin:    gustavo.admin@example.com    / Gustavo_make_ALL2004.
--   empleado: gustavo.empleado@example.com / gustavo_empleado
--   cliente:  gustavo.cliente@example.com  / gustavo_cliente
-- Bloque sugerido (destructivo, ejecutar en entorno de prueba y con backup):
--   ALTER TABLE JRGY_USUARIO ADD (RUT NUMBER(8));
--   UPDATE JRGY_USUARIO SET RUT = 11111111 WHERE EMAIL_USUARIO = 'gustavo.admin@example.com';
--   UPDATE JRGY_USUARIO SET RUT = 22222222 WHERE EMAIL_USUARIO = 'gustavo.empleado@example.com';
--   UPDATE JRGY_USUARIO SET RUT = 33333333 WHERE EMAIL_USUARIO = 'gustavo.cliente@example.com';
--   ALTER TABLE JRGY_USUARIO MODIFY (RUT NOT NULL);
--   ALTER TABLE JRGY_USUARIO ADD CONSTRAINT UQ_JRGY_USUARIO_RUT UNIQUE (RUT);
--   -- Dropear PK/seq/trigger de COD_USUARIO y FKs (TOKENS, USUARIO_ROL, CLIENTE, EMPLEADO, SOLICITUD_ADMIN, RESERVA, etc.).
--   -- Crear columnas RUT en tablas dependientes, copiar datos desde COD_USUARIO, eliminar COD_USUARIO y recrear FKs/PKs sobre RUT.
--   -- Ajustar procs de auth/usuarios/reservas/empleados/roles para usar RUT en vez de COD_USUARIO.
--   -- Actualizar login para aceptar RUT en lugar de correo.

PROMPT Limpieza de objetos (triggers, paquetes, tipos, tablas, secuencias)...
DECLARE
    PROCEDURE safe_drop(p_sql VARCHAR2) IS
    BEGIN
        EXECUTE IMMEDIATE p_sql;
    EXCEPTION
        WHEN OTHERS THEN
            IF SQLCODE NOT IN (-4043, -4044, -4045, -4080, -2289, -942, -21700, -21701, -2303, -2304) THEN
                RAISE;
            END IF;
    END;
BEGIN
    -- Triggers de negocio / PK
    safe_drop('DROP TRIGGER TRG_VALIDA_STOCK_VENTA');
    safe_drop('DROP TRIGGER TRG_HAB_OCUPADA_ON_DETALLE');
    safe_drop('DROP TRIGGER TRG_HAB_LIBRE_ON_DETALLE_DEL');
    safe_drop('DROP TRIGGER TRG_PK_USUARIO');
    safe_drop('DROP TRIGGER TRG_MISMA_PK_USUARIO');
    safe_drop('DROP TRIGGER TRG_PK_EMPLEADO');
    safe_drop('DROP TRIGGER TRG_MISMA_PK_EMPLEADO');
    safe_drop('DROP TRIGGER TRG_PK_CLIENTE');
    safe_drop('DROP TRIGGER TRG_PK_HABITACION');
    safe_drop('DROP TRIGGER TRG_PK_PRODUCTO');
    safe_drop('DROP TRIGGER TRG_MISMA_PK_PRODUCTO');
    safe_drop('DROP TRIGGER TRG_PK_ROL');
    safe_drop('DROP TRIGGER TRG_PK_PEDIDO');
    safe_drop('DROP TRIGGER TRG_PK_MOVIMIENTO_STOCK');
    safe_drop('DROP TRIGGER TRG_PK_PAGO_VENTA');
    safe_drop('DROP TRIGGER TRG_PK_VENTA');
    safe_drop('DROP TRIGGER TRG_PK_PAGO_HAB');
    safe_drop('DROP TRIGGER TRG_PK_SOLICITUD_ADMIN');
    safe_drop('DROP TRIGGER TRG_PK_RESERVA');
    safe_drop('DROP TRIGGER TRG_PK_EVENTO_RESERVA');
    safe_drop('DROP TRIGGER TRG_PK_EXPERIENCIA');
    safe_drop('DROP TRIGGER TRG_PK_RESERVA_EXP');
    safe_drop('DROP TRIGGER TRG_PK_SERVICIO');
    safe_drop('DROP TRIGGER TRG_PK_SERVICIO_HORARIO');
    safe_drop('DROP TRIGGER TRG_PK_RESERVA_SERVICIO');
    safe_drop('DROP TRIGGER TRG_SERVICIO_UPDATED_AT');
    safe_drop('DROP TRIGGER TRG_RESERVA_SERVICIO_TOTAL');
    safe_drop('DROP TRIGGER TRG_RESERVA_NO_OVERLAP');
    safe_drop('DROP TRIGGER TRG_PK_CAT_TIPO_HAB');
    safe_drop('DROP TRIGGER TRG_CAT_TIPO_HAB_MAYUS');

    -- Paquetes
    safe_drop('DROP PACKAGE BODY PKG_REPORTES');
    safe_drop('DROP PACKAGE PKG_REPORTES');
    safe_drop('DROP PACKAGE BODY PKG_PEDIDO');
    safe_drop('DROP PACKAGE PKG_PEDIDO');

    -- Procedimientos y funciones
    safe_drop('DROP PROCEDURE JRGY_PRO_RECALC_STOCK');
    safe_drop('DROP PROCEDURE JRGY_PRO_PAGO_HABITACION');
    safe_drop('DROP PROCEDURE JRGY_PRO_REGISTRAR_PEDIDO');
    safe_drop('DROP PROCEDURE JRGY_PRO_REGISTRAR_VENTA');
    safe_drop('DROP PROCEDURE JRGY_PRO_ASIGNAR_ROL');
    safe_drop('DROP PROCEDURE JRGY_PRO_CAT_SERVPROD_LISTAR');
    safe_drop('DROP PROCEDURE JRGY_PRO_DELETE_PEDIDO');
    safe_drop('DROP PROCEDURE JRGY_PRO_UPDATE_PEDIDO_TOTAL');
    safe_drop('DROP PROCEDURE JRGY_PRO_INSERT_PEDIDO');
    safe_drop('DROP PROCEDURE JRGY_PRO_LOGIN');
    safe_drop('DROP PROCEDURE CRUD_DETALLE_VENTA');
    safe_drop('DROP PROCEDURE CRUD_VENTA');
    safe_drop('DROP PROCEDURE CRUD_DETALLE_PEDIDO');
    safe_drop('DROP PROCEDURE CRUD_PEDIDO');
    safe_drop('DROP PROCEDURE CRUD_DETALLE_PAGO_HABITACION');
    safe_drop('DROP PROCEDURE CRUD_PAGO_HABITACION');
    safe_drop('DROP PROCEDURE CRUD_HABITACION');
    safe_drop('DROP PROCEDURE CRUD_PROVEEDOR');
    safe_drop('DROP PROCEDURE CRUD_CALLE');
    safe_drop('DROP PROCEDURE CRUD_COMUNA');
    safe_drop('DROP PROCEDURE CRUD_CIUDAD');
    safe_drop('DROP PROCEDURE CRUD_REGION');
    safe_drop('DROP PROCEDURE CRUD_USUARIO_ROL');
    safe_drop('DROP PROCEDURE CRUD_ROL');
    safe_drop('DROP PROCEDURE CRUD_EMPLEADO');
    safe_drop('DROP PROCEDURE CRUD_PRODUCTO');
    safe_drop('DROP PROCEDURE CRUD_USUARIO');
    safe_drop('DROP PROCEDURE CRUD_PAGO_VENTA');
    safe_drop('DROP PROCEDURE CRUD_MOVIMIENTO_STOCK');
    safe_drop('DROP PROCEDURE JRGY_PRO_TIPO_HAB_LISTAR');
    safe_drop('DROP PROCEDURE JRGY_PRO_TIPO_HAB_CREAR');

    safe_drop('DROP FUNCTION FN_CALC_IVA');
    safe_drop('DROP FUNCTION FN_CALC_COMISION');
    safe_drop('DROP FUNCTION FN_STOCK_DISP');

    -- Tipos
    safe_drop('DROP TYPE DETALLE_PEDIDO_TAB');
    safe_drop('DROP TYPE DETALLE_PEDIDO_REC');
    safe_drop('DROP TYPE DETALLE_VENTA_TAB');
    safe_drop('DROP TYPE DETALLE_VENTA_REC');
    safe_drop('DROP TYPE DETALLE_ESTADIA_TAB');
    safe_drop('DROP TYPE DETALLE_ESTADIA_REC');

    -- Tablas (en orden descendente de dependencia)
    safe_drop('DROP TABLE JRGY_DETALLE_PAGO_HABITACION CASCADE CONSTRAINTS');
    safe_drop('DROP TABLE JRGY_DETALLE_PEDIDO CASCADE CONSTRAINTS');
    safe_drop('DROP TABLE JRGY_DETALLE_VENTA CASCADE CONSTRAINTS');
    safe_drop('DROP TABLE JRGY_MOVIMIENTO_STOCK CASCADE CONSTRAINTS');
    safe_drop('DROP TABLE JRGY_PAGO_VENTA CASCADE CONSTRAINTS');
    safe_drop('DROP TABLE JRGY_PAGO_HABITACION CASCADE CONSTRAINTS');
    safe_drop('DROP TABLE JRGY_PEDIDO CASCADE CONSTRAINTS');
    safe_drop('DROP TABLE JRGY_VENTA CASCADE CONSTRAINTS');
    safe_drop('DROP TABLE JRGY_HABITACION CASCADE CONSTRAINTS');
    safe_drop('DROP TABLE JRGY_USUARIO_ROL CASCADE CONSTRAINTS');
    safe_drop('DROP TABLE JRGY_SOLICITUD_ADMIN CASCADE CONSTRAINTS');
    safe_drop('DROP TABLE JRGY_EMPLEADO CASCADE CONSTRAINTS');
    safe_drop('DROP TABLE JRGY_CLIENTE CASCADE CONSTRAINTS');
    safe_drop('DROP TABLE JRGY_PRODUCTO CASCADE CONSTRAINTS');
    safe_drop('DROP TABLE JRGY_EXPERIENCIA CASCADE CONSTRAINTS');
    safe_drop('DROP TABLE JRGY_PROVEEDOR CASCADE CONSTRAINTS');
    safe_drop('DROP TABLE JRGY_CALLE CASCADE CONSTRAINTS');
    safe_drop('DROP TABLE JRGY_COMUNA CASCADE CONSTRAINTS');
    safe_drop('DROP TABLE JRGY_CIUDAD CASCADE CONSTRAINTS');
    safe_drop('DROP TABLE JRGY_REGION CASCADE CONSTRAINTS');
    safe_drop('DROP TABLE JRGY_DEPARTAMENTO CASCADE CONSTRAINTS');
    safe_drop('DROP TABLE JRGY_USUARIO CASCADE CONSTRAINTS');
    safe_drop('DROP TABLE JRGY_ROL CASCADE CONSTRAINTS');
    safe_drop('DROP TABLE JRGY_CAT_ESTADO_USUARIO CASCADE CONSTRAINTS');
    safe_drop('DROP TABLE JRGY_CAT_ESTADO_LABORAL CASCADE CONSTRAINTS');
    safe_drop('DROP TABLE JRGY_CAT_ESTADO_HABITACION CASCADE CONSTRAINTS');
    safe_drop('DROP TABLE JRGY_CAT_TIPO_HABITACION CASCADE CONSTRAINTS');
    safe_drop('DROP TABLE JRGY_CAT_MODO_PAGO CASCADE CONSTRAINTS');
    safe_drop('DROP TABLE JRGY_CAT_ESTADO_RESERVA CASCADE CONSTRAINTS');
    safe_drop('DROP TABLE JRGY_RESERVA_EXP CASCADE CONSTRAINTS');
    safe_drop('DROP TABLE JRGY_RESERVA CASCADE CONSTRAINTS');
    safe_drop('DROP TABLE JRGY_EVENTO_RESERVA CASCADE CONSTRAINTS');
    safe_drop('DROP TABLE JRGY_RESERVA_SERVICIO CASCADE CONSTRAINTS');
    safe_drop('DROP TABLE TOKENS CASCADE CONSTRAINTS');
    safe_drop('DROP TABLE JRGY_SERVICIO_HORARIO CASCADE CONSTRAINTS');
    safe_drop('DROP TABLE JRGY_SERVICIO CASCADE CONSTRAINTS');

    -- Secuencias
    safe_drop('DROP SEQUENCE SQ_PK_USUARIO');
    safe_drop('DROP SEQUENCE SQ_PK_EMPLEADO');
    safe_drop('DROP SEQUENCE SQ_PK_CLIENTE');
    safe_drop('DROP SEQUENCE SQ_PK_HABITACION');
    safe_drop('DROP SEQUENCE SQ_PK_PRODUCTO');
    safe_drop('DROP SEQUENCE SQ_PK_PEDIDO');
    safe_drop('DROP SEQUENCE SQ_PK_ROL');
    safe_drop('DROP SEQUENCE SQ_PK_MOVIMIENTO_STOCK');
    safe_drop('DROP SEQUENCE SQ_PK_PAGO_VENTA');
    safe_drop('DROP SEQUENCE SQ_PK_VENTA');
    safe_drop('DROP SEQUENCE SQ_PK_CAT_TIPO_HAB');
    safe_drop('DROP SEQUENCE SQ_PK_PAGO_HAB');
    safe_drop('DROP SEQUENCE SQ_PK_SOLICITUD_ADMIN');
    safe_drop('DROP SEQUENCE SQ_PK_RESERVA');
    safe_drop('DROP SEQUENCE SQ_PK_EVENTO_RESERVA');
    safe_drop('DROP SEQUENCE SQ_PK_EXPERIENCIA');
    safe_drop('DROP SEQUENCE SQ_PK_RESERVA_EXP');
    safe_drop('DROP SEQUENCE SQ_PK_SERVICIO');
    safe_drop('DROP SEQUENCE SQ_PK_SERVICIO_HORARIO');
    safe_drop('DROP SEQUENCE SQ_PK_RESERVA_SERVICIO');
END;
/

-- ========================================
-- Procedimientos: Productos
-- ========================================
CREATE OR REPLACE PROCEDURE JRGY_PRO_PRODUCTO_LISTAR(
    CUR OUT SYS_REFCURSOR
)
IS
BEGIN
    OPEN CUR FOR
        SELECT
            COD_PRODUCTO,
            NOMBRE_PRODUCTO,
            TIPO_PRODUCTO,
            PRECIO_PRODUCTO,
            CANTIDAD_PRODUCTO,
            STOCK_PRODUCTO,
            UMBRAL_ALERTA,
            CASE WHEN UMBRAL_ALERTA IS NOT NULL AND NVL(STOCK_PRODUCTO,0) <= UMBRAL_ALERTA THEN 1 ELSE 0 END AS ALERTA_ACTIVA
        FROM JRGY_PRODUCTO
        ORDER BY NOMBRE_PRODUCTO;
END;
/

CREATE OR REPLACE PROCEDURE JRGY_PRO_PRODUCTO_CREAR(
    P_NOMBRE IN VARCHAR2,
    P_TIPO IN VARCHAR2,
    P_PRECIO IN NUMBER,
    P_CANTIDAD IN NUMBER,
    P_STOCK IN NUMBER,
    P_UMBRAL IN NUMBER,
    P_ID OUT NUMBER
)
IS
BEGIN
    INSERT INTO JRGY_PRODUCTO (NOMBRE_PRODUCTO, TIPO_PRODUCTO, PRECIO_PRODUCTO, CANTIDAD_PRODUCTO, STOCK_PRODUCTO, UMBRAL_ALERTA)
    VALUES (P_NOMBRE, P_TIPO, P_PRECIO, P_CANTIDAD, P_STOCK, P_UMBRAL)
    RETURNING COD_PRODUCTO INTO P_ID;
    COMMIT;
END;
/

CREATE OR REPLACE PROCEDURE JRGY_PRO_PRODUCTO_ACTUALIZAR(
    P_ID IN NUMBER,
    P_NOMBRE IN VARCHAR2,
    P_TIPO IN VARCHAR2,
    P_PRECIO IN NUMBER,
    P_CANTIDAD IN NUMBER,
    P_STOCK IN NUMBER,
    P_UMBRAL IN NUMBER
)
IS
BEGIN
    UPDATE JRGY_PRODUCTO
    SET NOMBRE_PRODUCTO = P_NOMBRE,
        TIPO_PRODUCTO = P_TIPO,
        PRECIO_PRODUCTO = P_PRECIO,
        CANTIDAD_PRODUCTO = P_CANTIDAD,
        STOCK_PRODUCTO = P_STOCK,
        UMBRAL_ALERTA = P_UMBRAL
    WHERE COD_PRODUCTO = P_ID;

    IF SQL%ROWCOUNT = 0 THEN
        RAISE_APPLICATION_ERROR(-20082, 'PRODUCTO NO ENCONTRADO');
    END IF;
    COMMIT;
END;
/

CREATE OR REPLACE PROCEDURE JRGY_PRO_PRODUCTO_BORRAR(
    P_ID IN NUMBER
)
IS
    V_COUNT NUMBER;
BEGIN
    SELECT COUNT(*) INTO V_COUNT FROM JRGY_DETALLE_PEDIDO WHERE COD_PRODUCTO = P_ID;
    IF V_COUNT > 0 THEN
        RAISE_APPLICATION_ERROR(-20104, 'NO SE PUEDE ELIMINAR: TIENE PEDIDOS');
    END IF;
    SELECT COUNT(*) INTO V_COUNT FROM JRGY_DETALLE_VENTA WHERE COD_PRODUCTO = P_ID;
    IF V_COUNT > 0 THEN
        RAISE_APPLICATION_ERROR(-20104, 'NO SE PUEDE ELIMINAR: TIENE VENTAS');
    END IF;

    DELETE FROM JRGY_SERVICIO_PRODUCTO WHERE COD_PRODUCTO = P_ID;
    DELETE FROM JRGY_PRODUCTO WHERE COD_PRODUCTO = P_ID;
    IF SQL%ROWCOUNT = 0 THEN
        RAISE_APPLICATION_ERROR(-20082, 'PRODUCTO NO ENCONTRADO');
    END IF;
    COMMIT;
END;
/

-- ========================================
-- Procedimientos: Servicio-Producto
-- ========================================
CREATE OR REPLACE PROCEDURE JRGY_PRO_SERVICIO_PRODUCTO_LISTAR(
    P_SERVICIO_ID IN NUMBER,
    CUR OUT SYS_REFCURSOR
)
IS
BEGIN
    OPEN CUR FOR
        SELECT
            sp.COD_SERVICIO,
            sp.COD_PRODUCTO,
            p.NOMBRE_PRODUCTO,
            sp.CANTIDAD_BASE,
            sp.PRECIO_EXTRA,
            p.STOCK_PRODUCTO,
            p.UMBRAL_ALERTA,
            CASE WHEN p.UMBRAL_ALERTA IS NOT NULL AND NVL(p.STOCK_PRODUCTO,0) <= p.UMBRAL_ALERTA THEN 1 ELSE 0 END AS ALERTA_ACTIVA
        FROM JRGY_SERVICIO_PRODUCTO sp
        JOIN JRGY_PRODUCTO p ON p.COD_PRODUCTO = sp.COD_PRODUCTO
        WHERE sp.COD_SERVICIO = P_SERVICIO_ID
        ORDER BY p.NOMBRE_PRODUCTO;
END;
/

CREATE OR REPLACE PROCEDURE JRGY_PRO_SERVICIO_PRODUCTO_REEMPLAZAR(
    P_SERVICIO_ID IN NUMBER,
    P_ITEMS_JSON IN CLOB
)
IS
    V_COUNT NUMBER;
BEGIN
    SELECT COUNT(*) INTO V_COUNT FROM JRGY_SERVICIO WHERE COD_SERVICIO = P_SERVICIO_ID;
    IF V_COUNT = 0 THEN
        RAISE_APPLICATION_ERROR(-20082, 'SERVICIO NO ENCONTRADO');
    END IF;

    DELETE FROM JRGY_SERVICIO_PRODUCTO WHERE COD_SERVICIO = P_SERVICIO_ID;

    FOR rec IN (
        SELECT
            jt.productoId AS COD_PRODUCTO,
            jt.cantidad AS CANTIDAD_BASE,
            jt.precioExtra AS PRECIO_EXTRA
        FROM JSON_TABLE(P_ITEMS_JSON, '$[*]'
            COLUMNS (
                productoId NUMBER PATH '$.productoId',
                cantidad NUMBER PATH '$.cantidad',
                precioExtra NUMBER PATH '$.precioExtra'
            )
        ) jt
    ) LOOP
        INSERT INTO JRGY_SERVICIO_PRODUCTO (COD_SERVICIO, COD_PRODUCTO, CANTIDAD_BASE, PRECIO_EXTRA)
        VALUES (P_SERVICIO_ID, rec.COD_PRODUCTO, NVL(rec.CANTIDAD_BASE,1), rec.PRECIO_EXTRA);
    END LOOP;

    COMMIT;
END;
/

-- ========================================
-- Procedimientos: Proveedores
-- ========================================
CREATE OR REPLACE PROCEDURE JRGY_PRO_PROVEEDOR_LISTAR(
    CUR OUT SYS_REFCURSOR
)
IS
BEGIN
    OPEN CUR FOR
        SELECT COD_PROVEEDOR, NOMBRE_PROVEEDOR, DIRECCION_PROVEEDOR, TELEFONO_PROVEEDOR, COD_REGION
        FROM JRGY_PROVEEDOR
        ORDER BY NOMBRE_PROVEEDOR;
END;
/

CREATE OR REPLACE PROCEDURE JRGY_PRO_PROVEEDOR_CREAR(
    P_NOMBRE IN VARCHAR2,
    P_DIRECCION IN VARCHAR2,
    P_TELEFONO IN NUMBER,
    P_REGION IN NUMBER,
    P_ID OUT NUMBER
)
IS
BEGIN
    INSERT INTO JRGY_PROVEEDOR (NOMBRE_PROVEEDOR, DIRECCION_PROVEEDOR, TELEFONO_PROVEEDOR, COD_REGION)
    VALUES (P_NOMBRE, P_DIRECCION, P_TELEFONO, P_REGION)
    RETURNING COD_PROVEEDOR INTO P_ID;
    COMMIT;
END;
/

CREATE OR REPLACE PROCEDURE JRGY_PRO_PROVEEDOR_ACTUALIZAR(
    P_ID IN NUMBER,
    P_NOMBRE IN VARCHAR2,
    P_DIRECCION IN VARCHAR2,
    P_TELEFONO IN NUMBER,
    P_REGION IN NUMBER
)
IS
BEGIN
    UPDATE JRGY_PROVEEDOR
    SET NOMBRE_PROVEEDOR = P_NOMBRE,
        DIRECCION_PROVEEDOR = P_DIRECCION,
        TELEFONO_PROVEEDOR = P_TELEFONO,
        COD_REGION = P_REGION
    WHERE COD_PROVEEDOR = P_ID;

    IF SQL%ROWCOUNT = 0 THEN
        RAISE_APPLICATION_ERROR(-20026, 'PROVEEDOR NO ENCONTRADO');
    END IF;
    COMMIT;
END;
/

CREATE OR REPLACE PROCEDURE JRGY_PRO_PROVEEDOR_BORRAR(
    P_ID IN NUMBER
)
IS
    V_COUNT NUMBER;
BEGIN
    SELECT COUNT(*) INTO V_COUNT FROM JRGY_DETALLE_PEDIDO WHERE COD_PROVEEDOR = P_ID;
    IF V_COUNT > 0 THEN
        RAISE_APPLICATION_ERROR(-20104, 'NO SE PUEDE ELIMINAR: TIENE PEDIDOS');
    END IF;

    DELETE FROM JRGY_PROVEEDOR WHERE COD_PROVEEDOR = P_ID;
    IF SQL%ROWCOUNT = 0 THEN
        RAISE_APPLICATION_ERROR(-20026, 'PROVEEDOR NO ENCONTRADO');
    END IF;
    COMMIT;
END;
/

-- ========================================
-- Procedimientos: Pedidos de compra
-- ========================================
CREATE OR REPLACE PROCEDURE JRGY_PRO_PEDIDO_CREAR(
    P_EMPLEADO_ID IN NUMBER,
    P_DETALLE_JSON IN CLOB,
    P_PEDIDO_ID OUT NUMBER
)
IS
    V_TOTAL NUMBER := 0;
BEGIN
    INSERT INTO JRGY_PEDIDO (COD_PEDIDO, VALOR_TOTAL, FECHA_PEDIDO, COD_EMPLEADO)
    VALUES (SQ_PK_PEDIDO.NEXTVAL, 0, SYSDATE, P_EMPLEADO_ID)
    RETURNING COD_PEDIDO INTO P_PEDIDO_ID;

    FOR rec IN (
        SELECT
            jt.proveedorId AS COD_PROVEEDOR,
            jt.productoId AS COD_PRODUCTO,
            jt.nombreProducto AS NOMBRE_PRODUCTO,
            jt.cantidad AS CANTIDAD,
            jt.precioCompra AS PRECIO_COMPRA
        FROM JSON_TABLE(P_DETALLE_JSON, '$[*]'
            COLUMNS (
                proveedorId NUMBER PATH '$.proveedorId',
                productoId NUMBER PATH '$.productoId',
                nombreProducto VARCHAR2(50) PATH '$.nombreProducto',
                cantidad NUMBER PATH '$.cantidad',
                precioCompra NUMBER PATH '$.precioCompra'
            )
        ) jt
    ) LOOP
        INSERT INTO JRGY_DETALLE_PEDIDO (COD_PEDIDO, COD_PROVEEDOR, COD_PRODUCTO, NOMBRE_PRODUCTO, CANTIDAD_PRODUCTO, PRECIO_COMPRA, PRECIO_TOTAL)
        VALUES (P_PEDIDO_ID, rec.COD_PROVEEDOR, rec.COD_PRODUCTO, rec.NOMBRE_PRODUCTO, rec.CANTIDAD, rec.PRECIO_COMPRA, rec.CANTIDAD * rec.PRECIO_COMPRA);

        UPDATE JRGY_PRODUCTO
        SET STOCK_PRODUCTO = NVL(STOCK_PRODUCTO,0) + rec.CANTIDAD
        WHERE COD_PRODUCTO = rec.COD_PRODUCTO;

        INSERT INTO JRGY_MOVIMIENTO_STOCK (COD_MOVIMIENTO, COD_PRODUCTO, TIPO_MOVIMIENTO, CANTIDAD, FECHA_MOVIMIENTO, MOTIVO)
        VALUES (SQ_PK_MOVIMIENTO_STOCK.NEXTVAL, rec.COD_PRODUCTO, 'ENTRADA', rec.CANTIDAD, SYSDATE, 'PEDIDO ' || P_PEDIDO_ID);

        V_TOTAL := V_TOTAL + (rec.CANTIDAD * rec.PRECIO_COMPRA);
    END LOOP;

    UPDATE JRGY_PEDIDO SET VALOR_TOTAL = V_TOTAL WHERE COD_PEDIDO = P_PEDIDO_ID;
    COMMIT;
END;
/

CREATE OR REPLACE PROCEDURE JRGY_PRO_PEDIDO_LISTAR(
    CUR OUT SYS_REFCURSOR
)
IS
BEGIN
    OPEN CUR FOR
        SELECT COD_PEDIDO, VALOR_TOTAL, FECHA_PEDIDO, COD_EMPLEADO
        FROM JRGY_PEDIDO
        ORDER BY FECHA_PEDIDO DESC;
END;
/

CREATE OR REPLACE PROCEDURE JRGY_PRO_PEDIDO_OBTENER(
    P_ID IN NUMBER,
    CUR_PED OUT SYS_REFCURSOR,
    CUR_DET OUT SYS_REFCURSOR
)
IS
BEGIN
    OPEN CUR_PED FOR
        SELECT COD_PEDIDO, VALOR_TOTAL, FECHA_PEDIDO, COD_EMPLEADO
        FROM JRGY_PEDIDO
        WHERE COD_PEDIDO = P_ID;

    OPEN CUR_DET FOR
        SELECT COD_PEDIDO, COD_PROVEEDOR, COD_PRODUCTO, NOMBRE_PRODUCTO, CANTIDAD_PRODUCTO, PRECIO_COMPRA, PRECIO_TOTAL
        FROM JRGY_DETALLE_PEDIDO
        WHERE COD_PEDIDO = P_ID;
END;
/

-- ========================================
-- Procedimientos: Departamentos
-- ========================================
-- Función utilitaria: total de sueldos de un departamento
CREATE OR REPLACE FUNCTION JRGY_FUN_DEP_SUELDO_TOTAL(
    P_DEP_ID IN NUMBER
) RETURN NUMBER
IS
    V_TOTAL NUMBER;
BEGIN
    SELECT NVL(SUM(NVL(SUELDO_BASE, SALARIO)), 0)
    INTO V_TOTAL
    FROM JRGY_EMPLEADO
    WHERE COD_DEPARTAMENTO = P_DEP_ID;

    RETURN V_TOTAL;
EXCEPTION
    WHEN NO_DATA_FOUND THEN
        RETURN 0;
END;
/

CREATE OR REPLACE PROCEDURE JRGY_PRO_DEP_LISTAR(
    CUR OUT SYS_REFCURSOR
)
IS
BEGIN
    OPEN CUR FOR
        SELECT d.COD_DEPARTAMENTO,
               d.NOMBRE,
               d.JEFE_EMPLEADO_ID,
               u.COD_USUARIO AS JEFE_RUT,
               d.PRESUPUESTO,
               JRGY_FUN_DEP_SUELDO_TOTAL(d.COD_DEPARTAMENTO) AS SUELDO_TOTAL,
               NVL(COUNT(de.COD_EMPLEADO),0) AS EMPLEADOS_ASIGNADOS
        FROM JRGY_DEPARTAMENTO d
        LEFT JOIN JRGY_EMPLEADO e ON e.COD_EMPLEADO = d.JEFE_EMPLEADO_ID
        LEFT JOIN JRGY_USUARIO u ON u.COD_USUARIO = e.COD_USUARIO
        LEFT JOIN JRGY_DEPARTAMENTO_EMPLEADO de ON de.COD_DEPARTAMENTO = d.COD_DEPARTAMENTO
        GROUP BY d.COD_DEPARTAMENTO, d.NOMBRE, d.JEFE_EMPLEADO_ID, u.COD_USUARIO, d.PRESUPUESTO;
END;
/

-- ========================================
-- Procedimientos: Empleados (listado)
-- ========================================
CREATE OR REPLACE PROCEDURE JRGY_PRO_EMPLEADO_LISTAR(
    CUR OUT SYS_REFCURSOR
)
IS
BEGIN
    OPEN CUR FOR
        WITH EMP AS (
            SELECT e.COD_EMPLEADO,
                   e.COD_USUARIO,
                   u.NOMBRE || ' ' || NVL(u.APELLIDO1, '') || ' ' || NVL(u.APELLIDO2, '') AS NOMBRE_COMPLETO,
                   u.EMAIL,
                   e.COD_DEPARTAMENTO,
                   NVL(d.NOMBRE, 'NONE') AS DEPARTAMENTO,
                   e.CARGO,
                   e.SUELDO_BASE,
                   e.FECHA_CONTRATACION,
                   e.COD_ESTADO_LABORAL,
                   el.ESTADO_LABORAL,
                   CASE
                       WHEN e.CARGO IS NULL OR e.SUELDO_BASE IS NULL OR e.COD_DEPARTAMENTO IS NULL OR e.COD_ESTADO_LABORAL IS NULL THEN 1
                       ELSE 0
                   END AS INCOMPLETO
            FROM JRGY_EMPLEADO e
            LEFT JOIN JRGY_USUARIO u ON u.COD_USUARIO = e.COD_USUARIO
            LEFT JOIN JRGY_DEPARTAMENTO d ON d.COD_DEPARTAMENTO = e.COD_DEPARTAMENTO
            LEFT JOIN JRGY_CAT_ESTADO_LABORAL el ON el.COD_ESTADO_LABORAL = e.COD_ESTADO_LABORAL
        ), EMP_ROLE AS (
            SELECT
                NULL AS COD_EMPLEADO,
                u.COD_USUARIO,
                u.NOMBRE || ' ' || NVL(u.APELLIDO1, '') || ' ' || NVL(u.APELLIDO2, '') AS NOMBRE_COMPLETO,
                u.EMAIL,
                NULL AS COD_DEPARTAMENTO,
                'NONE' AS DEPARTAMENTO,
                NULL AS CARGO,
                NULL AS SUELDO_BASE,
                NULL AS FECHA_CONTRATACION,
                NULL AS COD_ESTADO_LABORAL,
                NULL AS ESTADO_LABORAL,
                1 AS INCOMPLETO
            FROM JRGY_USUARIO u
            INNER JOIN JRGY_USUARIO_ROL ur ON ur.COD_USUARIO = u.COD_USUARIO
            INNER JOIN JRGY_ROL r ON r.COD_ROL = ur.COD_ROL
            LEFT JOIN JRGY_EMPLEADO e ON e.COD_USUARIO = u.COD_USUARIO
            WHERE UPPER(r.NOMBRE_ROL) = 'EMPLOYEE'
              AND e.COD_EMPLEADO IS NULL
        )
        SELECT *
        FROM (
            SELECT * FROM EMP
            UNION ALL
            SELECT * FROM EMP_ROLE
        )
        ORDER BY COD_EMPLEADO NULLS LAST, COD_USUARIO;
END;
/

CREATE OR REPLACE PROCEDURE JRGY_PRO_EMPLEADO_CREAR(
    P_USUARIO_ID IN NUMBER,
    P_CARGO IN VARCHAR2,
    P_SUELDO_BASE IN NUMBER,
    P_FECHA_CONTRATO IN DATE,
    P_DEP_ID IN NUMBER,
    P_ESTADO_NOMBRE IN VARCHAR2,
    P_ID OUT NUMBER
)
IS
    V_ESTADO_ID NUMBER;
BEGIN
    SELECT COD_ESTADO_LABORAL INTO V_ESTADO_ID FROM JRGY_CAT_ESTADO_LABORAL WHERE UPPER(ESTADO_LABORAL) = UPPER(P_ESTADO_NOMBRE);

    INSERT INTO JRGY_EMPLEADO (COD_EMPLEADO, COD_USUARIO, COD_DEPARTAMENTO, CARGO, SUELDO_BASE, FECHA_CONTRATACION, COD_ESTADO_LABORAL)
    VALUES (SQ_PK_EMPLEADO.NEXTVAL, P_USUARIO_ID, P_DEP_ID, P_CARGO, P_SUELDO_BASE, P_FECHA_CONTRATO, V_ESTADO_ID)
    RETURNING COD_EMPLEADO INTO P_ID;
    COMMIT;
EXCEPTION
    WHEN NO_DATA_FOUND THEN
        RAISE_APPLICATION_ERROR(-20052, 'ESTADO LABORAL NO ENCONTRADO');
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE;
END;
/

CREATE OR REPLACE PROCEDURE JRGY_PRO_EMPLEADO_ACTUALIZAR(
    P_ID IN NUMBER,
    P_CARGO IN VARCHAR2,
    P_SUELDO_BASE IN NUMBER,
    P_FECHA_CONTRATO IN DATE,
    P_DEP_ID IN NUMBER,
    P_ESTADO_NOMBRE IN VARCHAR2
)
IS
    V_ESTADO_ID NUMBER;
BEGIN
    SELECT COD_ESTADO_LABORAL INTO V_ESTADO_ID FROM JRGY_CAT_ESTADO_LABORAL WHERE UPPER(ESTADO_LABORAL) = UPPER(P_ESTADO_NOMBRE);

    UPDATE JRGY_EMPLEADO
    SET CARGO = P_CARGO,
        SUELDO_BASE = P_SUELDO_BASE,
        FECHA_CONTRATACION = P_FECHA_CONTRATO,
        COD_DEPARTAMENTO = P_DEP_ID,
        COD_ESTADO_LABORAL = V_ESTADO_ID
    WHERE COD_EMPLEADO = P_ID;

    IF SQL%ROWCOUNT = 0 THEN
        RAISE_APPLICATION_ERROR(-20103, 'EMPLEADO NO ENCONTRADO');
    END IF;
    COMMIT;
EXCEPTION
    WHEN NO_DATA_FOUND THEN
        RAISE_APPLICATION_ERROR(-20052, 'ESTADO LABORAL NO ENCONTRADO');
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE;
END;
/

CREATE OR REPLACE PROCEDURE JRGY_PRO_EMPLEADO_BORRAR(
    P_ID IN NUMBER
)
IS
BEGIN
    DELETE FROM JRGY_EMPLEADO WHERE COD_EMPLEADO = P_ID;
    IF SQL%ROWCOUNT = 0 THEN
        RAISE_APPLICATION_ERROR(-20103, 'EMPLEADO NO ENCONTRADO');
    END IF;
    COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE;
END;
/

CREATE OR REPLACE PROCEDURE JRGY_PRO_DEP_OBTENER(
    P_ID IN NUMBER,
    CUR OUT SYS_REFCURSOR
)
IS
BEGIN
    OPEN CUR FOR
        SELECT COD_DEPARTAMENTO, NOMBRE, JEFE_EMPLEADO_ID, PRESUPUESTO, FECHA_CREACION
        FROM JRGY_DEPARTAMENTO
        WHERE COD_DEPARTAMENTO = P_ID;
END;
/

CREATE OR REPLACE PROCEDURE JRGY_PRO_DEP_CREAR(
    P_NOMBRE IN VARCHAR2,
    P_JEFE_ID IN NUMBER,
    P_PRESUPUESTO IN NUMBER,
    P_ID OUT NUMBER
)
IS
BEGIN
    INSERT INTO JRGY_DEPARTAMENTO (NOMBRE, JEFE_EMPLEADO_ID, PRESUPUESTO)
    VALUES (P_NOMBRE, P_JEFE_ID, P_PRESUPUESTO)
    RETURNING COD_DEPARTAMENTO INTO P_ID;
    COMMIT;
END;
/

CREATE OR REPLACE PROCEDURE JRGY_PRO_DEP_ACTUALIZAR(
    P_ID IN NUMBER,
    P_NOMBRE IN VARCHAR2,
    P_JEFE_ID IN NUMBER,
    P_PRESUPUESTO IN NUMBER
)
IS
BEGIN
    UPDATE JRGY_DEPARTAMENTO
    SET NOMBRE = P_NOMBRE,
        JEFE_EMPLEADO_ID = P_JEFE_ID,
        PRESUPUESTO = P_PRESUPUESTO
    WHERE COD_DEPARTAMENTO = P_ID;
    IF SQL%ROWCOUNT = 0 THEN
        RAISE_APPLICATION_ERROR(-20103, 'DEPARTAMENTO NO ENCONTRADO');
    END IF;
    COMMIT;
END;
/

CREATE OR REPLACE PROCEDURE JRGY_PRO_DEP_BORRAR(
    P_ID IN NUMBER
)
IS
BEGIN
    DELETE FROM JRGY_DEPARTAMENTO_EMPLEADO WHERE COD_DEPARTAMENTO = P_ID;
    DELETE FROM JRGY_DEPARTAMENTO WHERE COD_DEPARTAMENTO = P_ID;
    IF SQL%ROWCOUNT = 0 THEN
        RAISE_APPLICATION_ERROR(-20103, 'DEPARTAMENTO NO ENCONTRADO');
    END IF;
    COMMIT;
END;
/

CREATE OR REPLACE PROCEDURE JRGY_PRO_DEP_ASIGNAR_EMPLEADOS(
    P_DEP_ID IN NUMBER,
    P_EMPLEADOS_JSON IN CLOB
)
IS
BEGIN
    DELETE FROM JRGY_DEPARTAMENTO_EMPLEADO WHERE COD_DEPARTAMENTO = P_DEP_ID;

    FOR rec IN (
        SELECT jt.empId AS COD_EMPLEADO
        FROM JSON_TABLE(P_EMPLEADOS_JSON, '$[*]'
            COLUMNS (
                empId NUMBER PATH '$'
            )
        ) jt
    ) LOOP
        INSERT INTO JRGY_DEPARTAMENTO_EMPLEADO (COD_DEPARTAMENTO, COD_EMPLEADO)
        VALUES (P_DEP_ID, rec.COD_EMPLEADO);
    END LOOP;

    COMMIT;
END;
/

PROMPT Creacion de tablas catalogo...
-- 1) Catalogos y dominios
CREATE TABLE JRGY_CAT_ESTADO_USUARIO (
    COD_ESTADO_USUARIO NUMBER,
    ESTADO_USUARIO VARCHAR2(30),
    CONSTRAINT PK_JRGY_CAT_ESTADO_USUARIO PRIMARY KEY (COD_ESTADO_USUARIO)
);

CREATE TABLE JRGY_CAT_ESTADO_LABORAL (
    COD_ESTADO_LABORAL NUMBER,
    ESTADO_LABORAL VARCHAR2(30),
    CONSTRAINT PK_JRGY_CAT_ESTADO_LABORAL PRIMARY KEY (COD_ESTADO_LABORAL)
);

CREATE TABLE JRGY_CAT_ESTADO_HABITACION (
    COD_ESTADO_HABITACION NUMBER,
    ESTADO_HABITACION VARCHAR2(30),
    CONSTRAINT PK_JRGY_CAT_ESTADO_HABITACION PRIMARY KEY (COD_ESTADO_HABITACION)
);

CREATE TABLE JRGY_CAT_TIPO_HABITACION (
    COD_TIPO_HABITACION NUMBER,
    TIPO_HABITACION VARCHAR2(50) NOT NULL,
    CONSTRAINT PK_JRGY_CAT_TIPO_HABITACION PRIMARY KEY (COD_TIPO_HABITACION),
    CONSTRAINT UQ_JRGY_CAT_TIPO_HABITACION UNIQUE (TIPO_HABITACION)
);

CREATE TABLE JRGY_CAT_MODO_PAGO (
    COD_MODO_PAGO NUMBER,
    MODO_PAGO VARCHAR2(30),
    CONSTRAINT PK_JRGY_CAT_MODO_PAGO PRIMARY KEY (COD_MODO_PAGO)
);

CREATE TABLE JRGY_CAT_ESTADO_RESERVA (
    COD_ESTADO_RESERVA NUMBER,
    ESTADO_RESERVA VARCHAR2(30),
    CONSTRAINT PK_JRGY_CAT_ESTADO_RESERVA PRIMARY KEY (COD_ESTADO_RESERVA)
);

CREATE TABLE JRGY_REGION (
    COD_REGION NUMBER,
    REGION VARCHAR2(50),
    CONSTRAINT PK_JRGY_REGION PRIMARY KEY (COD_REGION)
);

CREATE TABLE JRGY_CIUDAD (
    COD_CIUDAD NUMBER,
    CIUDAD VARCHAR2(50),
    COD_REGION NUMBER,
    CONSTRAINT PK_JRGY_CIUDAD PRIMARY KEY (COD_CIUDAD),
    CONSTRAINT FK_JRGY_CIUDAD_REGION FOREIGN KEY (COD_REGION) REFERENCES JRGY_REGION (COD_REGION)
);

CREATE TABLE JRGY_COMUNA (
    COD_COMUNA NUMBER,
    COMUNA VARCHAR2(50),
    COD_CIUDAD NUMBER,
    CONSTRAINT PK_JRGY_COMUNA PRIMARY KEY (COD_COMUNA),
    CONSTRAINT FK_JRGY_COMUNA_CIUDAD FOREIGN KEY (COD_CIUDAD) REFERENCES JRGY_CIUDAD (COD_CIUDAD)
);

CREATE TABLE JRGY_CALLE (
    COD_CALLE NUMBER,
    CALLE VARCHAR2(50),
    NRO NUMBER,
    COD_COMUNA NUMBER,
    CONSTRAINT PK_JRGY_CALLE PRIMARY KEY (COD_CALLE),
    CONSTRAINT FK_JRGY_CALLE_COMUNA FOREIGN KEY (COD_COMUNA) REFERENCES JRGY_COMUNA (COD_COMUNA)
);

CREATE TABLE JRGY_ROL (
    COD_ROL NUMBER,
    NOMBRE_ROL VARCHAR2(50),
    CONSTRAINT PK_JRGY_ROL PRIMARY KEY (COD_ROL)
);

PROMPT Creacion de tablas base...
-- 2) Tablas base
CREATE TABLE JRGY_USUARIO (
    COD_USUARIO NUMBER(8) NOT NULL,
    NOMBRE_USUARIO VARCHAR2(50),
    APELLIDO1_USUARIO VARCHAR2(50),
    APELLIDO2_USUARIO VARCHAR2(50),
    EMAIL_USUARIO VARCHAR2(100),
    TELEFONO_USUARIO NUMBER,
    CONTRASENA_HASH VARCHAR2(255),
    COD_ESTADO_USUARIO NUMBER,
    CONSTRAINT PK_JRGY_USUARIO PRIMARY KEY (COD_USUARIO),
    CONSTRAINT CHK_JRGY_USUARIO_RUT CHECK (COD_USUARIO BETWEEN 1000000 AND 99999999),
    CONSTRAINT FK_JRGY_USUARIO_ESTADO FOREIGN KEY (COD_ESTADO_USUARIO) REFERENCES JRGY_CAT_ESTADO_USUARIO (COD_ESTADO_USUARIO)
);

CREATE TABLE JRGY_CLIENTE (
    COD_CLIENTE NUMBER,
    COD_USUARIO NUMBER,
    FECHA_ALTA DATE,
    CONSTRAINT PK_JRGY_CLIENTE PRIMARY KEY (COD_CLIENTE),
    CONSTRAINT FK_JRGY_CLIENTE_USUARIO FOREIGN KEY (COD_USUARIO) REFERENCES JRGY_USUARIO (COD_USUARIO)
);

CREATE TABLE JRGY_PROVEEDOR (
    COD_PROVEEDOR NUMBER,
    NOMBRE_PROVEEDOR VARCHAR2(50),
    DIRECCION_PROVEEDOR VARCHAR2(100),
    TELEFONO_PROVEEDOR NUMBER,
    COD_REGION NUMBER,
    CONSTRAINT PK_JRGY_PROVEEDOR PRIMARY KEY (COD_PROVEEDOR),
    CONSTRAINT FK_JRGY_PROVEEDOR_REGION FOREIGN KEY (COD_REGION) REFERENCES JRGY_REGION (COD_REGION)
);

CREATE TABLE JRGY_PRODUCTO (
    COD_PRODUCTO NUMBER,
    NOMBRE_PRODUCTO VARCHAR2(50),
    TIPO_PRODUCTO VARCHAR2(20),
    PRECIO_PRODUCTO NUMBER,
    CANTIDAD_PRODUCTO NUMBER,
    STOCK_PRODUCTO NUMBER,
    CONSTRAINT PK_JRGY_PRODUCTO PRIMARY KEY (COD_PRODUCTO)
);

CREATE TABLE JRGY_EXPERIENCIA (
    COD_EXPERIENCIA NUMBER,
    NOMBRE VARCHAR2(100),
    DESCRIPCION VARCHAR2(255),
    PRECIO NUMBER,
    TAG VARCHAR2(50),
    ESTADO VARCHAR2(20),
    CONSTRAINT PK_JRGY_EXPERIENCIA PRIMARY KEY (COD_EXPERIENCIA)
);

CREATE TABLE JRGY_SERVICIO (
    COD_SERVICIO NUMBER,
    NOMBRE VARCHAR2(100) NOT NULL,
    DESCRIPCION VARCHAR2(500),
    PRECIO NUMBER DEFAULT 0 NOT NULL,
    TIPO VARCHAR2(30),
    ESTADO VARCHAR2(20) DEFAULT 'activo' NOT NULL,
    ES_DESTACADO CHAR(1) DEFAULT 'N',
    ORDEN NUMBER,
    CREATED_AT DATE DEFAULT SYSDATE,
    UPDATED_AT DATE,
    CONSTRAINT PK_JRGY_SERVICIO PRIMARY KEY (COD_SERVICIO),
    CONSTRAINT CHK_JRGY_SERVICIO_ESTADO CHECK (LOWER(ESTADO) IN ('activo', 'inactivo')),
    CONSTRAINT CHK_JRGY_SERVICIO_DEST CHECK (ES_DESTACADO IN ('Y', 'N'))
);

CREATE TABLE JRGY_SERVICIO_HORARIO (
    COD_HORARIO NUMBER,
    COD_SERVICIO NUMBER NOT NULL,
    HORA_INICIO NUMBER(4,2) NOT NULL,
    HORA_FIN NUMBER(4,2) NOT NULL,
    CONSTRAINT PK_JRGY_SERVICIO_HORARIO PRIMARY KEY (COD_HORARIO),
    CONSTRAINT FK_JRGY_SERV_HOR_SERV FOREIGN KEY (COD_SERVICIO) REFERENCES JRGY_SERVICIO (COD_SERVICIO) ON DELETE CASCADE,
    CONSTRAINT CHK_JRGY_SERV_HOR_HORAS CHECK (HORA_INICIO BETWEEN 0 AND 23.99 AND HORA_FIN BETWEEN 0 AND 23.99 AND HORA_FIN >= HORA_INICIO)
);

CREATE TABLE JRGY_EMPLEADO (
    COD_EMPLEADO NUMBER,
    COD_USUARIO NUMBER,
    COD_DEPARTAMENTO NUMBER,
    CARGO VARCHAR2(50),
    FECHA_CONTRATACION DATE,
    SALARIO NUMBER,
    COMISION NUMBER,
    COD_ESTADO_LABORAL NUMBER,
    CONSTRAINT PK_JRGY_EMPLEADO PRIMARY KEY (COD_EMPLEADO),
    CONSTRAINT FK_JRGY_EMPLEADO_USUARIO FOREIGN KEY (COD_USUARIO) REFERENCES JRGY_USUARIO (COD_USUARIO),
    CONSTRAINT FK_JRGY_EMPLEADO_ESTADO FOREIGN KEY (COD_ESTADO_LABORAL) REFERENCES JRGY_CAT_ESTADO_LABORAL (COD_ESTADO_LABORAL)
);

-- ========================================
-- Extensiones: productos, proveedores, departamentos, ajustes horarios
-- (ahora después de crear tablas base para evitar ORA-00942)
-- ========================================

-- Agregar columna UMBRAL_ALERTA a producto (ignorar si existe)
BEGIN
    EXECUTE IMMEDIATE 'ALTER TABLE JRGY_PRODUCTO ADD (UMBRAL_ALERTA NUMBER)';
EXCEPTION
    WHEN OTHERS THEN
        IF SQLCODE != -1430 THEN -- columna ya existe
            RAISE;
        END IF;
END;
/

-- Agregar columna SUELDO_BASE a empleado (ignorar si existe)
BEGIN
    EXECUTE IMMEDIATE 'ALTER TABLE JRGY_EMPLEADO ADD (SUELDO_BASE NUMBER)';
EXCEPTION
    WHEN OTHERS THEN
        IF SQLCODE != -1430 THEN
            RAISE;
        END IF;
END;
/

-- Ajuste de horarios de servicio para permitir minutos
BEGIN
    EXECUTE IMMEDIATE 'ALTER TABLE JRGY_SERVICIO_HORARIO MODIFY (HORA_INICIO NUMBER(4,2), HORA_FIN NUMBER(4,2))';
EXCEPTION
    WHEN OTHERS THEN
        IF SQLCODE NOT IN (-1430, -2289) THEN
            RAISE;
        END IF;
END;
/
BEGIN
    EXECUTE IMMEDIATE 'ALTER TABLE JRGY_SERVICIO_HORARIO DROP CONSTRAINT CHK_JRGY_SERV_HOR_HORAS';
EXCEPTION
    WHEN OTHERS THEN
        IF SQLCODE != -2443 THEN
            RAISE;
        END IF;
END;
/
BEGIN
    EXECUTE IMMEDIATE 'ALTER TABLE JRGY_SERVICIO_HORARIO ADD CONSTRAINT CHK_JRGY_SERV_HOR_HORAS CHECK (HORA_INICIO BETWEEN 0 AND 23.99 AND HORA_FIN BETWEEN 0 AND 23.99 AND HORA_FIN >= HORA_INICIO)';
EXCEPTION
    WHEN OTHERS THEN
        IF SQLCODE != -2264 THEN
            RAISE;
        END IF;
END;
/

-- Tabla puente servicio-producto
CREATE TABLE JRGY_SERVICIO_PRODUCTO (
    COD_SERVICIO NUMBER NOT NULL,
    COD_PRODUCTO NUMBER NOT NULL,
    CANTIDAD_BASE NUMBER DEFAULT 1,
    PRECIO_EXTRA NUMBER,
    CONSTRAINT PK_JRGY_SERVICIO_PRODUCTO PRIMARY KEY (COD_SERVICIO, COD_PRODUCTO),
    CONSTRAINT FK_JRGY_SERVICIO_PRODUCTO_SERV FOREIGN KEY (COD_SERVICIO) REFERENCES JRGY_SERVICIO (COD_SERVICIO),
    CONSTRAINT FK_JRGY_SERVICIO_PRODUCTO_PROD FOREIGN KEY (COD_PRODUCTO) REFERENCES JRGY_PRODUCTO (COD_PRODUCTO)
);
/

-- Tabla de departamentos (versión extendida)
CREATE TABLE JRGY_DEPARTAMENTO (
    COD_DEPARTAMENTO NUMBER PRIMARY KEY,
    NOMBRE VARCHAR2(100) NOT NULL,
    JEFE_EMPLEADO_ID NUMBER,
    PRESUPUESTO NUMBER,
    FECHA_CREACION DATE DEFAULT SYSDATE
);
/

CREATE SEQUENCE SQ_PK_DEPARTAMENTO START WITH 1 INCREMENT BY 1 NOMAXVALUE NOCYCLE;
CREATE OR REPLACE TRIGGER TRG_PK_DEPARTAMENTO BEFORE INSERT ON JRGY_DEPARTAMENTO FOR EACH ROW
BEGIN
    IF :NEW.COD_DEPARTAMENTO IS NULL THEN
        :NEW.COD_DEPARTAMENTO := SQ_PK_DEPARTAMENTO.NEXTVAL;
    END IF;
END;
/

CREATE TABLE JRGY_DEPARTAMENTO_EMPLEADO (
    COD_DEPARTAMENTO NUMBER NOT NULL,
    COD_EMPLEADO NUMBER NOT NULL,
    CONSTRAINT PK_JRGY_DEP_EMP PRIMARY KEY (COD_DEPARTAMENTO, COD_EMPLEADO),
    CONSTRAINT FK_JRGY_DEP_EMP_DEP FOREIGN KEY (COD_DEPARTAMENTO) REFERENCES JRGY_DEPARTAMENTO (COD_DEPARTAMENTO) ON DELETE CASCADE,
    CONSTRAINT FK_JRGY_DEP_EMP_EMP FOREIGN KEY (COD_EMPLEADO) REFERENCES JRGY_EMPLEADO (COD_EMPLEADO) ON DELETE CASCADE
);
/

ALTER TABLE JRGY_DEPARTAMENTO
    ADD CONSTRAINT FK_JRGY_DEPTO_JEFE FOREIGN KEY (JEFE_EMPLEADO_ID) REFERENCES JRGY_EMPLEADO (COD_EMPLEADO);

ALTER TABLE JRGY_EMPLEADO
    ADD CONSTRAINT FK_JRGY_EMPLEADO_DEPTO FOREIGN KEY (COD_DEPARTAMENTO) REFERENCES JRGY_DEPARTAMENTO (COD_DEPARTAMENTO);

PROMPT Creacion de tablas dependientes...
-- 3) Tablas dependientes
CREATE TABLE JRGY_USUARIO_ROL (
    COD_USUARIO NUMBER,
    COD_ROL NUMBER,
    CONSTRAINT PK_JRGY_USUARIO_ROL PRIMARY KEY (COD_USUARIO, COD_ROL),
    CONSTRAINT FK_JRGY_USUARIO_ROL_USUARIO FOREIGN KEY (COD_USUARIO) REFERENCES JRGY_USUARIO (COD_USUARIO),
    CONSTRAINT FK_JRGY_USUARIO_ROL_ROL FOREIGN KEY (COD_ROL) REFERENCES JRGY_ROL (COD_ROL)
);

CREATE TABLE JRGY_SOLICITUD_ADMIN (
    COD_SOLICITUD NUMBER,
    COD_USUARIO NUMBER NOT NULL,
    ESTADO VARCHAR2(20) NOT NULL,
    MOTIVO VARCHAR2(255),
    APROBADO_POR NUMBER,
    FECHA_CREACION DATE DEFAULT SYSDATE,
    FECHA_RESOLUCION DATE,
    CONSTRAINT PK_JRGY_SOLICITUD_ADMIN PRIMARY KEY (COD_SOLICITUD),
    CONSTRAINT FK_JRGY_SOLICITUD_USUARIO FOREIGN KEY (COD_USUARIO) REFERENCES JRGY_USUARIO (COD_USUARIO),
    CONSTRAINT FK_JRGY_SOLICITUD_APROBADO FOREIGN KEY (APROBADO_POR) REFERENCES JRGY_USUARIO (COD_USUARIO),
    CONSTRAINT CHK_JRGY_SOLICITUD_ESTADO CHECK (ESTADO IN ('pending', 'approved', 'rejected'))
);

CREATE INDEX IDX_JRGY_SOLICITUD_USUARIO ON JRGY_SOLICITUD_ADMIN (COD_USUARIO);

CREATE TABLE JRGY_HABITACION (
    COD_HABITACION NUMBER,
    NRO_HABITACION NUMBER,
    CAPACIDAD NUMBER,
    COD_TIPO_HABITACION NUMBER,
    COD_ESTADO_HABITACION NUMBER,
    PRECIO_BASE NUMBER,
    CONSTRAINT PK_JRGY_HABITACION PRIMARY KEY (COD_HABITACION),
    CONSTRAINT FK_JRGY_HAB_TIPO FOREIGN KEY (COD_TIPO_HABITACION) REFERENCES JRGY_CAT_TIPO_HABITACION (COD_TIPO_HABITACION),
    CONSTRAINT FK_JRGY_HAB_ESTADO FOREIGN KEY (COD_ESTADO_HABITACION) REFERENCES JRGY_CAT_ESTADO_HABITACION (COD_ESTADO_HABITACION)
);

CREATE TABLE JRGY_RESERVA (
    COD_RESERVA NUMBER,
    COD_USUARIO NUMBER NOT NULL,
    COD_HABITACION NUMBER NOT NULL,
    FECHA_INICIO DATE NOT NULL,
    FECHA_FIN DATE NOT NULL,
    HUESPEDES NUMBER,
    TOTAL_HABITACION NUMBER DEFAULT 0,
    TOTAL_SERVICIOS NUMBER DEFAULT 0,
    TOTAL NUMBER,
    COD_ESTADO_RESERVA NUMBER,
    CREATED_AT DATE DEFAULT SYSDATE,
    UPDATED_AT DATE,
    CONSTRAINT PK_JRGY_RESERVA PRIMARY KEY (COD_RESERVA),
    CONSTRAINT FK_JRGY_RESERVA_USUARIO FOREIGN KEY (COD_USUARIO) REFERENCES JRGY_USUARIO (COD_USUARIO),
    CONSTRAINT FK_JRGY_RESERVA_HAB FOREIGN KEY (COD_HABITACION) REFERENCES JRGY_HABITACION (COD_HABITACION),
    CONSTRAINT FK_JRGY_RESERVA_ESTADO FOREIGN KEY (COD_ESTADO_RESERVA) REFERENCES JRGY_CAT_ESTADO_RESERVA (COD_ESTADO_RESERVA),
    CONSTRAINT CHK_JRGY_RESERVA_FECHAS CHECK (FECHA_FIN >= FECHA_INICIO)
);

CREATE INDEX IDX_JRGY_RESERVA_USUARIO ON JRGY_RESERVA (COD_USUARIO);
CREATE INDEX IDX_JRGY_RESERVA_HAB ON JRGY_RESERVA (COD_HABITACION, FECHA_INICIO, FECHA_FIN);

CREATE TABLE JRGY_RESERVA_SERVICIO (
    COD_RESERVA_SERVICIO NUMBER,
    COD_RESERVA NUMBER NOT NULL,
    COD_SERVICIO NUMBER NOT NULL,
    FECHA_SERVICIO DATE NOT NULL,
    HORA NUMBER(2,0) NOT NULL,
    CANTIDAD NUMBER DEFAULT 1 NOT NULL,
    PRECIO_UNIT NUMBER DEFAULT 0 NOT NULL,
    TOTAL NUMBER,
    NOTA VARCHAR2(500),
    ESTADO VARCHAR2(20) DEFAULT 'pendiente',
    CREATED_AT DATE DEFAULT SYSDATE,
    UPDATED_AT DATE,
    CONSTRAINT PK_JRGY_RESERVA_SERVICIO PRIMARY KEY (COD_RESERVA_SERVICIO),
    CONSTRAINT FK_JRGY_RES_SERV_RES FOREIGN KEY (COD_RESERVA) REFERENCES JRGY_RESERVA (COD_RESERVA) ON DELETE CASCADE,
    CONSTRAINT FK_JRGY_RES_SERV_SERV FOREIGN KEY (COD_SERVICIO) REFERENCES JRGY_SERVICIO (COD_SERVICIO),
    CONSTRAINT CHK_JRGY_RES_SERV_ESTADO CHECK (LOWER(ESTADO) IN ('pendiente', 'confirmado', 'cancelado')),
    CONSTRAINT CHK_JRGY_RES_SERV_CANT CHECK (CANTIDAD > 0),
    CONSTRAINT CHK_JRGY_RES_SERV_HORA CHECK (HORA BETWEEN 0 AND 23)
);

CREATE INDEX IDX_JRGY_RES_SERV_RES ON JRGY_RESERVA_SERVICIO (COD_RESERVA);
CREATE INDEX IDX_JRGY_RES_SERV_SERV ON JRGY_RESERVA_SERVICIO (COD_SERVICIO);

CREATE TABLE JRGY_EVENTO_RESERVA (
    COD_EVENTO_RESERVA NUMBER,
    COD_RESERVA NUMBER NOT NULL,
    TIPO_EVENTO VARCHAR2(50),
    FECHA_EVENTO DATE,
    NOTAS VARCHAR2(500),
    CREATED_AT DATE DEFAULT SYSDATE,
    CREATED_BY NUMBER,
    CONSTRAINT PK_JRGY_EVENTO_RESERVA PRIMARY KEY (COD_EVENTO_RESERVA),
    CONSTRAINT FK_JRGY_EVENTO_RESERVA_RES FOREIGN KEY (COD_RESERVA) REFERENCES JRGY_RESERVA (COD_RESERVA) ON DELETE CASCADE,
    CONSTRAINT FK_JRGY_EVENTO_RESERVA_USER FOREIGN KEY (CREATED_BY) REFERENCES JRGY_USUARIO (COD_USUARIO)
);

CREATE INDEX IDX_JRGY_EVENTO_RESERVA_RES ON JRGY_EVENTO_RESERVA (COD_RESERVA);

CREATE TABLE JRGY_RESERVA_EXP (
    COD_RESERVA_EXP NUMBER,
    COD_RESERVA NUMBER NOT NULL,
    COD_EXPERIENCIA NUMBER NOT NULL,
    CANTIDAD NUMBER DEFAULT 1,
    PRECIO_UNITARIO NUMBER,
    CONSTRAINT PK_JRGY_RESERVA_EXP PRIMARY KEY (COD_RESERVA_EXP),
    CONSTRAINT FK_JRGY_RES_EXP_RESERVA FOREIGN KEY (COD_RESERVA) REFERENCES JRGY_RESERVA (COD_RESERVA) ON DELETE CASCADE,
    CONSTRAINT FK_JRGY_RES_EXP_EXP FOREIGN KEY (COD_EXPERIENCIA) REFERENCES JRGY_EXPERIENCIA (COD_EXPERIENCIA)
);

CREATE INDEX IDX_JRGY_RESERVA_EXP_RES ON JRGY_RESERVA_EXP (COD_RESERVA);
CREATE INDEX IDX_JRGY_RESERVA_EXP_EXP ON JRGY_RESERVA_EXP (COD_EXPERIENCIA);

CREATE TABLE JRGY_PAGO_HABITACION (
    COD_PAGO_HABITACION NUMBER,
    FECHA_PAGO DATE,
    VALOR_TOTAL_PAGO NUMBER,
    COD_USUARIO NUMBER,
    CONSTRAINT PK_JRGY_PAGO_HABITACION PRIMARY KEY (COD_PAGO_HABITACION),
    CONSTRAINT FK_JRGY_PAGO_HABITACION_USUARIO FOREIGN KEY (COD_USUARIO) REFERENCES JRGY_USUARIO (COD_USUARIO)
);

CREATE TABLE JRGY_DETALLE_PAGO_HABITACION (
    COD_PAGO_HABITACION NUMBER,
    COD_HABITACION NUMBER,
    FECHA_ESTADIA DATE,
    PRECIO_HABITACION NUMBER,
    DIAS NUMBER,
    CONSTRAINT PK_JRGY_DETALLE_PAGO_HABITACION PRIMARY KEY (COD_PAGO_HABITACION, COD_HABITACION),
    CONSTRAINT FK_JRGY_DETALLE_PAGO_HABITACION_PAGO FOREIGN KEY (COD_PAGO_HABITACION) REFERENCES JRGY_PAGO_HABITACION (COD_PAGO_HABITACION) ON DELETE CASCADE,
    CONSTRAINT FK_JRGY_DETALLE_PAGO_HABITACION_HAB FOREIGN KEY (COD_HABITACION) REFERENCES JRGY_HABITACION (COD_HABITACION)
);

CREATE TABLE JRGY_PEDIDO (
    COD_PEDIDO NUMBER,
    VALOR_TOTAL NUMBER,
    FECHA_PEDIDO DATE,
    COD_EMPLEADO NUMBER,
    CONSTRAINT PK_JRGY_PEDIDO PRIMARY KEY (COD_PEDIDO),
    CONSTRAINT FK_JRGY_PEDIDO_EMPLEADO FOREIGN KEY (COD_EMPLEADO) REFERENCES JRGY_EMPLEADO (COD_EMPLEADO)
);

CREATE TABLE JRGY_DETALLE_PEDIDO (
    COD_PEDIDO NUMBER,
    COD_PROVEEDOR NUMBER,
    COD_PRODUCTO NUMBER,
    NOMBRE_PRODUCTO VARCHAR2(50),
    CANTIDAD_PRODUCTO NUMBER,
    PRECIO_COMPRA NUMBER,
    PRECIO_TOTAL NUMBER,
    CONSTRAINT PK_JRGY_DETALLE_PEDIDO PRIMARY KEY (COD_PEDIDO, COD_PROVEEDOR, COD_PRODUCTO),
    CONSTRAINT FK_JRGY_DETALLE_PEDIDO_PEDIDO FOREIGN KEY (COD_PEDIDO) REFERENCES JRGY_PEDIDO (COD_PEDIDO) ON DELETE CASCADE,
    CONSTRAINT FK_JRGY_DETALLE_PEDIDO_PROVEEDOR FOREIGN KEY (COD_PROVEEDOR) REFERENCES JRGY_PROVEEDOR (COD_PROVEEDOR),
    CONSTRAINT FK_JRGY_DETALLE_PEDIDO_PRODUCTO FOREIGN KEY (COD_PRODUCTO) REFERENCES JRGY_PRODUCTO (COD_PRODUCTO)
);

CREATE TABLE JRGY_VENTA (
    COD_VENTA NUMBER,
    COD_USUARIO NUMBER,
    COD_EMPLEADO NUMBER,
    FECHA_VENTA DATE,
    CONSTRAINT PK_JRGY_VENTA PRIMARY KEY (COD_VENTA),
    CONSTRAINT FK_JRGY_VENTA_USUARIO FOREIGN KEY (COD_USUARIO) REFERENCES JRGY_USUARIO (COD_USUARIO),
    CONSTRAINT FK_JRGY_VENTA_EMPLEADO FOREIGN KEY (COD_EMPLEADO) REFERENCES JRGY_EMPLEADO (COD_EMPLEADO)
);

CREATE TABLE JRGY_DETALLE_VENTA (
    COD_VENTA NUMBER,
    COD_PRODUCTO NUMBER,
    CANTIDAD NUMBER,
    PRECIO_PRODUCTO NUMBER,
    PRECIO_TOTAL NUMBER,
    CONSTRAINT PK_JRGY_DETALLE_VENTA PRIMARY KEY (COD_VENTA, COD_PRODUCTO),
    CONSTRAINT FK_JRGY_DETALLE_VENTA_VENTA FOREIGN KEY (COD_VENTA) REFERENCES JRGY_VENTA (COD_VENTA) ON DELETE CASCADE,
    CONSTRAINT FK_JRGY_DETALLE_VENTA_PRODUCTO FOREIGN KEY (COD_PRODUCTO) REFERENCES JRGY_PRODUCTO (COD_PRODUCTO)
);

CREATE TABLE JRGY_MOVIMIENTO_STOCK (
    COD_MOVIMIENTO NUMBER,
    COD_PRODUCTO NUMBER,
    TIPO_MOVIMIENTO VARCHAR2(20),
    CANTIDAD NUMBER,
    FECHA_MOVIMIENTO DATE,
    MOTIVO VARCHAR2(100),
    CONSTRAINT PK_JRGY_MOVIMIENTO_STOCK PRIMARY KEY (COD_MOVIMIENTO),
    CONSTRAINT FK_JRGY_MOVIMIENTO_STOCK_PRODUCTO FOREIGN KEY (COD_PRODUCTO) REFERENCES JRGY_PRODUCTO (COD_PRODUCTO)
);

CREATE TABLE JRGY_PAGO_VENTA (
    COD_PAGO NUMBER,
    COD_VENTA NUMBER,
    COD_MODO_PAGO NUMBER,
    MONTO NUMBER,
    FECHA_PAGO DATE,
    CONSTRAINT PK_JRGY_PAGO_VENTA PRIMARY KEY (COD_PAGO),
    CONSTRAINT FK_JRGY_PAGO_VENTA_VENTA FOREIGN KEY (COD_VENTA) REFERENCES JRGY_VENTA (COD_VENTA),
    CONSTRAINT FK_JRGY_PAGO_VENTA_MODO FOREIGN KEY (COD_MODO_PAGO) REFERENCES JRGY_CAT_MODO_PAGO (COD_MODO_PAGO)
);

CREATE TABLE TOKENS (
    TOKEN VARCHAR2(128),
    USER_ID NUMBER NOT NULL,
    EXPIRES_AT DATE,
    CREATED_AT DATE DEFAULT SYSDATE,
    CONSTRAINT PK_TOKENS PRIMARY KEY (TOKEN),
    CONSTRAINT FK_TOKENS_USUARIO FOREIGN KEY (USER_ID) REFERENCES JRGY_USUARIO (COD_USUARIO)
);

CREATE INDEX IDX_TOKENS_USER ON TOKENS (USER_ID);

PROMPT Creacion de secuencias y triggers PK...
-- 4) Secuencias y triggers para PK
CREATE SEQUENCE SQ_PK_CLIENTE START WITH 1 INCREMENT BY 1 NOMAXVALUE NOCYCLE;
CREATE OR REPLACE TRIGGER TRG_PK_CLIENTE BEFORE INSERT ON JRGY_CLIENTE FOR EACH ROW
BEGIN IF :NEW.COD_CLIENTE IS NULL THEN :NEW.COD_CLIENTE := SQ_PK_CLIENTE.NEXTVAL; END IF; END;
/

CREATE SEQUENCE SQ_PK_CAT_TIPO_HAB START WITH 100 INCREMENT BY 1 NOMAXVALUE NOCYCLE;
CREATE OR REPLACE TRIGGER TRG_PK_CAT_TIPO_HAB BEFORE INSERT ON JRGY_CAT_TIPO_HABITACION FOR EACH ROW
BEGIN IF :NEW.COD_TIPO_HABITACION IS NULL THEN :NEW.COD_TIPO_HABITACION := SQ_PK_CAT_TIPO_HAB.NEXTVAL; END IF; END;
/

CREATE SEQUENCE SQ_PK_HABITACION START WITH 1 INCREMENT BY 1 NOMAXVALUE NOCYCLE;
CREATE OR REPLACE TRIGGER TRG_PK_HABITACION BEFORE INSERT ON JRGY_HABITACION FOR EACH ROW
BEGIN IF :NEW.COD_HABITACION IS NULL THEN :NEW.COD_HABITACION := SQ_PK_HABITACION.NEXTVAL; END IF; END;
/

CREATE SEQUENCE SQ_PK_EMPLEADO START WITH 1 INCREMENT BY 1 NOMAXVALUE NOCYCLE;
CREATE OR REPLACE TRIGGER TRG_PK_EMPLEADO BEFORE INSERT ON JRGY_EMPLEADO FOR EACH ROW
BEGIN IF :NEW.COD_EMPLEADO IS NULL THEN :NEW.COD_EMPLEADO := SQ_PK_EMPLEADO.NEXTVAL; END IF; END;
/
CREATE OR REPLACE TRIGGER TRG_MISMA_PK_EMPLEADO BEFORE INSERT ON JRGY_EMPLEADO FOR EACH ROW
DECLARE V_COUNT NUMBER;
BEGIN
    SELECT COUNT(*) INTO V_COUNT FROM JRGY_EMPLEADO WHERE COD_EMPLEADO = :NEW.COD_EMPLEADO;
    IF V_COUNT > 0 THEN RAISE_APPLICATION_ERROR(-2002, 'YA EXISTE EL EMPLEADO'); END IF;
END;
/

CREATE SEQUENCE SQ_PK_PRODUCTO START WITH 1 INCREMENT BY 1 NOMAXVALUE NOCYCLE;
CREATE OR REPLACE TRIGGER TRG_PK_PRODUCTO BEFORE INSERT ON JRGY_PRODUCTO FOR EACH ROW
BEGIN IF :NEW.COD_PRODUCTO IS NULL THEN :NEW.COD_PRODUCTO := SQ_PK_PRODUCTO.NEXTVAL; END IF; END;
/
CREATE OR REPLACE TRIGGER TRG_MISMA_PK_PRODUCTO BEFORE INSERT ON JRGY_PRODUCTO FOR EACH ROW
DECLARE V_COUNT NUMBER;
BEGIN
    SELECT COUNT(*) INTO V_COUNT FROM JRGY_PRODUCTO WHERE COD_PRODUCTO = :NEW.COD_PRODUCTO;
    IF V_COUNT > 0 THEN RAISE_APPLICATION_ERROR(-2003, 'YA EXISTE EL PRODUCTO'); END IF;
END;
/

CREATE SEQUENCE SQ_PK_EXPERIENCIA START WITH 1 INCREMENT BY 1 NOMAXVALUE NOCYCLE;
CREATE OR REPLACE TRIGGER TRG_PK_EXPERIENCIA BEFORE INSERT ON JRGY_EXPERIENCIA FOR EACH ROW
BEGIN
    IF :NEW.COD_EXPERIENCIA IS NULL THEN
        :NEW.COD_EXPERIENCIA := SQ_PK_EXPERIENCIA.NEXTVAL;
    END IF;
END;
/

CREATE SEQUENCE SQ_PK_SERVICIO START WITH 1 INCREMENT BY 1 NOMAXVALUE NOCYCLE;
CREATE OR REPLACE TRIGGER TRG_PK_SERVICIO BEFORE INSERT ON JRGY_SERVICIO FOR EACH ROW
BEGIN
    IF :NEW.COD_SERVICIO IS NULL THEN
        :NEW.COD_SERVICIO := SQ_PK_SERVICIO.NEXTVAL;
    END IF;
END;
/

CREATE SEQUENCE SQ_PK_SERVICIO_HORARIO START WITH 1 INCREMENT BY 1 NOMAXVALUE NOCYCLE;
CREATE OR REPLACE TRIGGER TRG_PK_SERVICIO_HORARIO BEFORE INSERT ON JRGY_SERVICIO_HORARIO FOR EACH ROW
BEGIN
    IF :NEW.COD_HORARIO IS NULL THEN
        :NEW.COD_HORARIO := SQ_PK_SERVICIO_HORARIO.NEXTVAL;
    END IF;
END;
/

CREATE SEQUENCE SQ_PK_RESERVA_SERVICIO START WITH 1 INCREMENT BY 1 NOMAXVALUE NOCYCLE;
CREATE OR REPLACE TRIGGER TRG_PK_RESERVA_SERVICIO BEFORE INSERT ON JRGY_RESERVA_SERVICIO FOR EACH ROW
BEGIN
    IF :NEW.COD_RESERVA_SERVICIO IS NULL THEN
        :NEW.COD_RESERVA_SERVICIO := SQ_PK_RESERVA_SERVICIO.NEXTVAL;
    END IF;
    IF :NEW.TOTAL IS NULL THEN
        :NEW.TOTAL := NVL(:NEW.CANTIDAD, 0) * NVL(:NEW.PRECIO_UNIT, 0);
    END IF;
END;
/

CREATE SEQUENCE SQ_PK_PEDIDO START WITH 1 INCREMENT BY 1 NOMAXVALUE NOCYCLE;
CREATE OR REPLACE TRIGGER TRG_PK_PEDIDO BEFORE INSERT ON JRGY_PEDIDO FOR EACH ROW
BEGIN
    IF :NEW.COD_PEDIDO IS NULL THEN
        :NEW.COD_PEDIDO := SQ_PK_PEDIDO.NEXTVAL;
    END IF;
END;
/
CREATE SEQUENCE SQ_PK_ROL START WITH 1 INCREMENT BY 1 NOMAXVALUE NOCYCLE;
CREATE OR REPLACE TRIGGER TRG_PK_ROL BEFORE INSERT ON JRGY_ROL FOR EACH ROW
BEGIN IF :NEW.COD_ROL IS NULL THEN :NEW.COD_ROL := SQ_PK_ROL.NEXTVAL; END IF; END;
/

CREATE SEQUENCE SQ_PK_SOLICITUD_ADMIN START WITH 1 INCREMENT BY 1 NOMAXVALUE NOCYCLE;
CREATE OR REPLACE TRIGGER TRG_PK_SOLICITUD_ADMIN BEFORE INSERT ON JRGY_SOLICITUD_ADMIN FOR EACH ROW
BEGIN IF :NEW.COD_SOLICITUD IS NULL THEN :NEW.COD_SOLICITUD := SQ_PK_SOLICITUD_ADMIN.NEXTVAL; END IF; END;
/

CREATE SEQUENCE SQ_PK_MOVIMIENTO_STOCK START WITH 1 INCREMENT BY 1 NOMAXVALUE NOCYCLE;
CREATE OR REPLACE TRIGGER TRG_PK_MOVIMIENTO_STOCK BEFORE INSERT ON JRGY_MOVIMIENTO_STOCK FOR EACH ROW
BEGIN IF :NEW.COD_MOVIMIENTO IS NULL THEN :NEW.COD_MOVIMIENTO := SQ_PK_MOVIMIENTO_STOCK.NEXTVAL; END IF; END;
/

CREATE SEQUENCE SQ_PK_PAGO_VENTA START WITH 1 INCREMENT BY 1 NOMAXVALUE NOCYCLE;
CREATE OR REPLACE TRIGGER TRG_PK_PAGO_VENTA BEFORE INSERT ON JRGY_PAGO_VENTA FOR EACH ROW
BEGIN IF :NEW.COD_PAGO IS NULL THEN :NEW.COD_PAGO := SQ_PK_PAGO_VENTA.NEXTVAL; END IF; END;
/

CREATE SEQUENCE SQ_PK_VENTA START WITH 1 INCREMENT BY 1 NOMAXVALUE NOCYCLE;
CREATE OR REPLACE TRIGGER TRG_PK_VENTA BEFORE INSERT ON JRGY_VENTA FOR EACH ROW
BEGIN IF :NEW.COD_VENTA IS NULL THEN :NEW.COD_VENTA := SQ_PK_VENTA.NEXTVAL; END IF; END;
/

CREATE SEQUENCE SQ_PK_PAGO_HAB START WITH 1 INCREMENT BY 1 NOMAXVALUE NOCYCLE;
CREATE OR REPLACE TRIGGER TRG_PK_PAGO_HAB BEFORE INSERT ON JRGY_PAGO_HABITACION FOR EACH ROW
BEGIN IF :NEW.COD_PAGO_HABITACION IS NULL THEN :NEW.COD_PAGO_HABITACION := SQ_PK_PAGO_HAB.NEXTVAL; END IF; END;
/

CREATE SEQUENCE SQ_PK_RESERVA START WITH 1 INCREMENT BY 1 NOMAXVALUE NOCYCLE;
CREATE OR REPLACE TRIGGER TRG_PK_RESERVA BEFORE INSERT ON JRGY_RESERVA FOR EACH ROW
BEGIN IF :NEW.COD_RESERVA IS NULL THEN :NEW.COD_RESERVA := SQ_PK_RESERVA.NEXTVAL; END IF; END;
/

CREATE SEQUENCE SQ_PK_EVENTO_RESERVA START WITH 1 INCREMENT BY 1 NOMAXVALUE NOCYCLE;
CREATE OR REPLACE TRIGGER TRG_PK_EVENTO_RESERVA BEFORE INSERT ON JRGY_EVENTO_RESERVA FOR EACH ROW
BEGIN IF :NEW.COD_EVENTO_RESERVA IS NULL THEN :NEW.COD_EVENTO_RESERVA := SQ_PK_EVENTO_RESERVA.NEXTVAL; END IF; END;
/

CREATE SEQUENCE SQ_PK_RESERVA_EXP START WITH 1 INCREMENT BY 1 NOMAXVALUE NOCYCLE;
CREATE OR REPLACE TRIGGER TRG_PK_RESERVA_EXP BEFORE INSERT ON JRGY_RESERVA_EXP FOR EACH ROW
BEGIN
    IF :NEW.COD_RESERVA_EXP IS NULL THEN
        :NEW.COD_RESERVA_EXP := SQ_PK_RESERVA_EXP.NEXTVAL;
    END IF;
END;
/

CREATE OR REPLACE TRIGGER TRG_SERVICIO_UPDATED_AT
    BEFORE UPDATE ON JRGY_SERVICIO
    FOR EACH ROW
BEGIN
    :NEW.UPDATED_AT := SYSDATE;
END;
/

CREATE OR REPLACE TRIGGER TRG_RESERVA_SERVICIO_TOTAL
    BEFORE INSERT OR UPDATE ON JRGY_RESERVA_SERVICIO
    FOR EACH ROW
BEGIN
    :NEW.TOTAL := NVL(:NEW.CANTIDAD, 0) * NVL(:NEW.PRECIO_UNIT, 0);
    :NEW.UPDATED_AT := SYSDATE;
END;
/

CREATE OR REPLACE TRIGGER TRG_CAT_TIPO_HAB_MAYUS
    BEFORE INSERT OR UPDATE ON JRGY_CAT_TIPO_HABITACION
    FOR EACH ROW
BEGIN
    :NEW.TIPO_HABITACION := UPPER(TRIM(:NEW.TIPO_HABITACION));
END;
/

PROMPT Datos base para catalogos y roles...
DECLARE
    PROCEDURE ensure_cat_estado_usuario(p_codigo NUMBER, p_nombre VARCHAR2) IS
    BEGIN
        MERGE INTO JRGY_CAT_ESTADO_USUARIO t
        USING (SELECT p_codigo AS COD, p_nombre AS NOM FROM dual) s
        ON (UPPER(t.ESTADO_USUARIO) = UPPER(s.NOM))
        WHEN NOT MATCHED THEN
            INSERT (COD_ESTADO_USUARIO, ESTADO_USUARIO) VALUES (s.COD, s.NOM);
    END;

    PROCEDURE ensure_cat_estado_laboral(p_codigo NUMBER, p_nombre VARCHAR2) IS
    BEGIN
        MERGE INTO JRGY_CAT_ESTADO_LABORAL t
        USING (SELECT p_codigo AS COD, p_nombre AS NOM FROM dual) s
        ON (UPPER(t.ESTADO_LABORAL) = UPPER(s.NOM))
        WHEN NOT MATCHED THEN
            INSERT (COD_ESTADO_LABORAL, ESTADO_LABORAL) VALUES (s.COD, s.NOM);
    END;

    PROCEDURE ensure_cat_estado_hab(p_codigo NUMBER, p_nombre VARCHAR2) IS
    BEGIN
        MERGE INTO JRGY_CAT_ESTADO_HABITACION t
        USING (SELECT p_codigo AS COD, p_nombre AS NOM FROM dual) s
        ON (UPPER(t.ESTADO_HABITACION) = UPPER(s.NOM))
        WHEN NOT MATCHED THEN
            INSERT (COD_ESTADO_HABITACION, ESTADO_HABITACION) VALUES (s.COD, s.NOM);
    END;

    PROCEDURE ensure_cat_tipo_hab(p_codigo NUMBER, p_nombre VARCHAR2) IS
    BEGIN
        MERGE INTO JRGY_CAT_TIPO_HABITACION t
        USING (SELECT p_codigo AS COD, p_nombre AS NOM FROM dual) s
        ON (UPPER(t.TIPO_HABITACION) = UPPER(s.NOM))
        WHEN NOT MATCHED THEN
            INSERT (COD_TIPO_HABITACION, TIPO_HABITACION) VALUES (s.COD, s.NOM);
    END;

    PROCEDURE ensure_cat_modo_pago(p_codigo NUMBER, p_nombre VARCHAR2) IS
    BEGIN
        MERGE INTO JRGY_CAT_MODO_PAGO t
        USING (SELECT p_codigo AS COD, p_nombre AS NOM FROM dual) s
        ON (UPPER(t.MODO_PAGO) = UPPER(s.NOM))
        WHEN NOT MATCHED THEN
            INSERT (COD_MODO_PAGO, MODO_PAGO) VALUES (s.COD, s.NOM);
    END;

    PROCEDURE ensure_rol(p_codigo NUMBER, p_nombre VARCHAR2) IS
    BEGIN
        MERGE INTO JRGY_ROL t
        USING (SELECT p_codigo AS COD, p_nombre AS NOM FROM dual) s
        ON (UPPER(t.NOMBRE_ROL) = UPPER(s.NOM))
        WHEN NOT MATCHED THEN
            INSERT (COD_ROL, NOMBRE_ROL) VALUES (s.COD, s.NOM);
    END;
    PROCEDURE ensure_cat_estado_reserva(p_codigo NUMBER, p_nombre VARCHAR2) IS
    BEGIN
        MERGE INTO JRGY_CAT_ESTADO_RESERVA t
        USING (SELECT p_codigo AS COD, p_nombre AS NOM FROM dual) s
        ON (UPPER(t.ESTADO_RESERVA) = UPPER(s.NOM))
        WHEN NOT MATCHED THEN
            INSERT (COD_ESTADO_RESERVA, ESTADO_RESERVA) VALUES (s.COD, s.NOM);
    END;
BEGIN
    ensure_cat_estado_usuario(1, 'ACTIVO');
    ensure_cat_estado_usuario(2, 'INACTIVO');

    ensure_cat_estado_laboral(1, 'ACTIVO');
    ensure_cat_estado_laboral(2, 'SUSPENDIDO');
    ensure_cat_estado_laboral(3, 'INACTIVO');
    ensure_cat_estado_laboral(4, 'DESPEDIDO');
    ensure_cat_estado_laboral(5, 'RENUNCIADO');

    ensure_cat_estado_hab(1, 'LIBRE');
    ensure_cat_estado_hab(2, 'OCUPADA');
    ensure_cat_estado_hab(3, 'MANTENCION');

    ensure_cat_tipo_hab(1, 'SIMPLE');
    ensure_cat_tipo_hab(2, 'DOBLE');
    ensure_cat_tipo_hab(3, 'MATRIMONIAL');
    ensure_cat_tipo_hab(4, 'PREMIUM');
    ensure_cat_tipo_hab(5, 'CONFORT');
    ensure_cat_tipo_hab(6, 'MATRIMONIAL_FAMILIAR');
    ensure_cat_tipo_hab(7, 'SUITE');

    ensure_cat_modo_pago(1, 'EFECTIVO');
    ensure_cat_modo_pago(2, 'TARJETA');
    ensure_cat_modo_pago(3, 'TRANSFERENCIA');

    ensure_rol(1, 'ADMIN');
    ensure_rol(2, 'EMPLOYEE');
    ensure_rol(3, 'USER');

    ensure_cat_estado_reserva(1, 'CREADA');
    ensure_cat_estado_reserva(2, 'CONFIRMADA');
    ensure_cat_estado_reserva(3, 'EN_PROCESO');
    ensure_cat_estado_reserva(4, 'CHECKOUT_SOLICITADO');
    ensure_cat_estado_reserva(5, 'FINALIZADA');
    ensure_cat_estado_reserva(6, 'CANCELADA');
END;
/

-- Ajusta la secuencia de roles para que no choque con los IDs sembrados
DECLARE
    v_curr NUMBER;
    v_next NUMBER;
BEGIN
    SELECT NVL(MAX(COD_ROL), 0) + 1 INTO v_next FROM JRGY_ROL;
    SELECT last_number INTO v_curr FROM user_sequences WHERE sequence_name = 'SQ_PK_ROL';

    IF v_curr < v_next THEN
        EXECUTE IMMEDIATE 'ALTER SEQUENCE SQ_PK_ROL INCREMENT BY ' || (v_next - v_curr);
        SELECT SQ_PK_ROL.NEXTVAL INTO v_curr FROM dual;
        EXECUTE IMMEDIATE 'ALTER SEQUENCE SQ_PK_ROL INCREMENT BY 1';
    END IF;
END;
/

PROMPT Creacion de tipos...
-- 5) Tipos
CREATE OR REPLACE TYPE DETALLE_PEDIDO_REC AS OBJECT (
    COD_PROVEEDOR NUMBER,
    COD_PRODUCTO NUMBER,
    NOMBRE_PRODUCTO VARCHAR2(50),
    CANTIDAD_PRODUCTO NUMBER,
    PRECIO_COMPRA NUMBER
);
/
CREATE OR REPLACE TYPE DETALLE_PEDIDO_TAB AS TABLE OF DETALLE_PEDIDO_REC;
/
CREATE OR REPLACE TYPE DETALLE_VENTA_REC AS OBJECT (
    COD_PRODUCTO NUMBER,
    CANTIDAD NUMBER,
    PRECIO_PRODUCTO NUMBER
);
/
CREATE OR REPLACE TYPE DETALLE_VENTA_TAB AS TABLE OF DETALLE_VENTA_REC;
/
CREATE OR REPLACE TYPE DETALLE_ESTADIA_REC AS OBJECT (
    COD_HABITACION NUMBER,
    FECHA_ESTADIA DATE,
    DIAS NUMBER,
    PRECIO_HABITACION NUMBER
);
/
CREATE OR REPLACE TYPE DETALLE_ESTADIA_TAB AS TABLE OF DETALLE_ESTADIA_REC;
/

PROMPT Creacion de procedimientos / funciones / paquetes...
-- 6) Procedimientos / Funciones / Paquetes
-- CRUD usuario
CREATE OR REPLACE PROCEDURE CRUD_USUARIO(
    OPCION_P IN VARCHAR2,
    COD_USUARIO_P IN NUMBER,
    NOMBRE_USUARIO_P IN VARCHAR2,
    APELLIDO1_USUARIO_P IN VARCHAR2,
    APELLIDO2_USUARIO_P IN VARCHAR2,
    EMAIL_USUARIO_P IN VARCHAR2,
    TELEFONO_USUARIO_P IN NUMBER,
    CONTRASENA_HASH_P IN VARCHAR2,
    COD_ESTADO_USUARIO_P IN NUMBER,
    CUR_USUARIO OUT SYS_REFCURSOR
)
IS
BEGIN
    CASE UPPER(OPCION_P)
        WHEN 'C' THEN
            INSERT INTO JRGY_USUARIO(COD_USUARIO, NOMBRE_USUARIO, APELLIDO1_USUARIO, APELLIDO2_USUARIO, EMAIL_USUARIO, TELEFONO_USUARIO, CONTRASENA_HASH, COD_ESTADO_USUARIO)
            VALUES (COD_USUARIO_P, NOMBRE_USUARIO_P, APELLIDO1_USUARIO_P, APELLIDO2_USUARIO_P, EMAIL_USUARIO_P, TELEFONO_USUARIO_P, CONTRASENA_HASH_P, COD_ESTADO_USUARIO_P);

        WHEN 'R' THEN
            OPEN CUR_USUARIO FOR
                SELECT COD_USUARIO, NOMBRE_USUARIO, APELLIDO1_USUARIO, APELLIDO2_USUARIO, EMAIL_USUARIO, TELEFONO_USUARIO, CONTRASENA_HASH, COD_ESTADO_USUARIO
                FROM JRGY_USUARIO
                WHERE COD_USUARIO = COD_USUARIO_P;

        WHEN 'U' THEN
            UPDATE JRGY_USUARIO
            SET NOMBRE_USUARIO      = NOMBRE_USUARIO_P,
                APELLIDO1_USUARIO   = APELLIDO1_USUARIO_P,
                APELLIDO2_USUARIO   = APELLIDO2_USUARIO_P,
                EMAIL_USUARIO       = EMAIL_USUARIO_P,
                TELEFONO_USUARIO    = TELEFONO_USUARIO_P,
                CONTRASENA_HASH     = CONTRASENA_HASH_P,
                COD_ESTADO_USUARIO  = COD_ESTADO_USUARIO_P
            WHERE COD_USUARIO = COD_USUARIO_P;
            IF SQL%ROWCOUNT = 0 THEN
                RAISE_APPLICATION_ERROR(-343, 'NO SE ENCONTRO EL CLIENTE');
            END IF;

        WHEN 'D' THEN
            DELETE FROM JRGY_USUARIO WHERE COD_USUARIO = COD_USUARIO_P;
            IF SQL%ROWCOUNT = 0 THEN
                RAISE_APPLICATION_ERROR(-343, 'NO SE ENCONTRO EL CLIENTE');
            END IF;

        ELSE
            RAISE_APPLICATION_ERROR(-2003, 'INGRESE C R U D');
    END CASE;
END;
/

-- CRUD empleado
CREATE OR REPLACE PROCEDURE CRUD_EMPLEADO(
    OPCION_P IN VARCHAR2,
    COD_EMPLEADO_P IN NUMBER,
    CARGO_EMPLEADO_P IN VARCHAR2,
    FECHA_CONTRATACION_P IN DATE,
    SALARIO_P IN NUMBER,
    COMISION_P IN NUMBER,
    COD_USUARIO_P IN NUMBER,
    NOMBRE_USUARIO_P IN VARCHAR2,
    APELLIDO1_USUARIO_P IN VARCHAR2,
    APELLIDO2_USUARIO_P IN VARCHAR2,
    EMAIL_USUARIO_P IN VARCHAR2,
    TELEFONO_USUARIO_P IN NUMBER,
    CONTRASENA_HASH_P IN VARCHAR2,
    COD_ESTADO_USUARIO_P IN NUMBER,
    COD_DEPARTAMENTO_P IN NUMBER,
    COD_ESTADO_LABORAL_P IN NUMBER,
    CUR_EMPLEADO OUT SYS_REFCURSOR
)
IS
    V_COD_USUARIO NUMBER := COD_USUARIO_P;
    CUR_USUARIO SYS_REFCURSOR;
BEGIN
    CASE UPPER(OPCION_P)
        WHEN 'C' THEN
            IF V_COD_USUARIO IS NULL THEN
                RAISE_APPLICATION_ERROR(-20001, 'COD_USUARIO requerido (RUT) sin autoincremento');
            END IF;

            CRUD_USUARIO(
                'C',
                V_COD_USUARIO,
                NOMBRE_USUARIO_P,
                APELLIDO1_USUARIO_P,
                APELLIDO2_USUARIO_P,
                EMAIL_USUARIO_P,
                TELEFONO_USUARIO_P,
                CONTRASENA_HASH_P,
                COD_ESTADO_USUARIO_P,
                CUR_USUARIO
            );

            INSERT INTO JRGY_EMPLEADO(COD_EMPLEADO, COD_USUARIO, COD_DEPARTAMENTO, CARGO, FECHA_CONTRATACION, SALARIO, COMISION, COD_ESTADO_LABORAL)
            VALUES (COD_EMPLEADO_P, V_COD_USUARIO, COD_DEPARTAMENTO_P, CARGO_EMPLEADO_P, FECHA_CONTRATACION_P, SALARIO_P, COMISION_P, COD_ESTADO_LABORAL_P);

        WHEN 'R' THEN
            OPEN CUR_EMPLEADO FOR
                SELECT E.COD_EMPLEADO,
                       E.CARGO,
                       E.FECHA_CONTRATACION,
                       E.SALARIO,
                       E.COMISION,
                       U.COD_USUARIO,
                       U.NOMBRE_USUARIO,
                       U.APELLIDO1_USUARIO,
                       U.APELLIDO2_USUARIO,
                       U.EMAIL_USUARIO,
                       U.TELEFONO_USUARIO
                FROM JRGY_EMPLEADO E
                JOIN JRGY_USUARIO U ON U.COD_USUARIO = E.COD_USUARIO
                WHERE E.COD_EMPLEADO = COD_EMPLEADO_P;

        WHEN 'U' THEN
            CRUD_USUARIO(
                'U',
                V_COD_USUARIO,
                NOMBRE_USUARIO_P,
                APELLIDO1_USUARIO_P,
                APELLIDO2_USUARIO_P,
                EMAIL_USUARIO_P,
                TELEFONO_USUARIO_P,
                CONTRASENA_HASH_P,
                COD_ESTADO_USUARIO_P,
                CUR_USUARIO
            );

            UPDATE JRGY_EMPLEADO
            SET CARGO             = CARGO_EMPLEADO_P,
                FECHA_CONTRATACION = FECHA_CONTRATACION_P,
                SALARIO            = SALARIO_P,
                COMISION           = COMISION_P,
                COD_DEPARTAMENTO   = COD_DEPARTAMENTO_P,
                COD_ESTADO_LABORAL = COD_ESTADO_LABORAL_P
            WHERE COD_EMPLEADO = COD_EMPLEADO_P;
            IF SQL%ROWCOUNT = 0 THEN
                RAISE_APPLICATION_ERROR(-342, 'NO SE ENCONTRO EL EMPLEADO');
            END IF;

        WHEN 'D' THEN
            DELETE FROM JRGY_EMPLEADO WHERE COD_EMPLEADO = COD_EMPLEADO_P;
            IF SQL%ROWCOUNT = 0 THEN
                RAISE_APPLICATION_ERROR(-342, 'NO SE ENCONTRO EL EMPLEADO');
            END IF;

            CRUD_USUARIO(
                'D',
                V_COD_USUARIO,
                NULL,
                NULL,
                NULL,
                NULL,
                NULL,
                NULL,
                NULL,
                CUR_USUARIO
            );

        ELSE
            RAISE_APPLICATION_ERROR(-2003, 'INGRESE C R U D');
    END CASE;
END;
/

-- CRUD producto
CREATE OR REPLACE PROCEDURE CRUD_PRODUCTO(
    OPCION_P IN VARCHAR2,
    COD_PRODUCTO_P IN NUMBER,
    NOMBRE_PRODUCTO_P IN VARCHAR2,
    TIPO_PRODUCTO_P IN VARCHAR2,
    PRECIO_PRODUCTO_P IN NUMBER,
    CANTIDAD_PRODUCTO_P IN NUMBER,
    STOCK_PRODUCTO_P IN NUMBER,
    CUR_PRODUCTO OUT SYS_REFCURSOR
)
IS
BEGIN
    CASE UPPER(OPCION_P)
        WHEN 'C' THEN
            INSERT INTO JRGY_PRODUCTO(COD_PRODUCTO, NOMBRE_PRODUCTO, TIPO_PRODUCTO, PRECIO_PRODUCTO, CANTIDAD_PRODUCTO, STOCK_PRODUCTO)
            VALUES (COD_PRODUCTO_P, NOMBRE_PRODUCTO_P, TIPO_PRODUCTO_P, PRECIO_PRODUCTO_P, CANTIDAD_PRODUCTO_P, STOCK_PRODUCTO_P);

        WHEN 'R' THEN
            OPEN CUR_PRODUCTO FOR
                SELECT COD_PRODUCTO, NOMBRE_PRODUCTO, TIPO_PRODUCTO, PRECIO_PRODUCTO, CANTIDAD_PRODUCTO, STOCK_PRODUCTO
                FROM JRGY_PRODUCTO
                WHERE COD_PRODUCTO = COD_PRODUCTO_P;

        WHEN 'U' THEN
            UPDATE JRGY_PRODUCTO
            SET NOMBRE_PRODUCTO   = NOMBRE_PRODUCTO_P,
                TIPO_PRODUCTO     = TIPO_PRODUCTO_P,
                PRECIO_PRODUCTO   = PRECIO_PRODUCTO_P,
                CANTIDAD_PRODUCTO = CANTIDAD_PRODUCTO_P,
                STOCK_PRODUCTO    = STOCK_PRODUCTO_P
            WHERE COD_PRODUCTO = COD_PRODUCTO_P;
            IF SQL%ROWCOUNT = 0 THEN
                RAISE_APPLICATION_ERROR(-343, 'NO SE ENCONTRO EL PRODUCTO');
            END IF;

        WHEN 'D' THEN
            DELETE FROM JRGY_PRODUCTO WHERE COD_PRODUCTO = COD_PRODUCTO_P;
            IF SQL%ROWCOUNT = 0 THEN
                RAISE_APPLICATION_ERROR(-343, 'NO SE ENCONTRO EL PRODUCTO');
            END IF;

        ELSE
            RAISE_APPLICATION_ERROR(-2003, 'INGRESE C R U D');
    END CASE;
END;
/

-- Autenticacion simple
CREATE OR REPLACE PROCEDURE JRGY_PRO_LOGIN(
    EMAIL_P IN VARCHAR2,
    CONTRASENA_P IN VARCHAR2,
    CUR_LOGIN OUT SYS_REFCURSOR
)
IS
    V_COUNT NUMBER;
BEGIN
    SELECT COUNT(*) INTO V_COUNT
    FROM JRGY_USUARIO
    WHERE EMAIL_USUARIO = EMAIL_P
      AND CONTRASENA_HASH = CONTRASENA_P;

    IF V_COUNT = 0 THEN
        RAISE_APPLICATION_ERROR(-20060, 'CREDENCIALES INVALIDAS');
    END IF;

    OPEN CUR_LOGIN FOR
        SELECT U.COD_USUARIO,
               U.NOMBRE_USUARIO,
               U.APELLIDO1_USUARIO,
               U.APELLIDO2_USUARIO,
               U.EMAIL_USUARIO,
               UR.COD_ROL
        FROM JRGY_USUARIO U
        LEFT JOIN JRGY_USUARIO_ROL UR ON UR.COD_USUARIO = U.COD_USUARIO
        WHERE U.EMAIL_USUARIO = EMAIL_P
          AND U.CONTRASENA_HASH = CONTRASENA_P;
END;
/

-- Manejo de pedidos
CREATE OR REPLACE PROCEDURE JRGY_PRO_INSERT_PEDIDO (
    COD_EMPLEADO_P IN JRGY_PEDIDO.COD_EMPLEADO%TYPE,
    DETALLES_P IN DETALLE_PEDIDO_TAB,
    COD_PEDIDO_OUT OUT JRGY_PEDIDO.COD_PEDIDO%TYPE
)
IS
    V_COD_PEDIDO JRGY_PEDIDO.COD_PEDIDO%TYPE;
    V_VALOR_TOTAL JRGY_PEDIDO.VALOR_TOTAL%TYPE := 0;
BEGIN
    V_COD_PEDIDO := SQ_PK_PEDIDO.NEXTVAL;

    FOR I IN 1 .. DETALLES_P.COUNT LOOP
        V_VALOR_TOTAL := V_VALOR_TOTAL + (DETALLES_P(I).CANTIDAD_PRODUCTO * DETALLES_P(I).PRECIO_COMPRA);
    END LOOP;

    INSERT INTO JRGY_PEDIDO (COD_PEDIDO, VALOR_TOTAL, FECHA_PEDIDO, COD_EMPLEADO)
    VALUES (V_COD_PEDIDO, V_VALOR_TOTAL, SYSDATE, COD_EMPLEADO_P);

    FOR I IN 1 .. DETALLES_P.COUNT LOOP
        INSERT INTO JRGY_DETALLE_PEDIDO (COD_PEDIDO, COD_PROVEEDOR, COD_PRODUCTO, NOMBRE_PRODUCTO, CANTIDAD_PRODUCTO, PRECIO_COMPRA, PRECIO_TOTAL)
        VALUES (
            V_COD_PEDIDO,
            DETALLES_P(I).COD_PROVEEDOR,
            DETALLES_P(I).COD_PRODUCTO,
            DETALLES_P(I).NOMBRE_PRODUCTO,
            DETALLES_P(I).CANTIDAD_PRODUCTO,
            DETALLES_P(I).PRECIO_COMPRA,
            DETALLES_P(I).CANTIDAD_PRODUCTO * DETALLES_P(I).PRECIO_COMPRA
        );

    END LOOP;

    COD_PEDIDO_OUT := V_COD_PEDIDO;
    COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE_APPLICATION_ERROR(-20011, 'Error al insertar el pedido: ' || SQLERRM);
END JRGY_PRO_INSERT_PEDIDO;
/

CREATE OR REPLACE PACKAGE PKG_PEDIDO IS
    TYPE CURSOR_P IS REF CURSOR;
    PROCEDURE JRGY_PRO_GET_PEDIDO_DETALLE (
        COD_PEDIDO_P IN JRGY_PEDIDO.COD_PEDIDO%TYPE,
        CURSOR_P OUT CURSOR_P
    );
END PKG_PEDIDO;
/

CREATE OR REPLACE PACKAGE BODY PKG_PEDIDO IS
    PROCEDURE JRGY_PRO_GET_PEDIDO_DETALLE (
        COD_PEDIDO_P IN JRGY_PEDIDO.COD_PEDIDO%TYPE,
        CURSOR_P OUT CURSOR_P
    ) IS
    BEGIN
        OPEN CURSOR_P FOR
            SELECT P.COD_PEDIDO,
                   P.FECHA_PEDIDO,
                   P.VALOR_TOTAL AS VALOR_TOTAL_PEDIDO,
                   DP.COD_PROVEEDOR,
                   DP.NOMBRE_PRODUCTO,
                   DP.CANTIDAD_PRODUCTO,
                   DP.PRECIO_COMPRA,
                   DP.PRECIO_TOTAL AS VALOR_TOTAL_DETALLE
            FROM JRGY_PEDIDO P
            JOIN JRGY_DETALLE_PEDIDO DP ON DP.COD_PEDIDO = P.COD_PEDIDO
            WHERE P.COD_PEDIDO = COD_PEDIDO_P;
    END JRGY_PRO_GET_PEDIDO_DETALLE;
END PKG_PEDIDO;
/

CREATE OR REPLACE PROCEDURE JRGY_PRO_UPDATE_PEDIDO_TOTAL (
    COD_PEDIDO_P IN JRGY_PEDIDO.COD_PEDIDO%TYPE
)
IS
    NUEVO_TOTAL JRGY_PEDIDO.VALOR_TOTAL%TYPE;
BEGIN
    SELECT NVL(SUM(PRECIO_TOTAL), 0)
    INTO NUEVO_TOTAL
    FROM JRGY_DETALLE_PEDIDO
    WHERE COD_PEDIDO = COD_PEDIDO_P;

    UPDATE JRGY_PEDIDO
    SET VALOR_TOTAL = NUEVO_TOTAL
    WHERE COD_PEDIDO = COD_PEDIDO_P;

    IF SQL%ROWCOUNT = 0 THEN
        RAISE_APPLICATION_ERROR(-20012, 'Pedido con código ' || COD_PEDIDO_P || ' no encontrado.');
    END IF;

    COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE_APPLICATION_ERROR(-20013, 'Error al recalcular y actualizar total del pedido: ' || SQLERRM);
END JRGY_PRO_UPDATE_PEDIDO_TOTAL;
/

CREATE OR REPLACE PROCEDURE JRGY_PRO_DELETE_PEDIDO (
    COD_PEDIDO_P IN JRGY_PEDIDO.COD_PEDIDO%TYPE
)
IS
    PEDIDOS_ELIMINADOS NUMBER;
BEGIN
    DELETE FROM JRGY_PEDIDO WHERE COD_PEDIDO = COD_PEDIDO_P;
    PEDIDOS_ELIMINADOS := SQL%ROWCOUNT;

    IF PEDIDOS_ELIMINADOS = 0 THEN
        RAISE_APPLICATION_ERROR(-20014, 'Pedido con código ' || COD_PEDIDO_P || ' no encontrado para eliminar.');
    END IF;

    COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE_APPLICATION_ERROR(-20015, 'Error al eliminar el pedido: ' || SQLERRM);
END JRGY_PRO_DELETE_PEDIDO;
/

-- Servicios (amenities)
CREATE OR REPLACE PROCEDURE JRGY_PRO_SERVICIO_LISTAR(
    P_INCLUDE_INACTIVE IN NUMBER,
    CUR_SERVICIOS OUT SYS_REFCURSOR
)
IS
BEGIN
    OPEN CUR_SERVICIOS FOR
        SELECT
            COD_SERVICIO,
            NOMBRE,
            DESCRIPCION,
            PRECIO,
            TIPO,
            ESTADO,
            ES_DESTACADO,
            ORDEN,
            CREATED_AT,
            UPDATED_AT
        FROM JRGY_SERVICIO
        WHERE (P_INCLUDE_INACTIVE = 1 OR LOWER(ESTADO) = 'activo')
        ORDER BY NVL(ES_DESTACADO, 'N') DESC, NVL(ORDEN, 9999), COD_SERVICIO;
END;
/

CREATE OR REPLACE PROCEDURE JRGY_PRO_SERVICIO_CREAR(
    P_NOMBRE IN VARCHAR2,
    P_DESCRIPCION IN VARCHAR2,
    P_PRECIO IN NUMBER,
    P_TIPO IN VARCHAR2,
    P_ESTADO IN VARCHAR2,
    P_DESTACADO IN CHAR,
    P_ORDEN IN NUMBER,
    P_HORARIOS_JSON IN CLOB,
    P_ID OUT NUMBER
)
IS
    V_EXPECTED NUMBER := 0;
    V_INSERTED NUMBER := 0;
BEGIN
    INSERT INTO JRGY_SERVICIO (
        NOMBRE, DESCRIPCION, PRECIO, TIPO, ESTADO, ES_DESTACADO, ORDEN, CREATED_AT
    ) VALUES (
        P_NOMBRE, P_DESCRIPCION, P_PRECIO, P_TIPO, P_ESTADO, P_DESTACADO, P_ORDEN, SYSDATE
    )
    RETURNING COD_SERVICIO INTO P_ID;

    IF P_HORARIOS_JSON IS NOT NULL THEN
        SELECT COUNT(*) INTO V_EXPECTED
        FROM JSON_TABLE(
            P_HORARIOS_JSON,
            '$[*]' COLUMNS(
                HORA_INICIO NUMBER PATH '$.inicio',
                HORA_FIN NUMBER PATH '$.fin'
            )
        );

        INSERT INTO JRGY_SERVICIO_HORARIO (COD_SERVICIO, HORA_INICIO, HORA_FIN)
        SELECT P_ID, HORA_INICIO, HORA_FIN
        FROM JSON_TABLE(
            P_HORARIOS_JSON,
            '$[*]' COLUMNS(
                HORA_INICIO NUMBER PATH '$.inicio',
                HORA_FIN NUMBER PATH '$.fin'
            )
        )
        WHERE HORA_INICIO BETWEEN 0 AND 23.99
          AND HORA_FIN BETWEEN 0 AND 23.99
          AND HORA_FIN >= HORA_INICIO;

        SELECT COUNT(*) INTO V_INSERTED FROM JRGY_SERVICIO_HORARIO WHERE COD_SERVICIO = P_ID;

        IF V_EXPECTED <> V_INSERTED THEN
            RAISE_APPLICATION_ERROR(-20081, 'HORARIO INVALIDO, USE HORAS 0-23 Y FIN >= INICIO');
        END IF;
    END IF;

    COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE;
END;
/

CREATE OR REPLACE PROCEDURE JRGY_PRO_SERVICIO_ACTUALIZAR(
    P_ID IN NUMBER,
    P_NOMBRE IN VARCHAR2,
    P_DESCRIPCION IN VARCHAR2,
    P_PRECIO IN NUMBER,
    P_TIPO IN VARCHAR2,
    P_ESTADO IN VARCHAR2,
    P_DESTACADO IN CHAR,
    P_ORDEN IN NUMBER,
    P_HORARIOS_JSON IN CLOB
)
IS
    V_EXPECTED NUMBER := 0;
    V_INSERTED NUMBER := 0;
BEGIN
    UPDATE JRGY_SERVICIO
    SET NOMBRE = P_NOMBRE,
        DESCRIPCION = P_DESCRIPCION,
        PRECIO = P_PRECIO,
        TIPO = P_TIPO,
        ESTADO = P_ESTADO,
        ES_DESTACADO = P_DESTACADO,
        ORDEN = P_ORDEN,
        UPDATED_AT = SYSDATE
    WHERE COD_SERVICIO = P_ID;

    IF SQL%ROWCOUNT = 0 THEN
        RAISE_APPLICATION_ERROR(-20082, 'SERVICIO NO ENCONTRADO');
    END IF;

    DELETE FROM JRGY_SERVICIO_HORARIO WHERE COD_SERVICIO = P_ID;

    IF P_HORARIOS_JSON IS NOT NULL THEN
        SELECT COUNT(*) INTO V_EXPECTED
        FROM JSON_TABLE(
            P_HORARIOS_JSON,
            '$[*]' COLUMNS(
                HORA_INICIO NUMBER PATH '$.inicio',
                HORA_FIN NUMBER PATH '$.fin'
            )
        );

        INSERT INTO JRGY_SERVICIO_HORARIO (COD_SERVICIO, HORA_INICIO, HORA_FIN)
        SELECT P_ID, HORA_INICIO, HORA_FIN
        FROM JSON_TABLE(
            P_HORARIOS_JSON,
            '$[*]' COLUMNS(
                HORA_INICIO NUMBER PATH '$.inicio',
                HORA_FIN NUMBER PATH '$.fin'
            )
        )
        WHERE HORA_INICIO BETWEEN 0 AND 23.99
          AND HORA_FIN BETWEEN 0 AND 23.99
          AND HORA_FIN >= HORA_INICIO;

        SELECT COUNT(*) INTO V_INSERTED FROM JRGY_SERVICIO_HORARIO WHERE COD_SERVICIO = P_ID;

        IF V_EXPECTED <> V_INSERTED THEN
            RAISE_APPLICATION_ERROR(-20081, 'HORARIO INVALIDO, USE HORAS 0-23 Y FIN >= INICIO');
        END IF;
    END IF;

    COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE;
END;
/

CREATE OR REPLACE PROCEDURE JRGY_PRO_SERVICIO_ELIMINAR(
    P_ID IN NUMBER
)
IS
BEGIN
    UPDATE JRGY_SERVICIO
    SET ESTADO = 'inactivo',
        UPDATED_AT = SYSDATE
    WHERE COD_SERVICIO = P_ID;

    IF SQL%ROWCOUNT = 0 THEN
        RAISE_APPLICATION_ERROR(-20083, 'SERVICIO NO ENCONTRADO');
    END IF;

    COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE;
END;
/

CREATE OR REPLACE PROCEDURE JRGY_PRO_SERVICIO_CAMBIAR_ESTADO(
    P_ID IN NUMBER,
    P_ESTADO IN VARCHAR2
)
IS
BEGIN
    UPDATE JRGY_SERVICIO
    SET ESTADO = LOWER(P_ESTADO),
        UPDATED_AT = SYSDATE
    WHERE COD_SERVICIO = P_ID;

    IF SQL%ROWCOUNT = 0 THEN
        RAISE_APPLICATION_ERROR(-20082, 'SERVICIO NO ENCONTRADO');
    END IF;

    COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE;
END;
/

CREATE OR REPLACE PROCEDURE JRGY_PRO_SERVICIO_BORRAR(
    P_ID IN NUMBER
)
IS
    V_COUNT_RES NUMBER := 0;
BEGIN
    SELECT COUNT(*) INTO V_COUNT_RES FROM JRGY_RESERVA_SERVICIO WHERE COD_SERVICIO = P_ID;
    IF V_COUNT_RES > 0 THEN
        RAISE_APPLICATION_ERROR(-20098, 'NO SE PUEDE ELIMINAR: SERVICIO TIENE RESERVAS ASOCIADAS');
    END IF;

    DELETE FROM JRGY_SERVICIO_HORARIO WHERE COD_SERVICIO = P_ID;
    DELETE FROM JRGY_SERVICIO WHERE COD_SERVICIO = P_ID;

    IF SQL%ROWCOUNT = 0 THEN
        RAISE_APPLICATION_ERROR(-20082, 'SERVICIO NO ENCONTRADO');
    END IF;

    COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE;
END;
/

-- Categorías combinadas de servicios y productos
CREATE OR REPLACE PROCEDURE JRGY_PRO_CAT_SERVPROD_LISTAR(
    CUR_CATS OUT SYS_REFCURSOR
)
IS
BEGIN
    OPEN CUR_CATS FOR
        SELECT TIPO, SUM(SERVICIOS) AS SERVICIOS, SUM(PRODUCTOS) AS PRODUCTOS
        FROM (
            SELECT NVL(UPPER(TRIM(TIPO)), 'SIN_TIPO') AS TIPO, COUNT(*) AS SERVICIOS, 0 AS PRODUCTOS
            FROM JRGY_SERVICIO
            GROUP BY NVL(UPPER(TRIM(TIPO)), 'SIN_TIPO')
            UNION ALL
            SELECT NVL(UPPER(TRIM(TIPO_PRODUCTO)), 'SIN_TIPO') AS TIPO, 0 AS SERVICIOS, COUNT(*) AS PRODUCTOS
            FROM JRGY_PRODUCTO
            GROUP BY NVL(UPPER(TRIM(TIPO_PRODUCTO)), 'SIN_TIPO')
        )
        GROUP BY TIPO
        ORDER BY TIPO;
END;
/

CREATE OR REPLACE PROCEDURE JRGY_PRO_SERVICIO_HORARIOS_LISTAR(
    CUR_HOR OUT SYS_REFCURSOR
)
IS
BEGIN
    OPEN CUR_HOR FOR
        SELECT COD_HORARIO, COD_SERVICIO, HORA_INICIO, HORA_FIN
        FROM JRGY_SERVICIO_HORARIO
        ORDER BY COD_SERVICIO, HORA_INICIO;
END;
/

CREATE OR REPLACE PROCEDURE JRGY_PRO_SERVICIO_OBTENER(
    P_ID IN NUMBER,
    CUR_SERV OUT SYS_REFCURSOR,
    CUR_HOR OUT SYS_REFCURSOR
)
IS
BEGIN
    OPEN CUR_SERV FOR
        SELECT
            COD_SERVICIO,
            NOMBRE,
            DESCRIPCION,
            PRECIO,
            TIPO,
            ESTADO,
            ES_DESTACADO,
            ORDEN,
            CREATED_AT,
            UPDATED_AT
        FROM JRGY_SERVICIO
        WHERE COD_SERVICIO = P_ID;

    OPEN CUR_HOR FOR
        SELECT COD_HORARIO, COD_SERVICIO, HORA_INICIO, HORA_FIN
        FROM JRGY_SERVICIO_HORARIO
        WHERE COD_SERVICIO = P_ID
        ORDER BY HORA_INICIO;
END;
/

-- Habitaciones CRUD
CREATE OR REPLACE PROCEDURE JRGY_PRO_HAB_OBTENER(
    P_ID IN NUMBER,
    CUR_HAB OUT SYS_REFCURSOR
)
IS
BEGIN
    OPEN CUR_HAB FOR
        SELECT
            h.COD_HABITACION AS ID,
            h.NRO_HABITACION AS NUMERO,
            h.CAPACIDAD,
            h.PRECIO_BASE,
            th.TIPO_HABITACION AS TIPO,
            eh.ESTADO_HABITACION AS ESTADO
        FROM JRGY_HABITACION h
        LEFT JOIN JRGY_CAT_TIPO_HABITACION th ON th.COD_TIPO_HABITACION = h.COD_TIPO_HABITACION
        LEFT JOIN JRGY_CAT_ESTADO_HABITACION eh ON eh.COD_ESTADO_HABITACION = h.COD_ESTADO_HABITACION
        WHERE h.COD_HABITACION = P_ID;
END;
/

CREATE OR REPLACE PROCEDURE JRGY_PRO_HAB_CREAR(
    P_NUMERO IN NUMBER,
    P_CAPACIDAD IN NUMBER,
    P_PRECIO_BASE IN NUMBER,
    P_TIPO_NOMBRE IN VARCHAR2,
    P_ESTADO_NOMBRE IN VARCHAR2,
    P_ID OUT NUMBER
)
IS
    V_TIPO_ID NUMBER;
    V_ESTADO_ID NUMBER;
    V_DUP NUMBER;
BEGIN
    SELECT COUNT(*) INTO V_DUP FROM JRGY_HABITACION WHERE NRO_HABITACION = P_NUMERO;
    IF V_DUP > 0 THEN
        RAISE_APPLICATION_ERROR(-20100, 'NUMERO DE HABITACION YA EXISTE');
    END IF;

    SELECT COD_TIPO_HABITACION INTO V_TIPO_ID
    FROM JRGY_CAT_TIPO_HABITACION
    WHERE UPPER(TIPO_HABITACION) = UPPER(P_TIPO_NOMBRE);

    SELECT COD_ESTADO_HABITACION INTO V_ESTADO_ID
    FROM JRGY_CAT_ESTADO_HABITACION
    WHERE UPPER(ESTADO_HABITACION) = UPPER(P_ESTADO_NOMBRE);

    INSERT INTO JRGY_HABITACION (
        NRO_HABITACION, CAPACIDAD, PRECIO_BASE, COD_TIPO_HABITACION, COD_ESTADO_HABITACION
    ) VALUES (
        P_NUMERO, P_CAPACIDAD, P_PRECIO_BASE, V_TIPO_ID, V_ESTADO_ID
    )
    RETURNING COD_HABITACION INTO P_ID;

    COMMIT;
EXCEPTION
    WHEN NO_DATA_FOUND THEN
        ROLLBACK;
        RAISE_APPLICATION_ERROR(-20102, 'TIPO O ESTADO DE HABITACION NO ENCONTRADO');
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE;
END;
/

CREATE OR REPLACE PROCEDURE JRGY_PRO_HAB_ACTUALIZAR(
    P_ID IN NUMBER,
    P_NUMERO IN NUMBER,
    P_CAPACIDAD IN NUMBER,
    P_PRECIO_BASE IN NUMBER,
    P_TIPO_NOMBRE IN VARCHAR2,
    P_ESTADO_NOMBRE IN VARCHAR2
)
IS
    V_TIPO_ID NUMBER;
    V_ESTADO_ID NUMBER;
    V_DUP NUMBER;
BEGIN
    SELECT COUNT(*) INTO V_DUP FROM JRGY_HABITACION WHERE NRO_HABITACION = P_NUMERO AND COD_HABITACION <> P_ID;
    IF V_DUP > 0 THEN
        RAISE_APPLICATION_ERROR(-20100, 'NUMERO DE HABITACION YA EXISTE');
    END IF;

    SELECT COD_TIPO_HABITACION INTO V_TIPO_ID
    FROM JRGY_CAT_TIPO_HABITACION
    WHERE UPPER(TIPO_HABITACION) = UPPER(P_TIPO_NOMBRE);

    SELECT COD_ESTADO_HABITACION INTO V_ESTADO_ID
    FROM JRGY_CAT_ESTADO_HABITACION
    WHERE UPPER(ESTADO_HABITACION) = UPPER(P_ESTADO_NOMBRE);

    UPDATE JRGY_HABITACION
    SET NRO_HABITACION = P_NUMERO,
        CAPACIDAD = P_CAPACIDAD,
        PRECIO_BASE = P_PRECIO_BASE,
        COD_TIPO_HABITACION = V_TIPO_ID,
        COD_ESTADO_HABITACION = V_ESTADO_ID
    WHERE COD_HABITACION = P_ID;

    IF SQL%ROWCOUNT = 0 THEN
        RAISE_APPLICATION_ERROR(-20103, 'HABITACION NO ENCONTRADA');
    END IF;

    COMMIT;
EXCEPTION
    WHEN NO_DATA_FOUND THEN
        ROLLBACK;
        RAISE_APPLICATION_ERROR(-20102, 'TIPO O ESTADO DE HABITACION NO ENCONTRADO');
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE;
END;
/

CREATE OR REPLACE PROCEDURE JRGY_PRO_HAB_CAMBIAR_ESTADO(
    P_ID IN NUMBER,
    P_ESTADO_NOMBRE IN VARCHAR2
)
IS
    V_ESTADO_ID NUMBER;
BEGIN
    SELECT COD_ESTADO_HABITACION INTO V_ESTADO_ID
    FROM JRGY_CAT_ESTADO_HABITACION
    WHERE UPPER(ESTADO_HABITACION) = UPPER(P_ESTADO_NOMBRE);

    UPDATE JRGY_HABITACION
    SET COD_ESTADO_HABITACION = V_ESTADO_ID
    WHERE COD_HABITACION = P_ID;

    IF SQL%ROWCOUNT = 0 THEN
        RAISE_APPLICATION_ERROR(-20103, 'HABITACION NO ENCONTRADA');
    END IF;

    COMMIT;
EXCEPTION
    WHEN NO_DATA_FOUND THEN
        ROLLBACK;
        RAISE_APPLICATION_ERROR(-20102, 'ESTADO DE HABITACION NO ENCONTRADO');
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE;
END;
/

CREATE OR REPLACE PROCEDURE JRGY_PRO_HAB_BORRAR(
    P_ID IN NUMBER
)
IS
    V_COUNT_RES NUMBER := 0;
BEGIN
    SELECT COUNT(*) INTO V_COUNT_RES FROM JRGY_RESERVA WHERE COD_HABITACION = P_ID;
    IF V_COUNT_RES > 0 THEN
        RAISE_APPLICATION_ERROR(-20104, 'NO SE PUEDE ELIMINAR: HABITACION TIENE RESERVAS');
    END IF;

    DELETE FROM JRGY_HABITACION WHERE COD_HABITACION = P_ID;

    IF SQL%ROWCOUNT = 0 THEN
        RAISE_APPLICATION_ERROR(-20103, 'HABITACION NO ENCONTRADA');
    END IF;

    COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE;
END;
/

-- Reservas (creación/listado)
CREATE OR REPLACE PROCEDURE JRGY_PRO_RESERVA_LISTAR(
    P_USER_ID IN NUMBER,
    P_ES_ADMIN IN NUMBER,
    CUR_RESERVAS OUT SYS_REFCURSOR
)
IS
BEGIN
    IF P_ES_ADMIN = 1 THEN
        OPEN CUR_RESERVAS FOR
            SELECT
                r.COD_RESERVA,
                r.COD_USUARIO,
                r.COD_HABITACION,
                r.FECHA_INICIO,
                r.FECHA_FIN,
                r.HUESPEDES,
                r.TOTAL_HABITACION,
                r.TOTAL_SERVICIOS,
                r.TOTAL,
                r.COD_ESTADO_RESERVA,
                h.NRO_HABITACION,
                t.TIPO_HABITACION,
                e.ESTADO_RESERVA,
                u.NOMBRE_USUARIO,
                u.APELLIDO1_USUARIO,
                u.APELLIDO2_USUARIO,
                u.EMAIL_USUARIO
            FROM JRGY_RESERVA r
            LEFT JOIN JRGY_HABITACION h ON h.COD_HABITACION = r.COD_HABITACION
            LEFT JOIN JRGY_CAT_TIPO_HABITACION t ON t.COD_TIPO_HABITACION = h.COD_TIPO_HABITACION
            LEFT JOIN JRGY_CAT_ESTADO_RESERVA e ON e.COD_ESTADO_RESERVA = r.COD_ESTADO_RESERVA
            LEFT JOIN JRGY_USUARIO u ON u.COD_USUARIO = r.COD_USUARIO
            ORDER BY r.FECHA_INICIO DESC;
    ELSE
        OPEN CUR_RESERVAS FOR
            SELECT
                r.COD_RESERVA,
                r.COD_USUARIO,
                r.COD_HABITACION,
                r.FECHA_INICIO,
                r.FECHA_FIN,
                r.HUESPEDES,
                r.TOTAL_HABITACION,
                r.TOTAL_SERVICIOS,
                r.TOTAL,
                r.COD_ESTADO_RESERVA,
                h.NRO_HABITACION,
                t.TIPO_HABITACION,
                e.ESTADO_RESERVA,
                u.NOMBRE_USUARIO,
                u.APELLIDO1_USUARIO,
                u.APELLIDO2_USUARIO,
                u.EMAIL_USUARIO
            FROM JRGY_RESERVA r
            LEFT JOIN JRGY_HABITACION h ON h.COD_HABITACION = r.COD_HABITACION
            LEFT JOIN JRGY_CAT_TIPO_HABITACION t ON t.COD_TIPO_HABITACION = h.COD_TIPO_HABITACION
            LEFT JOIN JRGY_CAT_ESTADO_RESERVA e ON e.COD_ESTADO_RESERVA = r.COD_ESTADO_RESERVA
            LEFT JOIN JRGY_USUARIO u ON u.COD_USUARIO = r.COD_USUARIO
            WHERE r.COD_USUARIO = P_USER_ID
            ORDER BY r.FECHA_INICIO DESC;
    END IF;
END;
/

CREATE OR REPLACE PROCEDURE JRGY_PRO_RESERVA_CREAR(
    P_USER_ID IN NUMBER,
    P_HAB_ID IN NUMBER,
    P_FECHA_INICIO IN DATE,
    P_FECHA_FIN IN DATE,
    P_HUESPEDES IN NUMBER,
    P_ID OUT NUMBER
)
IS
    V_CAPACIDAD NUMBER;
    V_PRECIO_BASE NUMBER;
    V_ESTADO_CREADA NUMBER;
    V_NOCHES NUMBER;
    V_TOTAL NUMBER;
BEGIN
    SELECT CAPACIDAD, PRECIO_BASE INTO V_CAPACIDAD, V_PRECIO_BASE
    FROM JRGY_HABITACION WHERE COD_HABITACION = P_HAB_ID;

    IF P_HUESPEDES > NVL(V_CAPACIDAD, 0) THEN
        RAISE_APPLICATION_ERROR(-20090, 'CAPACIDAD EXCEDIDA');
    END IF;

    SELECT COD_ESTADO_RESERVA INTO V_ESTADO_CREADA
    FROM JRGY_CAT_ESTADO_RESERVA
    WHERE UPPER(ESTADO_RESERVA) = 'CREADA';

    V_NOCHES := GREATEST(1, CEIL(P_FECHA_FIN - P_FECHA_INICIO));
    V_TOTAL := V_PRECIO_BASE * V_NOCHES;

    INSERT INTO JRGY_RESERVA(
        COD_USUARIO, COD_HABITACION, FECHA_INICIO, FECHA_FIN,
        HUESPEDES, TOTAL_HABITACION, TOTAL_SERVICIOS, TOTAL, COD_ESTADO_RESERVA, CREATED_AT
    ) VALUES (
        P_USER_ID, P_HAB_ID, P_FECHA_INICIO, P_FECHA_FIN,
        P_HUESPEDES, V_TOTAL, 0, V_TOTAL, V_ESTADO_CREADA, SYSDATE
    )
    RETURNING COD_RESERVA INTO P_ID;

    INSERT INTO JRGY_EVENTO_RESERVA (COD_RESERVA, TIPO_EVENTO, FECHA_EVENTO, NOTAS, CREATED_BY)
    VALUES (P_ID, 'CREADA', SYSDATE, 'Reserva creada', P_USER_ID);

    COMMIT;
EXCEPTION
    WHEN NO_DATA_FOUND THEN
        RAISE_APPLICATION_ERROR(-20091, 'HABITACION NO ENCONTRADA');
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE;
END;
/

-- Servicios asociados a reserva
CREATE OR REPLACE PROCEDURE JRGY_PRO_RESERVA_SERVICIO_LISTAR(
    P_RESERVA_ID IN NUMBER,
    CUR_SERV OUT SYS_REFCURSOR
)
IS
BEGIN
    OPEN CUR_SERV FOR
        SELECT
            rs.COD_RESERVA_SERVICIO,
            rs.COD_RESERVA,
            rs.COD_SERVICIO,
            s.NOMBRE,
            s.TIPO,
            rs.FECHA_SERVICIO,
            rs.HORA,
            rs.CANTIDAD,
            rs.PRECIO_UNIT,
            rs.TOTAL,
            rs.NOTA,
            rs.ESTADO,
            rs.CREATED_AT,
            rs.UPDATED_AT
        FROM JRGY_RESERVA_SERVICIO rs
        LEFT JOIN JRGY_SERVICIO s ON s.COD_SERVICIO = rs.COD_SERVICIO
        WHERE rs.COD_RESERVA = P_RESERVA_ID
        ORDER BY rs.FECHA_SERVICIO, rs.HORA;
END;
/

CREATE OR REPLACE PROCEDURE JRGY_PRO_RESERVA_SERVICIO_ADD(
    P_RESERVA_ID IN NUMBER,
    P_SERVICIO_ID IN NUMBER,
    P_FECHA_SERVICIO IN DATE,
    P_HORA IN NUMBER,
    P_CANTIDAD IN NUMBER,
    P_NOTA IN VARCHAR2,
    P_ID OUT NUMBER
)
IS
    V_PRECIO NUMBER;
    V_ESTADO_SERVICIO VARCHAR2(20);
    V_FI DATE;
    V_FF DATE;
    V_MATCH NUMBER := 0;
    V_TIENE_HORARIOS NUMBER := 0;
    V_TOTAL_SERV NUMBER;
BEGIN
    SELECT PRECIO, ESTADO INTO V_PRECIO, V_ESTADO_SERVICIO
    FROM JRGY_SERVICIO WHERE COD_SERVICIO = P_SERVICIO_ID;

    IF LOWER(V_ESTADO_SERVICIO) <> 'activo' THEN
        RAISE_APPLICATION_ERROR(-20084, 'SERVICIO INACTIVO');
    END IF;

    SELECT FECHA_INICIO, FECHA_FIN INTO V_FI, V_FF
    FROM JRGY_RESERVA WHERE COD_RESERVA = P_RESERVA_ID;

    IF P_FECHA_SERVICIO < V_FI OR P_FECHA_SERVICIO > V_FF THEN
        RAISE_APPLICATION_ERROR(-20085, 'FECHA FUERA DEL RANGO DE LA RESERVA');
    END IF;

    IF P_HORA < 0 OR P_HORA > 23 THEN
        RAISE_APPLICATION_ERROR(-20086, 'HORA INVALIDA');
    END IF;

    SELECT COUNT(*) INTO V_MATCH
    FROM JRGY_SERVICIO_HORARIO
    WHERE COD_SERVICIO = P_SERVICIO_ID
      AND P_HORA BETWEEN HORA_INICIO AND HORA_FIN;

    SELECT COUNT(*) INTO V_TIENE_HORARIOS FROM JRGY_SERVICIO_HORARIO WHERE COD_SERVICIO = P_SERVICIO_ID;

    IF V_TIENE_HORARIOS > 0 AND V_MATCH = 0 THEN
        RAISE_APPLICATION_ERROR(-20087, 'HORA FUERA DEL HORARIO PERMITIDO');
    END IF;

    INSERT INTO JRGY_RESERVA_SERVICIO(
        COD_RESERVA, COD_SERVICIO, FECHA_SERVICIO, HORA, CANTIDAD, PRECIO_UNIT, TOTAL, NOTA, ESTADO, CREATED_AT
    ) VALUES (
        P_RESERVA_ID, P_SERVICIO_ID, P_FECHA_SERVICIO, P_HORA, P_CANTIDAD, V_PRECIO, P_CANTIDAD * V_PRECIO, P_NOTA, 'pendiente', SYSDATE
    )
    RETURNING COD_RESERVA_SERVICIO INTO P_ID;

    SELECT NVL(SUM(TOTAL), 0) INTO V_TOTAL_SERV
    FROM JRGY_RESERVA_SERVICIO
    WHERE COD_RESERVA = P_RESERVA_ID AND LOWER(ESTADO) <> 'cancelado';

    UPDATE JRGY_RESERVA
    SET TOTAL_SERVICIOS = V_TOTAL_SERV,
        TOTAL = NVL(TOTAL_HABITACION, 0) + V_TOTAL_SERV,
        UPDATED_AT = SYSDATE
    WHERE COD_RESERVA = P_RESERVA_ID;

    COMMIT;
EXCEPTION
    WHEN NO_DATA_FOUND THEN
        RAISE_APPLICATION_ERROR(-20088, 'RESERVA O SERVICIO NO ENCONTRADO');
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE;
END;
/

CREATE OR REPLACE PROCEDURE JRGY_PRO_RESERVA_SERVICIO_UPD(
    P_ITEM_ID IN NUMBER,
    P_RESERVA_ID IN NUMBER,
    P_FECHA_SERVICIO IN DATE,
    P_HORA IN NUMBER,
    P_CANTIDAD IN NUMBER,
    P_NOTA IN VARCHAR2,
    P_ESTADO IN VARCHAR2
)
IS
    V_SERV_ID NUMBER;
    V_PRECIO NUMBER;
    V_FI DATE;
    V_FF DATE;
    V_MATCH NUMBER := 0;
    V_TIENE_HORARIOS NUMBER := 0;
    V_TOTAL_SERV NUMBER;
BEGIN
    SELECT COD_SERVICIO, PRECIO_UNIT INTO V_SERV_ID, V_PRECIO
    FROM JRGY_RESERVA_SERVICIO
    WHERE COD_RESERVA_SERVICIO = P_ITEM_ID AND COD_RESERVA = P_RESERVA_ID FOR UPDATE;

    SELECT FECHA_INICIO, FECHA_FIN INTO V_FI, V_FF
    FROM JRGY_RESERVA WHERE COD_RESERVA = P_RESERVA_ID;

    IF P_FECHA_SERVICIO < V_FI OR P_FECHA_SERVICIO > V_FF THEN
        RAISE_APPLICATION_ERROR(-20085, 'FECHA FUERA DEL RANGO DE LA RESERVA');
    END IF;

    IF P_HORA < 0 OR P_HORA > 23 THEN
        RAISE_APPLICATION_ERROR(-20086, 'HORA INVALIDA');
    END IF;

    SELECT COUNT(*) INTO V_MATCH
    FROM JRGY_SERVICIO_HORARIO
    WHERE COD_SERVICIO = V_SERV_ID
      AND P_HORA BETWEEN HORA_INICIO AND HORA_FIN;

    SELECT COUNT(*) INTO V_TIENE_HORARIOS FROM JRGY_SERVICIO_HORARIO WHERE COD_SERVICIO = V_SERV_ID;

    IF V_TIENE_HORARIOS > 0 AND V_MATCH = 0 THEN
        RAISE_APPLICATION_ERROR(-20087, 'HORA FUERA DEL HORARIO PERMITIDO');
    END IF;

    UPDATE JRGY_RESERVA_SERVICIO
    SET FECHA_SERVICIO = P_FECHA_SERVICIO,
        HORA = P_HORA,
        CANTIDAD = P_CANTIDAD,
        NOTA = P_NOTA,
        ESTADO = NVL(P_ESTADO, ESTADO),
        TOTAL = P_CANTIDAD * V_PRECIO,
        UPDATED_AT = SYSDATE
    WHERE COD_RESERVA_SERVICIO = P_ITEM_ID AND COD_RESERVA = P_RESERVA_ID;

    IF SQL%ROWCOUNT = 0 THEN
        RAISE_APPLICATION_ERROR(-20089, 'SERVICIO DE RESERVA NO ENCONTRADO');
    END IF;

    SELECT NVL(SUM(TOTAL), 0) INTO V_TOTAL_SERV
    FROM JRGY_RESERVA_SERVICIO
    WHERE COD_RESERVA = P_RESERVA_ID AND LOWER(ESTADO) <> 'cancelado';

    UPDATE JRGY_RESERVA
    SET TOTAL_SERVICIOS = V_TOTAL_SERV,
        TOTAL = NVL(TOTAL_HABITACION, 0) + V_TOTAL_SERV,
        UPDATED_AT = SYSDATE
    WHERE COD_RESERVA = P_RESERVA_ID;

    COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE;
END;
/

CREATE OR REPLACE PROCEDURE JRGY_PRO_RESERVA_SERVICIO_CANCELAR(
    P_ITEM_ID IN NUMBER,
    P_RESERVA_ID IN NUMBER
)
IS
    V_TOTAL_SERV NUMBER;
BEGIN
    UPDATE JRGY_RESERVA_SERVICIO
    SET ESTADO = 'cancelado',
        UPDATED_AT = SYSDATE
    WHERE COD_RESERVA_SERVICIO = P_ITEM_ID
      AND COD_RESERVA = P_RESERVA_ID;

    IF SQL%ROWCOUNT = 0 THEN
        RAISE_APPLICATION_ERROR(-20089, 'SERVICIO DE RESERVA NO ENCONTRADO');
    END IF;

    SELECT NVL(SUM(TOTAL), 0) INTO V_TOTAL_SERV
    FROM JRGY_RESERVA_SERVICIO
    WHERE COD_RESERVA = P_RESERVA_ID AND LOWER(ESTADO) <> 'cancelado';

    UPDATE JRGY_RESERVA
    SET TOTAL_SERVICIOS = V_TOTAL_SERV,
        TOTAL = NVL(TOTAL_HABITACION, 0) + V_TOTAL_SERV,
        UPDATED_AT = SYSDATE
    WHERE COD_RESERVA = P_RESERVA_ID;

    COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE;
END;
/

-- CRUD rol
CREATE OR REPLACE PROCEDURE CRUD_ROL(
    OPCION_P IN VARCHAR2,
    COD_ROL_P IN NUMBER,
    NOMBRE_ROL_P IN VARCHAR2,
    CUR_ROL OUT SYS_REFCURSOR
)
IS
BEGIN
    CASE UPPER(OPCION_P)
        WHEN 'C' THEN
            INSERT INTO JRGY_ROL (COD_ROL, NOMBRE_ROL)
            VALUES (COD_ROL_P, NOMBRE_ROL_P);
        WHEN 'R' THEN
            OPEN CUR_ROL FOR
                SELECT COD_ROL, NOMBRE_ROL
                FROM JRGY_ROL
                WHERE COD_ROL = COD_ROL_P;
        WHEN 'U' THEN
            UPDATE JRGY_ROL
            SET NOMBRE_ROL = NOMBRE_ROL_P
            WHERE COD_ROL = COD_ROL_P;
            IF SQL%ROWCOUNT = 0 THEN
                RAISE_APPLICATION_ERROR(-20020, 'ROL NO ENCONTRADO');
            END IF;
        WHEN 'D' THEN
            DELETE FROM JRGY_ROL WHERE COD_ROL = COD_ROL_P;
            IF SQL%ROWCOUNT = 0 THEN
                RAISE_APPLICATION_ERROR(-20020, 'ROL NO ENCONTRADO');
            END IF;
        ELSE
            RAISE_APPLICATION_ERROR(-2003, 'INGRESE C R U D');
    END CASE;
END;
/

-- Autenticacion / usuarios / roles
CREATE OR REPLACE PROCEDURE JRGY_PRO_AUTH_LOGIN(
    P_EMAIL IN VARCHAR2,
    CUR_USER OUT SYS_REFCURSOR
)
IS
BEGIN
    OPEN CUR_USER FOR
        SELECT
            COD_USUARIO,
            NOMBRE_USUARIO,
            APELLIDO1_USUARIO,
            APELLIDO2_USUARIO,
            EMAIL_USUARIO,
            TELEFONO_USUARIO,
            CONTRASENA_HASH
        FROM JRGY_USUARIO
        WHERE LOWER(EMAIL_USUARIO) = LOWER(P_EMAIL)
        FETCH FIRST 1 ROWS ONLY;
END;
/

CREATE OR REPLACE PROCEDURE JRGY_PRO_USUARIO_LISTAR(
    CUR_USERS OUT SYS_REFCURSOR
)
IS
BEGIN
    OPEN CUR_USERS FOR
        SELECT
            u.COD_USUARIO,
            u.NOMBRE_USUARIO,
            u.APELLIDO1_USUARIO,
            u.APELLIDO2_USUARIO,
            u.EMAIL_USUARIO,
            u.TELEFONO_USUARIO,
            LISTAGG(r.NOMBRE_ROL, ',') WITHIN GROUP (ORDER BY r.NOMBRE_ROL) AS ROLES
        FROM JRGY_USUARIO u
        LEFT JOIN JRGY_USUARIO_ROL ur ON ur.COD_USUARIO = u.COD_USUARIO
        LEFT JOIN JRGY_ROL r ON r.COD_ROL = ur.COD_ROL
        GROUP BY u.COD_USUARIO, u.NOMBRE_USUARIO, u.APELLIDO1_USUARIO, u.APELLIDO2_USUARIO, u.EMAIL_USUARIO, u.TELEFONO_USUARIO
        ORDER BY u.COD_USUARIO;
END;
/

CREATE OR REPLACE PROCEDURE JRGY_PRO_USUARIO_GET(
    P_ID IN NUMBER,
    CUR_USER OUT SYS_REFCURSOR
)
IS
BEGIN
    OPEN CUR_USER FOR
        SELECT
            u.COD_USUARIO,
            u.NOMBRE_USUARIO,
            u.APELLIDO1_USUARIO,
            u.APELLIDO2_USUARIO,
            u.EMAIL_USUARIO,
            u.TELEFONO_USUARIO,
            LISTAGG(r.NOMBRE_ROL, ',') WITHIN GROUP (ORDER BY r.NOMBRE_ROL) AS ROLES
        FROM JRGY_USUARIO u
        LEFT JOIN JRGY_USUARIO_ROL ur ON ur.COD_USUARIO = u.COD_USUARIO
        LEFT JOIN JRGY_ROL r ON r.COD_ROL = ur.COD_ROL
        WHERE u.COD_USUARIO = P_ID
        GROUP BY u.COD_USUARIO, u.NOMBRE_USUARIO, u.APELLIDO1_USUARIO, u.APELLIDO2_USUARIO, u.EMAIL_USUARIO, u.TELEFONO_USUARIO;
END;
/

CREATE OR REPLACE PROCEDURE JRGY_PRO_USUARIO_CREAR(
    P_COD_USUARIO IN NUMBER,
    P_NOMBRE IN VARCHAR2,
    P_AP1 IN VARCHAR2,
    P_AP2 IN VARCHAR2,
    P_TEL IN VARCHAR2,
    P_EMAIL IN VARCHAR2,
    P_PASS_HASH IN VARCHAR2,
    P_ROLES_JSON IN CLOB,
    P_ID OUT NUMBER
)
IS
    V_ESTADO_ACTIVO NUMBER := 1;
BEGIN
    IF P_COD_USUARIO IS NULL THEN
        RAISE_APPLICATION_ERROR(-20010, 'COD_USUARIO requerido (RUT sin autoincremento)');
    END IF;

    INSERT INTO JRGY_USUARIO (COD_USUARIO, NOMBRE_USUARIO, APELLIDO1_USUARIO, APELLIDO2_USUARIO, TELEFONO_USUARIO, EMAIL_USUARIO, CONTRASENA_HASH, COD_ESTADO_USUARIO)
    VALUES (P_COD_USUARIO, P_NOMBRE, P_AP1, P_AP2, P_TEL, P_EMAIL, P_PASS_HASH, V_ESTADO_ACTIVO);
    P_ID := P_COD_USUARIO;

    IF P_ROLES_JSON IS NOT NULL THEN
        INSERT INTO JRGY_USUARIO_ROL (COD_USUARIO, COD_ROL)
        SELECT P_ID, r.COD_ROL
        FROM JSON_TABLE(
            P_ROLES_JSON,
            '$[*]' COLUMNS(
                NOMBRE VARCHAR2(50) PATH '$'
            )
        ) jt
        JOIN JRGY_ROL r ON UPPER(r.NOMBRE_ROL) = UPPER(jt.NOMBRE);

        IF SQL%ROWCOUNT = 0 THEN
            RAISE_APPLICATION_ERROR(-20092, 'ROLES NO VALIDOS');
        END IF;
    END IF;

    COMMIT;
EXCEPTION
    WHEN DUP_VAL_ON_INDEX THEN
        ROLLBACK;
        RAISE_APPLICATION_ERROR(-20093, 'EMAIL DUPLICADO');
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE;
END;
/

CREATE OR REPLACE PROCEDURE JRGY_PRO_USUARIO_ACTUALIZAR(
    P_ID IN NUMBER,
    P_NOMBRE IN VARCHAR2,
    P_AP1 IN VARCHAR2,
    P_AP2 IN VARCHAR2,
    P_TEL IN VARCHAR2,
    P_EMAIL IN VARCHAR2,
    P_PASS_HASH IN VARCHAR2,
    P_ROLES_JSON IN CLOB
)
IS
BEGIN
    UPDATE JRGY_USUARIO
    SET NOMBRE_USUARIO = P_NOMBRE,
        APELLIDO1_USUARIO = P_AP1,
        APELLIDO2_USUARIO = P_AP2,
        TELEFONO_USUARIO = P_TEL,
        EMAIL_USUARIO = P_EMAIL,
        CONTRASENA_HASH = NVL(P_PASS_HASH, CONTRASENA_HASH)
    WHERE COD_USUARIO = P_ID;

    IF SQL%ROWCOUNT = 0 THEN
        RAISE_APPLICATION_ERROR(-20094, 'USUARIO NO ENCONTRADO');
    END IF;

    DELETE FROM JRGY_USUARIO_ROL WHERE COD_USUARIO = P_ID;

    IF P_ROLES_JSON IS NOT NULL THEN
        INSERT INTO JRGY_USUARIO_ROL (COD_USUARIO, COD_ROL)
        SELECT P_ID, r.COD_ROL
        FROM JSON_TABLE(
            P_ROLES_JSON,
            '$[*]' COLUMNS(
                NOMBRE VARCHAR2(50) PATH '$'
            )
        ) jt
        JOIN JRGY_ROL r ON UPPER(r.NOMBRE_ROL) = UPPER(jt.NOMBRE);

        IF SQL%ROWCOUNT = 0 THEN
            RAISE_APPLICATION_ERROR(-20092, 'ROLES NO VALIDOS');
        END IF;
    END IF;

    COMMIT;
EXCEPTION
    WHEN DUP_VAL_ON_INDEX THEN
        ROLLBACK;
        RAISE_APPLICATION_ERROR(-20093, 'EMAIL DUPLICADO');
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE;
END;
/

CREATE OR REPLACE PROCEDURE JRGY_PRO_USUARIO_ELIMINAR(
    P_ID IN NUMBER
)
IS
BEGIN
    DELETE FROM JRGY_USUARIO WHERE COD_USUARIO = P_ID;
    IF SQL%ROWCOUNT = 0 THEN
        RAISE_APPLICATION_ERROR(-20094, 'USUARIO NO ENCONTRADO');
    END IF;
    COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE;
END;
/

CREATE OR REPLACE PROCEDURE JRGY_PRO_ROL_LISTAR(
    CUR_ROL OUT SYS_REFCURSOR
)
IS
BEGIN
    OPEN CUR_ROL FOR
        SELECT COD_ROL, NOMBRE_ROL FROM JRGY_ROL ORDER BY COD_ROL;
END;
/

CREATE OR REPLACE PROCEDURE JRGY_PRO_ROL_CREAR(
    P_NOMBRE IN VARCHAR2
)
IS
BEGIN
    INSERT INTO JRGY_ROL (NOMBRE_ROL) VALUES (P_NOMBRE);
    COMMIT;
EXCEPTION
    WHEN DUP_VAL_ON_INDEX THEN
        ROLLBACK;
        RAISE_APPLICATION_ERROR(-20095, 'ROL DUPLICADO');
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE;
END;
/

CREATE OR REPLACE PROCEDURE JRGY_PRO_ROL_ELIMINAR(
    P_ID IN NUMBER
)
IS
BEGIN
    DELETE FROM JRGY_ROL WHERE COD_ROL = P_ID;
    IF SQL%ROWCOUNT = 0 THEN
        RAISE_APPLICATION_ERROR(-20020, 'ROL NO ENCONTRADO');
    END IF;
    COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE;
END;
/

-- Normaliza roles dejando solo los permitidos y re-sincroniza la secuencia.
-- Ejemplo de uso:
--   BEGIN
--     JRGY_PRO_ROL_SANITIZAR('[\"ADMIN\",\"EMPLOYEE\",\"USER\"]');
--   END;
CREATE OR REPLACE PROCEDURE JRGY_PRO_ROL_SANITIZAR(
    P_ALLOWED_JSON IN CLOB DEFAULT '[\"ADMIN\",\"EMPLOYEE\",\"USER\"]'
)
IS
    V_NEXT NUMBER;
    V_CURR NUMBER;
BEGIN
    -- Quita asignaciones a roles no permitidos
    DELETE FROM JRGY_USUARIO_ROL
    WHERE COD_ROL IN (
        SELECT COD_ROL
        FROM JRGY_ROL
        WHERE UPPER(NOMBRE_ROL) NOT IN (
            SELECT UPPER(nombre)
            FROM JSON_TABLE(P_ALLOWED_JSON, '$[*]'
                COLUMNS(nombre VARCHAR2(100) PATH '$')
            )
        )
    );

    -- Borra roles no permitidos
    DELETE FROM JRGY_ROL
    WHERE UPPER(NOMBRE_ROL) NOT IN (
        SELECT UPPER(nombre)
        FROM JSON_TABLE(P_ALLOWED_JSON, '$[*]'
            COLUMNS(nombre VARCHAR2(100) PATH '$')
        )
    );

    -- Inserta roles faltantes
    FOR rec IN (
        SELECT DISTINCT UPPER(nombre) AS NOMBRE
        FROM JSON_TABLE(P_ALLOWED_JSON, '$[*]'
            COLUMNS(nombre VARCHAR2(100) PATH '$')
        )
    ) LOOP
        BEGIN
            INSERT INTO JRGY_ROL (NOMBRE_ROL) VALUES (rec.NOMBRE);
        EXCEPTION
            WHEN DUP_VAL_ON_INDEX THEN
                NULL;
        END;
    END LOOP;

    -- Deduplica roles permitidos dejando un solo registro por nombre
    DELETE FROM JRGY_USUARIO_ROL
    WHERE COD_ROL IN (
        SELECT COD_ROL
        FROM (
            SELECT COD_ROL, ROW_NUMBER() OVER (PARTITION BY UPPER(NOMBRE_ROL) ORDER BY COD_ROL) AS RN
            FROM JRGY_ROL
        )
        WHERE RN > 1
    );

    DELETE FROM JRGY_ROL
    WHERE COD_ROL IN (
        SELECT COD_ROL
        FROM (
            SELECT COD_ROL, ROW_NUMBER() OVER (PARTITION BY UPPER(NOMBRE_ROL) ORDER BY COD_ROL) AS RN
            FROM JRGY_ROL
        )
        WHERE RN > 1
    );

    -- Ajusta la secuencia al siguiente valor libre
    SELECT NVL(MAX(COD_ROL), 0) + 1 INTO V_NEXT FROM JRGY_ROL;
    BEGIN
        SELECT last_number INTO V_CURR FROM user_sequences WHERE sequence_name = 'SQ_PK_ROL';
        IF V_CURR < V_NEXT THEN
            EXECUTE IMMEDIATE 'ALTER SEQUENCE SQ_PK_ROL INCREMENT BY ' || (V_NEXT - V_CURR);
            EXECUTE IMMEDIATE 'SELECT SQ_PK_ROL.NEXTVAL FROM dual' INTO V_CURR;
            EXECUTE IMMEDIATE 'ALTER SEQUENCE SQ_PK_ROL INCREMENT BY 1';
        END IF;
    EXCEPTION
        WHEN NO_DATA_FOUND THEN
            NULL;
    END;

    COMMIT;
END;
/

-- Check-in de reserva: valida RUT/nombre/email del titular y pasa a EN PROCESO.
CREATE OR REPLACE PROCEDURE JRGY_PRO_RESERVA_CHECKIN(
    P_RESERVA_ID IN NUMBER,
    P_RUT IN NUMBER,
    P_NOMBRE IN VARCHAR2,
    P_EMAIL IN VARCHAR2,
    P_USER_ID IN NUMBER
)
IS
    V_COD_ESTADO_EN_PROCESO NUMBER;
    V_RESERVA JRGY_RESERVA%ROWTYPE;
    V_NOMBRE_DB VARCHAR2(200);
    V_EMAIL_DB VARCHAR2(200);
    V_RUT_DB NUMBER;
BEGIN
    IF P_RESERVA_ID IS NULL OR P_RUT IS NULL OR P_NOMBRE IS NULL OR P_EMAIL IS NULL THEN
        RAISE_APPLICATION_ERROR(-20022, 'Datos obligatorios faltantes para check-in');
    END IF;

    BEGIN
        SELECT * INTO V_RESERVA FROM JRGY_RESERVA WHERE COD_RESERVA = P_RESERVA_ID FOR UPDATE;
    EXCEPTION
        WHEN NO_DATA_FOUND THEN
            RAISE_APPLICATION_ERROR(-20020, 'Reserva no encontrada');
    END;

    IF V_RESERVA.COD_USUARIO IS NULL THEN
        RAISE_APPLICATION_ERROR(-20021, 'Cliente de la reserva no encontrado');
    END IF;

    SELECT (NOMBRE_USUARIO || ' ' || NVL(APELLIDO1_USUARIO, '') || ' ' || NVL(APELLIDO2_USUARIO, '')) AS NOMBRE_COMPLETO,
           LOWER(TRIM(EMAIL_USUARIO)),
           COD_USUARIO
    INTO V_NOMBRE_DB, V_EMAIL_DB, V_RUT_DB
    FROM JRGY_USUARIO
    WHERE COD_USUARIO = V_RESERVA.COD_USUARIO;

    -- Normaliza nombre: compara solo primer nombre para evitar rechazos por apellidos/caso.
    V_NOMBRE_DB := LOWER(TRIM(REGEXP_REPLACE(V_NOMBRE_DB, '\\s+', ' ')));
    DECLARE
        v_input_name VARCHAR2(200) := LOWER(TRIM(REGEXP_REPLACE(P_NOMBRE, '\\s+', ' ')));
        v_input_first VARCHAR2(100);
        v_db_first VARCHAR2(100);
    BEGIN
        v_input_first := REGEXP_SUBSTR(v_input_name, '^[^ ]+');
        v_db_first := REGEXP_SUBSTR(V_NOMBRE_DB, '^[^ ]+');
        IF V_RUT_DB <> P_RUT THEN
            RAISE_APPLICATION_ERROR(-20022, 'Los datos ingresados no coinciden con el titular de la reserva');
        END IF;
        IF v_input_first IS NOT NULL AND v_db_first IS NOT NULL AND v_input_first <> v_db_first THEN
            RAISE_APPLICATION_ERROR(-20022, 'Los datos ingresados no coinciden con el titular de la reserva');
        END IF;
        IF LOWER(TRIM(P_EMAIL)) <> V_EMAIL_DB THEN
            RAISE_APPLICATION_ERROR(-20022, 'Los datos ingresados no coinciden con el titular de la reserva');
        END IF;
    END;

    SELECT COD_ESTADO_RESERVA INTO V_COD_ESTADO_EN_PROCESO
    FROM JRGY_CAT_ESTADO_RESERVA
    WHERE REPLACE(UPPER(ESTADO_RESERVA), '_', ' ') = 'EN PROCESO';

    UPDATE JRGY_RESERVA
    SET COD_ESTADO_RESERVA = V_COD_ESTADO_EN_PROCESO,
        UPDATED_AT = SYSDATE
    WHERE COD_RESERVA = P_RESERVA_ID;

    INSERT INTO JRGY_EVENTO_RESERVA (COD_RESERVA, TIPO_EVENTO, FECHA_EVENTO, NOTAS, CREATED_BY)
    VALUES (P_RESERVA_ID, 'CHECK-IN', SYSDATE, 'Check-in validado con RUT', P_USER_ID);

    COMMIT;
END;
/

CREATE OR REPLACE PROCEDURE JRGY_PRO_RESERVA_CHECKOUT(
    P_RESERVA_ID IN NUMBER,
    P_RUT IN NUMBER,
    P_NOMBRE IN VARCHAR2,
    P_EMAIL IN VARCHAR2,
    P_USER_ID IN NUMBER
)
IS
    V_COD_ESTADO_FINALIZADA NUMBER;
    V_RESERVA JRGY_RESERVA%ROWTYPE;
    V_NOMBRE_DB VARCHAR2(200);
    V_EMAIL_DB VARCHAR2(200);
    V_RUT_DB NUMBER;
BEGIN
    IF P_RESERVA_ID IS NULL OR P_RUT IS NULL OR P_NOMBRE IS NULL OR P_EMAIL IS NULL THEN
        RAISE_APPLICATION_ERROR(-20022, 'Datos obligatorios faltantes para check-out');
    END IF;

    BEGIN
        SELECT * INTO V_RESERVA FROM JRGY_RESERVA WHERE COD_RESERVA = P_RESERVA_ID FOR UPDATE;
    EXCEPTION
        WHEN NO_DATA_FOUND THEN
            RAISE_APPLICATION_ERROR(-20020, 'Reserva no encontrada');
    END;

    IF V_RESERVA.COD_USUARIO IS NULL THEN
        RAISE_APPLICATION_ERROR(-20021, 'Cliente de la reserva no encontrado');
    END IF;

    SELECT (NOMBRE_USUARIO || ' ' || NVL(APELLIDO1_USUARIO, '') || ' ' || NVL(APELLIDO2_USUARIO, '')) AS NOMBRE_COMPLETO,
           LOWER(TRIM(EMAIL_USUARIO)),
           COD_USUARIO
    INTO V_NOMBRE_DB, V_EMAIL_DB, V_RUT_DB
    FROM JRGY_USUARIO
    WHERE COD_USUARIO = V_RESERVA.COD_USUARIO;

    V_NOMBRE_DB := LOWER(TRIM(REGEXP_REPLACE(V_NOMBRE_DB, '\\s+', ' ')));
    DECLARE
        v_input_name VARCHAR2(200) := LOWER(TRIM(REGEXP_REPLACE(P_NOMBRE, '\\s+', ' ')));
        v_input_first VARCHAR2(100);
        v_db_first VARCHAR2(100);
    BEGIN
        v_input_first := REGEXP_SUBSTR(v_input_name, '^[^ ]+');
        v_db_first := REGEXP_SUBSTR(V_NOMBRE_DB, '^[^ ]+');
        IF V_RUT_DB <> P_RUT THEN
            RAISE_APPLICATION_ERROR(-20022, 'Los datos ingresados no coinciden con el titular de la reserva');
        END IF;
        IF v_input_first IS NOT NULL AND v_db_first IS NOT NULL AND v_input_first <> v_db_first THEN
            RAISE_APPLICATION_ERROR(-20022, 'Los datos ingresados no coinciden con el titular de la reserva');
        END IF;
        IF LOWER(TRIM(P_EMAIL)) <> V_EMAIL_DB THEN
            RAISE_APPLICATION_ERROR(-20022, 'Los datos ingresados no coinciden con el titular de la reserva');
        END IF;
    END;

    SELECT COD_ESTADO_RESERVA INTO V_COD_ESTADO_FINALIZADA
    FROM JRGY_CAT_ESTADO_RESERVA
    WHERE REPLACE(UPPER(ESTADO_RESERVA), '_', ' ') = 'FINALIZADA';

    UPDATE JRGY_RESERVA
    SET COD_ESTADO_RESERVA = V_COD_ESTADO_FINALIZADA,
        UPDATED_AT = SYSDATE
    WHERE COD_RESERVA = P_RESERVA_ID;

    INSERT INTO JRGY_EVENTO_RESERVA (COD_RESERVA, TIPO_EVENTO, FECHA_EVENTO, NOTAS, CREATED_BY)
    VALUES (P_RESERVA_ID, 'CHECK-OUT', SYSDATE, 'Check-out validado con RUT', P_USER_ID);

    COMMIT;
END;
/

CREATE OR REPLACE PROCEDURE JRGY_PRO_RESERVA_SOLICITAR_CHECKOUT(
    P_RESERVA_ID IN NUMBER,
    P_USER_ID IN NUMBER
)
IS
    V_RESERVA JRGY_RESERVA%ROWTYPE;
    V_ESTADO_EN_PROCESO NUMBER;
    V_ESTADO_CHECKOUT_SOL NUMBER;
    V_ESTADO_FINALIZADA NUMBER;
    V_ESTADO_CANCELADA NUMBER;
BEGIN
    IF P_RESERVA_ID IS NULL THEN
        RAISE_APPLICATION_ERROR(-20022, 'Datos obligatorios faltantes para solicitar check-out');
    END IF;

    BEGIN
        SELECT * INTO V_RESERVA FROM JRGY_RESERVA WHERE COD_RESERVA = P_RESERVA_ID FOR UPDATE;
    EXCEPTION
        WHEN NO_DATA_FOUND THEN
            RAISE_APPLICATION_ERROR(-20020, 'Reserva no encontrada');
    END;

    SELECT COD_ESTADO_RESERVA INTO V_ESTADO_EN_PROCESO
    FROM JRGY_CAT_ESTADO_RESERVA
    WHERE REPLACE(UPPER(ESTADO_RESERVA), '_', ' ') = 'EN PROCESO';

    SELECT COD_ESTADO_RESERVA INTO V_ESTADO_CHECKOUT_SOL
    FROM JRGY_CAT_ESTADO_RESERVA
    WHERE REPLACE(UPPER(ESTADO_RESERVA), '_', ' ') = 'CHECKOUT SOLICITADO';

    SELECT COD_ESTADO_RESERVA INTO V_ESTADO_FINALIZADA
    FROM JRGY_CAT_ESTADO_RESERVA
    WHERE REPLACE(UPPER(ESTADO_RESERVA), '_', ' ') = 'FINALIZADA';

    SELECT COD_ESTADO_RESERVA INTO V_ESTADO_CANCELADA
    FROM JRGY_CAT_ESTADO_RESERVA
    WHERE REPLACE(UPPER(ESTADO_RESERVA), '_', ' ') = 'CANCELADA';

    IF V_RESERVA.COD_ESTADO_RESERVA = V_ESTADO_CHECKOUT_SOL THEN
        RAISE_APPLICATION_ERROR(-20024, 'El check-out ya fue solicitado');
    END IF;

    IF V_RESERVA.COD_ESTADO_RESERVA = V_ESTADO_FINALIZADA OR V_RESERVA.COD_ESTADO_RESERVA = V_ESTADO_CANCELADA THEN
        RAISE_APPLICATION_ERROR(-20023, 'La reserva no permite solicitar check-out');
    END IF;

    IF V_RESERVA.COD_ESTADO_RESERVA <> V_ESTADO_EN_PROCESO THEN
        RAISE_APPLICATION_ERROR(-20023, 'Solo se puede solicitar check-out cuando la reserva está en proceso');
    END IF;

    UPDATE JRGY_RESERVA
    SET COD_ESTADO_RESERVA = V_ESTADO_CHECKOUT_SOL,
        UPDATED_AT = SYSDATE
    WHERE COD_RESERVA = P_RESERVA_ID;

    INSERT INTO JRGY_EVENTO_RESERVA (COD_RESERVA, TIPO_EVENTO, FECHA_EVENTO, NOTAS, CREATED_BY)
    VALUES (P_RESERVA_ID, 'CHECK-OUT SOLICITADO', SYSDATE, 'Solicitado por el cliente', P_USER_ID);

    COMMIT;
END;
/

-- Catálogo de tipos de habitación
CREATE OR REPLACE PROCEDURE JRGY_PRO_TIPO_HAB_LISTAR(
    CUR_TIPOS OUT SYS_REFCURSOR
)
IS
BEGIN
    OPEN CUR_TIPOS FOR
        SELECT
            COD_TIPO_HABITACION AS ID,
            TIPO_HABITACION AS TIPO
        FROM JRGY_CAT_TIPO_HABITACION
        ORDER BY TIPO_HABITACION;
END;
/

CREATE OR REPLACE PROCEDURE JRGY_PRO_TIPO_HAB_CREAR(
    P_NOMBRE IN VARCHAR2,
    P_ID OUT NUMBER
)
IS
    V_NOMBRE VARCHAR2(50);
BEGIN
    V_NOMBRE := UPPER(TRIM(P_NOMBRE));

    IF V_NOMBRE IS NULL THEN
        RAISE_APPLICATION_ERROR(-20121, 'NOMBRE DE TIPO REQUERIDO');
    END IF;

    BEGIN
        SELECT COD_TIPO_HABITACION INTO P_ID
        FROM JRGY_CAT_TIPO_HABITACION
        WHERE TIPO_HABITACION = V_NOMBRE;
        RETURN;
    EXCEPTION
        WHEN NO_DATA_FOUND THEN
            NULL;
    END;

    INSERT INTO JRGY_CAT_TIPO_HABITACION (TIPO_HABITACION)
    VALUES (V_NOMBRE)
    RETURNING COD_TIPO_HABITACION INTO P_ID;

    COMMIT;
EXCEPTION
    WHEN DUP_VAL_ON_INDEX THEN
        SELECT COD_TIPO_HABITACION INTO P_ID FROM JRGY_CAT_TIPO_HABITACION WHERE TIPO_HABITACION = V_NOMBRE;
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE;
END;
/

-- Habitaciones y experiencias (solo lectura)
CREATE OR REPLACE PROCEDURE JRGY_PRO_HABITACION_LISTAR(
    CUR_HAB OUT SYS_REFCURSOR
)
IS
BEGIN
    OPEN CUR_HAB FOR
        SELECT
            h.COD_HABITACION AS ID,
            h.NRO_HABITACION AS NUMERO,
            h.CAPACIDAD,
            h.PRECIO_BASE,
            th.TIPO_HABITACION AS TIPO,
            eh.ESTADO_HABITACION AS ESTADO
        FROM JRGY_HABITACION h
        LEFT JOIN JRGY_CAT_TIPO_HABITACION th ON th.COD_TIPO_HABITACION = h.COD_TIPO_HABITACION
        LEFT JOIN JRGY_CAT_ESTADO_HABITACION eh ON eh.COD_ESTADO_HABITACION = h.COD_ESTADO_HABITACION
        ORDER BY h.NRO_HABITACION;
END;
/

CREATE OR REPLACE PROCEDURE JRGY_PRO_EXPERIENCIA_LISTAR(
    CUR_EXP OUT SYS_REFCURSOR
)
IS
BEGIN
    OPEN CUR_EXP FOR
        SELECT
            COD_EXPERIENCIA AS ID,
            NOMBRE,
            DESCRIPCION,
            PRECIO,
            TAG,
            ESTADO
        FROM JRGY_EXPERIENCIA
        ORDER BY COD_EXPERIENCIA;
END;
/

-- Solicitudes admin
CREATE OR REPLACE PROCEDURE JRGY_PRO_SOLICITUD_CREAR(
    P_USER_ID IN NUMBER,
    P_MOTIVO IN VARCHAR2
)
IS
BEGIN
    INSERT INTO JRGY_SOLICITUD_ADMIN (COD_USUARIO, ESTADO, MOTIVO, FECHA_CREACION)
    VALUES (P_USER_ID, 'pending', P_MOTIVO, SYSDATE);
    COMMIT;
END;
/

CREATE OR REPLACE PROCEDURE JRGY_PRO_SOLICITUD_LISTAR(
    CUR_SOL OUT SYS_REFCURSOR
)
IS
BEGIN
    OPEN CUR_SOL FOR
        SELECT s.COD_SOLICITUD, s.COD_USUARIO, s.ESTADO, s.MOTIVO, s.FECHA_CREACION, s.FECHA_RESOLUCION, s.APROBADO_POR,
               u.NOMBRE_USUARIO, u.EMAIL_USUARIO
        FROM JRGY_SOLICITUD_ADMIN s
        INNER JOIN JRGY_USUARIO u ON u.COD_USUARIO = s.COD_USUARIO
        ORDER BY s.FECHA_CREACION DESC;
END;
/

CREATE OR REPLACE PROCEDURE JRGY_PRO_SOLICITUD_RESOLVER(
    P_ID IN NUMBER,
    P_ACCION IN VARCHAR2,
    P_APROBADOR IN NUMBER
)
IS
    V_ESTADO_ACTUAL VARCHAR2(20);
    V_USUARIO NUMBER;
BEGIN
    SELECT ESTADO, COD_USUARIO INTO V_ESTADO_ACTUAL, V_USUARIO
    FROM JRGY_SOLICITUD_ADMIN
    WHERE COD_SOLICITUD = P_ID
    FOR UPDATE;

    IF V_ESTADO_ACTUAL <> 'pending' THEN
        RAISE_APPLICATION_ERROR(-20096, 'SOLICITUD YA RESUELTA');
    END IF;

    UPDATE JRGY_SOLICITUD_ADMIN
    SET ESTADO = P_ACCION,
        APROBADO_POR = P_APROBADOR,
        FECHA_RESOLUCION = SYSDATE
    WHERE COD_SOLICITUD = P_ID;

    IF LOWER(P_ACCION) = 'approved' THEN
        INSERT INTO JRGY_USUARIO_ROL (COD_USUARIO, COD_ROL)
        SELECT V_USUARIO, COD_ROL FROM JRGY_ROL WHERE UPPER(NOMBRE_ROL) = 'ADMIN'
        AND NOT EXISTS (SELECT 1 FROM JRGY_USUARIO_ROL ur WHERE ur.COD_USUARIO = V_USUARIO AND ur.COD_ROL = JRGY_ROL.COD_ROL);
    END IF;

    COMMIT;
EXCEPTION
    WHEN NO_DATA_FOUND THEN
        ROLLBACK;
        RAISE_APPLICATION_ERROR(-20097, 'SOLICITUD NO ENCONTRADA');
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE;
END;
/

-- CRUD usuario_rol
CREATE OR REPLACE PROCEDURE CRUD_USUARIO_ROL(
    OPCION_P IN VARCHAR2,
    COD_USUARIO_P IN NUMBER,
    COD_ROL_P IN NUMBER,
    CUR_USUARIO_ROL OUT SYS_REFCURSOR
)
IS
BEGIN
    CASE UPPER(OPCION_P)
        WHEN 'C' THEN
            INSERT INTO JRGY_USUARIO_ROL (COD_USUARIO, COD_ROL)
            VALUES (COD_USUARIO_P, COD_ROL_P);
        WHEN 'R' THEN
            OPEN CUR_USUARIO_ROL FOR
                SELECT COD_USUARIO, COD_ROL
                FROM JRGY_USUARIO_ROL
                WHERE COD_USUARIO = COD_USUARIO_P AND COD_ROL = COD_ROL_P;
        WHEN 'U' THEN
            RAISE_APPLICATION_ERROR(-20021, 'UPDATE NO SOPORTADO, ELIMINE Y CREE NUEVO');
        WHEN 'D' THEN
            DELETE FROM JRGY_USUARIO_ROL
            WHERE COD_USUARIO = COD_USUARIO_P AND COD_ROL = COD_ROL_P;
            IF SQL%ROWCOUNT = 0 THEN
                RAISE_APPLICATION_ERROR(-20021, 'ASIGNACION NO ENCONTRADA');
            END IF;
        ELSE
            RAISE_APPLICATION_ERROR(-2003, 'INGRESE C R U D');
    END CASE;
END;
/

-- CRUD region / ciudad / comuna / calle
CREATE OR REPLACE PROCEDURE CRUD_REGION(
    OPCION_P IN VARCHAR2,
    COD_REGION_P IN NUMBER,
    REGION_P IN VARCHAR2,
    CUR_REGION OUT SYS_REFCURSOR
)
IS
BEGIN
    CASE UPPER(OPCION_P)
        WHEN 'C' THEN
            INSERT INTO JRGY_REGION (COD_REGION, REGION) VALUES (COD_REGION_P, REGION_P);
        WHEN 'R' THEN
            OPEN CUR_REGION FOR
                SELECT COD_REGION, REGION FROM JRGY_REGION WHERE COD_REGION = COD_REGION_P;
        WHEN 'U' THEN
            UPDATE JRGY_REGION SET REGION = REGION_P WHERE COD_REGION = COD_REGION_P;
            IF SQL%ROWCOUNT = 0 THEN
                RAISE_APPLICATION_ERROR(-20022, 'REGION NO ENCONTRADA');
            END IF;
        WHEN 'D' THEN
            DELETE FROM JRGY_REGION WHERE COD_REGION = COD_REGION_P;
            IF SQL%ROWCOUNT = 0 THEN
                RAISE_APPLICATION_ERROR(-20022, 'REGION NO ENCONTRADA');
            END IF;
        ELSE
            RAISE_APPLICATION_ERROR(-2003, 'INGRESE C R U D');
    END CASE;
END;
/

CREATE OR REPLACE PROCEDURE CRUD_CIUDAD(
    OPCION_P IN VARCHAR2,
    COD_CIUDAD_P IN NUMBER,
    CIUDAD_P IN VARCHAR2,
    COD_REGION_P IN NUMBER,
    CUR_CIUDAD OUT SYS_REFCURSOR
)
IS
BEGIN
    CASE UPPER(OPCION_P)
        WHEN 'C' THEN
            INSERT INTO JRGY_CIUDAD (COD_CIUDAD, CIUDAD, COD_REGION) VALUES (COD_CIUDAD_P, CIUDAD_P, COD_REGION_P);
        WHEN 'R' THEN
            OPEN CUR_CIUDAD FOR
                SELECT COD_CIUDAD, CIUDAD, COD_REGION FROM JRGY_CIUDAD WHERE COD_CIUDAD = COD_CIUDAD_P;
        WHEN 'U' THEN
            UPDATE JRGY_CIUDAD
            SET CIUDAD = CIUDAD_P,
                COD_REGION = COD_REGION_P
            WHERE COD_CIUDAD = COD_CIUDAD_P;
            IF SQL%ROWCOUNT = 0 THEN
                RAISE_APPLICATION_ERROR(-20023, 'CIUDAD NO ENCONTRADA');
            END IF;
        WHEN 'D' THEN
            DELETE FROM JRGY_CIUDAD WHERE COD_CIUDAD = COD_CIUDAD_P;
            IF SQL%ROWCOUNT = 0 THEN
                RAISE_APPLICATION_ERROR(-20023, 'CIUDAD NO ENCONTRADA');
            END IF;
        ELSE
            RAISE_APPLICATION_ERROR(-2003, 'INGRESE C R U D');
    END CASE;
END;
/

CREATE OR REPLACE PROCEDURE CRUD_COMUNA(
    OPCION_P IN VARCHAR2,
    COD_COMUNA_P IN NUMBER,
    COMUNA_P IN VARCHAR2,
    COD_CIUDAD_P IN NUMBER,
    CUR_COMUNA OUT SYS_REFCURSOR
)
IS
BEGIN
    CASE UPPER(OPCION_P)
        WHEN 'C' THEN
            INSERT INTO JRGY_COMUNA (COD_COMUNA, COMUNA, COD_CIUDAD) VALUES (COD_COMUNA_P, COMUNA_P, COD_CIUDAD_P);
        WHEN 'R' THEN
            OPEN CUR_COMUNA FOR
                SELECT COD_COMUNA, COMUNA, COD_CIUDAD FROM JRGY_COMUNA WHERE COD_COMUNA = COD_COMUNA_P;
        WHEN 'U' THEN
            UPDATE JRGY_COMUNA
            SET COMUNA = COMUNA_P,
                COD_CIUDAD = COD_CIUDAD_P
            WHERE COD_COMUNA = COD_COMUNA_P;
            IF SQL%ROWCOUNT = 0 THEN
                RAISE_APPLICATION_ERROR(-20024, 'COMUNA NO ENCONTRADA');
            END IF;
        WHEN 'D' THEN
            DELETE FROM JRGY_COMUNA WHERE COD_COMUNA = COD_COMUNA_P;
            IF SQL%ROWCOUNT = 0 THEN
                RAISE_APPLICATION_ERROR(-20024, 'COMUNA NO ENCONTRADA');
            END IF;
        ELSE
            RAISE_APPLICATION_ERROR(-2003, 'INGRESE C R U D');
    END CASE;
END;
/

CREATE OR REPLACE PROCEDURE CRUD_CALLE(
    OPCION_P IN VARCHAR2,
    COD_CALLE_P IN NUMBER,
    CALLE_P IN VARCHAR2,
    NRO_P IN NUMBER,
    COD_COMUNA_P IN NUMBER,
    CUR_CALLE OUT SYS_REFCURSOR
)
IS
BEGIN
    CASE UPPER(OPCION_P)
        WHEN 'C' THEN
            INSERT INTO JRGY_CALLE (COD_CALLE, CALLE, NRO, COD_COMUNA) VALUES (COD_CALLE_P, CALLE_P, NRO_P, COD_COMUNA_P);
        WHEN 'R' THEN
            OPEN CUR_CALLE FOR
                SELECT COD_CALLE, CALLE, NRO, COD_COMUNA FROM JRGY_CALLE WHERE COD_CALLE = COD_CALLE_P;
        WHEN 'U' THEN
            UPDATE JRGY_CALLE
            SET CALLE = CALLE_P,
                NRO = NRO_P,
                COD_COMUNA = COD_COMUNA_P
            WHERE COD_CALLE = COD_CALLE_P;
            IF SQL%ROWCOUNT = 0 THEN
                RAISE_APPLICATION_ERROR(-20025, 'CALLE NO ENCONTRADA');
            END IF;
        WHEN 'D' THEN
            DELETE FROM JRGY_CALLE WHERE COD_CALLE = COD_CALLE_P;
            IF SQL%ROWCOUNT = 0 THEN
                RAISE_APPLICATION_ERROR(-20025, 'CALLE NO ENCONTRADA');
            END IF;
        ELSE
            RAISE_APPLICATION_ERROR(-2003, 'INGRESE C R U D');
    END CASE;
END;
/

-- CRUD proveedor
CREATE OR REPLACE PROCEDURE CRUD_PROVEEDOR(
    OPCION_P IN VARCHAR2,
    COD_PROVEEDOR_P IN NUMBER,
    NOMBRE_PROVEEDOR_P IN VARCHAR2,
    DIRECCION_PROVEEDOR_P IN VARCHAR2,
    TELEFONO_PROVEEDOR_P IN NUMBER,
    COD_REGION_P IN NUMBER,
    CUR_PROVEEDOR OUT SYS_REFCURSOR
)
IS
BEGIN
    CASE UPPER(OPCION_P)
        WHEN 'C' THEN
            INSERT INTO JRGY_PROVEEDOR (COD_PROVEEDOR, NOMBRE_PROVEEDOR, DIRECCION_PROVEEDOR, TELEFONO_PROVEEDOR, COD_REGION)
            VALUES (COD_PROVEEDOR_P, NOMBRE_PROVEEDOR_P, DIRECCION_PROVEEDOR_P, TELEFONO_PROVEEDOR_P, COD_REGION_P);
        WHEN 'R' THEN
            OPEN CUR_PROVEEDOR FOR
                SELECT COD_PROVEEDOR, NOMBRE_PROVEEDOR, DIRECCION_PROVEEDOR, TELEFONO_PROVEEDOR, COD_REGION
                FROM JRGY_PROVEEDOR
                WHERE COD_PROVEEDOR = COD_PROVEEDOR_P;
        WHEN 'U' THEN
            UPDATE JRGY_PROVEEDOR
            SET NOMBRE_PROVEEDOR   = NOMBRE_PROVEEDOR_P,
                DIRECCION_PROVEEDOR = DIRECCION_PROVEEDOR_P,
                TELEFONO_PROVEEDOR  = TELEFONO_PROVEEDOR_P,
                COD_REGION          = COD_REGION_P
            WHERE COD_PROVEEDOR = COD_PROVEEDOR_P;
            IF SQL%ROWCOUNT = 0 THEN
                RAISE_APPLICATION_ERROR(-20026, 'PROVEEDOR NO ENCONTRADO');
            END IF;
        WHEN 'D' THEN
            DELETE FROM JRGY_PROVEEDOR WHERE COD_PROVEEDOR = COD_PROVEEDOR_P;
            IF SQL%ROWCOUNT = 0 THEN
                RAISE_APPLICATION_ERROR(-20026, 'PROVEEDOR NO ENCONTRADO');
            END IF;
        ELSE
            RAISE_APPLICATION_ERROR(-2003, 'INGRESE C R U D');
    END CASE;
END;
/

-- CRUD habitacion y pagos
CREATE OR REPLACE PROCEDURE CRUD_HABITACION(
    OPCION_P IN VARCHAR2,
    COD_HABITACION_P IN NUMBER,
    NRO_HABITACION_P IN NUMBER,
    CAPACIDAD_P IN NUMBER,
    COD_TIPO_HABITACION_P IN NUMBER,
    COD_ESTADO_HABITACION_P IN NUMBER,
    PRECIO_BASE_P IN NUMBER,
    CUR_HABITACION OUT SYS_REFCURSOR
)
IS
BEGIN
    CASE UPPER(OPCION_P)
        WHEN 'C' THEN
            INSERT INTO JRGY_HABITACION (COD_HABITACION, NRO_HABITACION, CAPACIDAD, COD_TIPO_HABITACION, COD_ESTADO_HABITACION, PRECIO_BASE)
            VALUES (COD_HABITACION_P, NRO_HABITACION_P, CAPACIDAD_P, COD_TIPO_HABITACION_P, COD_ESTADO_HABITACION_P, PRECIO_BASE_P);
        WHEN 'R' THEN
            OPEN CUR_HABITACION FOR
                SELECT COD_HABITACION, NRO_HABITACION, CAPACIDAD, COD_TIPO_HABITACION, COD_ESTADO_HABITACION, PRECIO_BASE
                FROM JRGY_HABITACION
                WHERE COD_HABITACION = COD_HABITACION_P;
        WHEN 'U' THEN
            UPDATE JRGY_HABITACION
            SET NRO_HABITACION      = NRO_HABITACION_P,
                CAPACIDAD           = CAPACIDAD_P,
                COD_TIPO_HABITACION = COD_TIPO_HABITACION_P,
                COD_ESTADO_HABITACION = COD_ESTADO_HABITACION_P,
                PRECIO_BASE         = PRECIO_BASE_P
            WHERE COD_HABITACION = COD_HABITACION_P;
            IF SQL%ROWCOUNT = 0 THEN
                RAISE_APPLICATION_ERROR(-20027, 'HABITACION NO ENCONTRADA');
            END IF;
        WHEN 'D' THEN
            DELETE FROM JRGY_HABITACION WHERE COD_HABITACION = COD_HABITACION_P;
            IF SQL%ROWCOUNT = 0 THEN
                RAISE_APPLICATION_ERROR(-20027, 'HABITACION NO ENCONTRADA');
            END IF;
        ELSE
            RAISE_APPLICATION_ERROR(-2003, 'INGRESE C R U D');
    END CASE;
END;
/

CREATE OR REPLACE PROCEDURE CRUD_PAGO_HABITACION(
    OPCION_P IN VARCHAR2,
    COD_PAGO_P IN NUMBER,
    FECHA_PAGO_P IN DATE,
    VALOR_TOTAL_P IN NUMBER,
    COD_USUARIO_P IN NUMBER,
    CUR_PAGO OUT SYS_REFCURSOR
)
IS
BEGIN
    CASE UPPER(OPCION_P)
        WHEN 'C' THEN
            INSERT INTO JRGY_PAGO_HABITACION (COD_PAGO_HABITACION, FECHA_PAGO, VALOR_TOTAL_PAGO, COD_USUARIO)
            VALUES (COD_PAGO_P, FECHA_PAGO_P, VALOR_TOTAL_P, COD_USUARIO_P);
        WHEN 'R' THEN
            OPEN CUR_PAGO FOR
                SELECT COD_PAGO_HABITACION, FECHA_PAGO, VALOR_TOTAL_PAGO, COD_USUARIO
                FROM JRGY_PAGO_HABITACION
                WHERE COD_PAGO_HABITACION = COD_PAGO_P;
        WHEN 'U' THEN
            UPDATE JRGY_PAGO_HABITACION
            SET FECHA_PAGO = FECHA_PAGO_P,
                VALOR_TOTAL_PAGO = VALOR_TOTAL_P,
                COD_USUARIO = COD_USUARIO_P
            WHERE COD_PAGO_HABITACION = COD_PAGO_P;
            IF SQL%ROWCOUNT = 0 THEN
                RAISE_APPLICATION_ERROR(-20028, 'PAGO HABITACION NO ENCONTRADO');
            END IF;
        WHEN 'D' THEN
            DELETE FROM JRGY_PAGO_HABITACION WHERE COD_PAGO_HABITACION = COD_PAGO_P;
            IF SQL%ROWCOUNT = 0 THEN
                RAISE_APPLICATION_ERROR(-20028, 'PAGO HABITACION NO ENCONTRADO');
            END IF;
        ELSE
            RAISE_APPLICATION_ERROR(-2003, 'INGRESE C R U D');
    END CASE;
END;
/

CREATE OR REPLACE PROCEDURE CRUD_DETALLE_PAGO_HABITACION(
    OPCION_P IN VARCHAR2,
    COD_PAGO_P IN NUMBER,
    COD_HABITACION_P IN NUMBER,
    FECHA_ESTADIA_P IN DATE,
    PRECIO_HABITACION_P IN NUMBER,
    DIAS_P IN NUMBER,
    CUR_DET_PAGO OUT SYS_REFCURSOR
)
IS
BEGIN
    CASE UPPER(OPCION_P)
        WHEN 'C' THEN
            INSERT INTO JRGY_DETALLE_PAGO_HABITACION (COD_PAGO_HABITACION, COD_HABITACION, FECHA_ESTADIA, PRECIO_HABITACION, DIAS)
            VALUES (COD_PAGO_P, COD_HABITACION_P, FECHA_ESTADIA_P, PRECIO_HABITACION_P, DIAS_P);
        WHEN 'R' THEN
            OPEN CUR_DET_PAGO FOR
                SELECT COD_PAGO_HABITACION, COD_HABITACION, FECHA_ESTADIA, PRECIO_HABITACION, DIAS
                FROM JRGY_DETALLE_PAGO_HABITACION
                WHERE COD_PAGO_HABITACION = COD_PAGO_P AND COD_HABITACION = COD_HABITACION_P;
        WHEN 'U' THEN
            UPDATE JRGY_DETALLE_PAGO_HABITACION
            SET FECHA_ESTADIA = FECHA_ESTADIA_P,
                PRECIO_HABITACION = PRECIO_HABITACION_P,
                DIAS = DIAS_P
            WHERE COD_PAGO_HABITACION = COD_PAGO_P AND COD_HABITACION = COD_HABITACION_P;
            IF SQL%ROWCOUNT = 0 THEN
                RAISE_APPLICATION_ERROR(-20029, 'DETALLE PAGO HAB NO ENCONTRADO');
            END IF;
        WHEN 'D' THEN
            DELETE FROM JRGY_DETALLE_PAGO_HABITACION
            WHERE COD_PAGO_HABITACION = COD_PAGO_P AND COD_HABITACION = COD_HABITACION_P;
            IF SQL%ROWCOUNT = 0 THEN
                RAISE_APPLICATION_ERROR(-20029, 'DETALLE PAGO HAB NO ENCONTRADO');
            END IF;
        ELSE
            RAISE_APPLICATION_ERROR(-2003, 'INGRESE C R U D');
    END CASE;
END;
/

-- CRUD pedido/detalle
CREATE OR REPLACE PROCEDURE CRUD_PEDIDO(
    OPCION_P IN VARCHAR2,
    COD_PEDIDO_P IN NUMBER,
    VALOR_TOTAL_P IN NUMBER,
    FECHA_PEDIDO_P IN DATE,
    COD_EMPLEADO_P IN NUMBER,
    CUR_PEDIDO OUT SYS_REFCURSOR
)
IS
BEGIN
    CASE UPPER(OPCION_P)
        WHEN 'C' THEN
            INSERT INTO JRGY_PEDIDO (COD_PEDIDO, VALOR_TOTAL, FECHA_PEDIDO, COD_EMPLEADO)
            VALUES (COD_PEDIDO_P, VALOR_TOTAL_P, FECHA_PEDIDO_P, COD_EMPLEADO_P);
        WHEN 'R' THEN
            OPEN CUR_PEDIDO FOR
                SELECT COD_PEDIDO, VALOR_TOTAL, FECHA_PEDIDO, COD_EMPLEADO
                FROM JRGY_PEDIDO
                WHERE COD_PEDIDO = COD_PEDIDO_P;
        WHEN 'U' THEN
            UPDATE JRGY_PEDIDO
            SET VALOR_TOTAL = VALOR_TOTAL_P,
                FECHA_PEDIDO = FECHA_PEDIDO_P,
                COD_EMPLEADO = COD_EMPLEADO_P
            WHERE COD_PEDIDO = COD_PEDIDO_P;
            IF SQL%ROWCOUNT = 0 THEN
                RAISE_APPLICATION_ERROR(-20030, 'PEDIDO NO ENCONTRADO');
            END IF;
        WHEN 'D' THEN
            DELETE FROM JRGY_PEDIDO WHERE COD_PEDIDO = COD_PEDIDO_P;
            IF SQL%ROWCOUNT = 0 THEN
                RAISE_APPLICATION_ERROR(-20030, 'PEDIDO NO ENCONTRADO');
            END IF;
        ELSE
            RAISE_APPLICATION_ERROR(-2003, 'INGRESE C R U D');
    END CASE;
END;
/

CREATE OR REPLACE PROCEDURE CRUD_DETALLE_PEDIDO(
    OPCION_P IN VARCHAR2,
    COD_PEDIDO_P IN NUMBER,
    COD_PROVEEDOR_P IN NUMBER,
    COD_PRODUCTO_P IN NUMBER,
    NOMBRE_PRODUCTO_P IN VARCHAR2,
    CANTIDAD_PRODUCTO_P IN NUMBER,
    PRECIO_COMPRA_P IN NUMBER,
    PRECIO_TOTAL_P IN NUMBER,
    CUR_DET_PEDIDO OUT SYS_REFCURSOR
)
IS
BEGIN
    CASE UPPER(OPCION_P)
        WHEN 'C' THEN
            INSERT INTO JRGY_DETALLE_PEDIDO (COD_PEDIDO, COD_PROVEEDOR, COD_PRODUCTO, NOMBRE_PRODUCTO, CANTIDAD_PRODUCTO, PRECIO_COMPRA, PRECIO_TOTAL)
            VALUES (COD_PEDIDO_P, COD_PROVEEDOR_P, COD_PRODUCTO_P, NOMBRE_PRODUCTO_P, CANTIDAD_PRODUCTO_P, PRECIO_COMPRA_P, PRECIO_TOTAL_P);
        WHEN 'R' THEN
            OPEN CUR_DET_PEDIDO FOR
                SELECT COD_PEDIDO, COD_PROVEEDOR, COD_PRODUCTO, NOMBRE_PRODUCTO, CANTIDAD_PRODUCTO, PRECIO_COMPRA, PRECIO_TOTAL
                FROM JRGY_DETALLE_PEDIDO
                WHERE COD_PEDIDO = COD_PEDIDO_P AND COD_PROVEEDOR = COD_PROVEEDOR_P AND COD_PRODUCTO = COD_PRODUCTO_P;
        WHEN 'U' THEN
            UPDATE JRGY_DETALLE_PEDIDO
            SET COD_PRODUCTO      = COD_PRODUCTO_P,
                NOMBRE_PRODUCTO   = NOMBRE_PRODUCTO_P,
                CANTIDAD_PRODUCTO = CANTIDAD_PRODUCTO_P,
                PRECIO_COMPRA     = PRECIO_COMPRA_P,
                PRECIO_TOTAL      = PRECIO_TOTAL_P
            WHERE COD_PEDIDO = COD_PEDIDO_P AND COD_PROVEEDOR = COD_PROVEEDOR_P AND COD_PRODUCTO = COD_PRODUCTO_P;
            IF SQL%ROWCOUNT = 0 THEN
                RAISE_APPLICATION_ERROR(-20031, 'DETALLE PEDIDO NO ENCONTRADO');
            END IF;
        WHEN 'D' THEN
            DELETE FROM JRGY_DETALLE_PEDIDO WHERE COD_PEDIDO = COD_PEDIDO_P AND COD_PROVEEDOR = COD_PROVEEDOR_P AND COD_PRODUCTO = COD_PRODUCTO_P;
            IF SQL%ROWCOUNT = 0 THEN
                RAISE_APPLICATION_ERROR(-20031, 'DETALLE PEDIDO NO ENCONTRADO');
            END IF;
        ELSE
            RAISE_APPLICATION_ERROR(-2003, 'INGRESE C R U D');
    END CASE;
END;
/

-- CRUD venta/detalle
CREATE OR REPLACE PROCEDURE CRUD_VENTA(
    OPCION_P IN VARCHAR2,
    COD_VENTA_P IN NUMBER,
    COD_USUARIO_P IN NUMBER,
    COD_EMPLEADO_P IN NUMBER,
    FECHA_VENTA_P IN DATE,
    CUR_VENTA OUT SYS_REFCURSOR
)
IS
BEGIN
    CASE UPPER(OPCION_P)
        WHEN 'C' THEN
            INSERT INTO JRGY_VENTA (COD_VENTA, COD_USUARIO, COD_EMPLEADO, FECHA_VENTA)
            VALUES (COD_VENTA_P, COD_USUARIO_P, COD_EMPLEADO_P, FECHA_VENTA_P);
        WHEN 'R' THEN
            OPEN CUR_VENTA FOR
                SELECT COD_VENTA, COD_USUARIO, COD_EMPLEADO, FECHA_VENTA
                FROM JRGY_VENTA
                WHERE COD_VENTA = COD_VENTA_P;
        WHEN 'U' THEN
            UPDATE JRGY_VENTA
            SET COD_USUARIO = COD_USUARIO_P,
                COD_EMPLEADO = COD_EMPLEADO_P,
                FECHA_VENTA = FECHA_VENTA_P
            WHERE COD_VENTA = COD_VENTA_P;
            IF SQL%ROWCOUNT = 0 THEN
                RAISE_APPLICATION_ERROR(-20032, 'VENTA NO ENCONTRADA');
            END IF;
        WHEN 'D' THEN
            DELETE FROM JRGY_VENTA WHERE COD_VENTA = COD_VENTA_P;
            IF SQL%ROWCOUNT = 0 THEN
                RAISE_APPLICATION_ERROR(-20032, 'VENTA NO ENCONTRADA');
            END IF;
        ELSE
            RAISE_APPLICATION_ERROR(-2003, 'INGRESE C R U D');
    END CASE;
END;
/

CREATE OR REPLACE PROCEDURE CRUD_DETALLE_VENTA(
    OPCION_P IN VARCHAR2,
    COD_VENTA_P IN NUMBER,
    COD_PRODUCTO_P IN NUMBER,
    CANTIDAD_P IN NUMBER,
    PRECIO_PRODUCTO_P IN NUMBER,
    PRECIO_TOTAL_P IN NUMBER,
    CUR_DET_VENTA OUT SYS_REFCURSOR
)
IS
BEGIN
    CASE UPPER(OPCION_P)
        WHEN 'C' THEN
            INSERT INTO JRGY_DETALLE_VENTA (COD_VENTA, COD_PRODUCTO, CANTIDAD, PRECIO_PRODUCTO, PRECIO_TOTAL)
            VALUES (COD_VENTA_P, COD_PRODUCTO_P, CANTIDAD_P, PRECIO_PRODUCTO_P, PRECIO_TOTAL_P);
        WHEN 'R' THEN
            OPEN CUR_DET_VENTA FOR
                SELECT COD_VENTA, COD_PRODUCTO, CANTIDAD, PRECIO_PRODUCTO, PRECIO_TOTAL
                FROM JRGY_DETALLE_VENTA
                WHERE COD_VENTA = COD_VENTA_P AND COD_PRODUCTO = COD_PRODUCTO_P;
        WHEN 'U' THEN
            UPDATE JRGY_DETALLE_VENTA
            SET CANTIDAD = CANTIDAD_P,
                PRECIO_PRODUCTO = PRECIO_PRODUCTO_P,
                PRECIO_TOTAL = PRECIO_TOTAL_P
            WHERE COD_VENTA = COD_VENTA_P AND COD_PRODUCTO = COD_PRODUCTO_P;
            IF SQL%ROWCOUNT = 0 THEN
                RAISE_APPLICATION_ERROR(-20033, 'DETALLE VENTA NO ENCONTRADO');
            END IF;
        WHEN 'D' THEN
            DELETE FROM JRGY_DETALLE_VENTA WHERE COD_VENTA = COD_VENTA_P AND COD_PRODUCTO = COD_PRODUCTO_P;
            IF SQL%ROWCOUNT = 0 THEN
                RAISE_APPLICATION_ERROR(-20033, 'DETALLE VENTA NO ENCONTRADO');
            END IF;
        ELSE
            RAISE_APPLICATION_ERROR(-2003, 'INGRESE C R U D');
    END CASE;
END;
/

-- CRUD movimiento stock
CREATE OR REPLACE PROCEDURE CRUD_MOVIMIENTO_STOCK(
    OPCION_P IN VARCHAR2,
    COD_MOVIMIENTO_P IN NUMBER,
    COD_PRODUCTO_P IN NUMBER,
    TIPO_MOVIMIENTO_P IN VARCHAR2,
    CANTIDAD_P IN NUMBER,
    FECHA_MOVIMIENTO_P IN DATE,
    MOTIVO_P IN VARCHAR2,
    CUR_MOV OUT SYS_REFCURSOR
)
IS
BEGIN
    CASE UPPER(OPCION_P)
        WHEN 'C' THEN
            INSERT INTO JRGY_MOVIMIENTO_STOCK (COD_MOVIMIENTO, COD_PRODUCTO, TIPO_MOVIMIENTO, CANTIDAD, FECHA_MOVIMIENTO, MOTIVO)
            VALUES (COD_MOVIMIENTO_P, COD_PRODUCTO_P, TIPO_MOVIMIENTO_P, CANTIDAD_P, FECHA_MOVIMIENTO_P, MOTIVO_P);
        WHEN 'R' THEN
            OPEN CUR_MOV FOR
                SELECT COD_MOVIMIENTO, COD_PRODUCTO, TIPO_MOVIMIENTO, CANTIDAD, FECHA_MOVIMIENTO, MOTIVO
                FROM JRGY_MOVIMIENTO_STOCK
                WHERE COD_MOVIMIENTO = COD_MOVIMIENTO_P;
        WHEN 'U' THEN
            UPDATE JRGY_MOVIMIENTO_STOCK
            SET COD_PRODUCTO = COD_PRODUCTO_P,
                TIPO_MOVIMIENTO = TIPO_MOVIMIENTO_P,
                CANTIDAD = CANTIDAD_P,
                FECHA_MOVIMIENTO = FECHA_MOVIMIENTO_P,
                MOTIVO = MOTIVO_P
            WHERE COD_MOVIMIENTO = COD_MOVIMIENTO_P;
            IF SQL%ROWCOUNT = 0 THEN
                RAISE_APPLICATION_ERROR(-20034, 'MOVIMIENTO NO ENCONTRADO');
            END IF;
        WHEN 'D' THEN
            DELETE FROM JRGY_MOVIMIENTO_STOCK WHERE COD_MOVIMIENTO = COD_MOVIMIENTO_P;
            IF SQL%ROWCOUNT = 0 THEN
                RAISE_APPLICATION_ERROR(-20034, 'MOVIMIENTO NO ENCONTRADO');
            END IF;
        ELSE
            RAISE_APPLICATION_ERROR(-2003, 'INGRESE C R U D');
    END CASE;
END;
/

-- CRUD pago venta
CREATE OR REPLACE PROCEDURE CRUD_PAGO_VENTA(
    OPCION_P IN VARCHAR2,
    COD_PAGO_P IN NUMBER,
    COD_VENTA_P IN NUMBER,
    COD_MODO_PAGO_P IN NUMBER,
    MONTO_P IN NUMBER,
    FECHA_PAGO_P IN DATE,
    CUR_PAGO_VENTA OUT SYS_REFCURSOR
)
IS
BEGIN
    CASE UPPER(OPCION_P)
        WHEN 'C' THEN
            INSERT INTO JRGY_PAGO_VENTA (COD_PAGO, COD_VENTA, COD_MODO_PAGO, MONTO, FECHA_PAGO)
            VALUES (COD_PAGO_P, COD_VENTA_P, COD_MODO_PAGO_P, MONTO_P, FECHA_PAGO_P);
        WHEN 'R' THEN
            OPEN CUR_PAGO_VENTA FOR
                SELECT COD_PAGO, COD_VENTA, COD_MODO_PAGO, MONTO, FECHA_PAGO
                FROM JRGY_PAGO_VENTA
                WHERE COD_PAGO = COD_PAGO_P;
        WHEN 'U' THEN
            UPDATE JRGY_PAGO_VENTA
            SET COD_VENTA = COD_VENTA_P,
                COD_MODO_PAGO = COD_MODO_PAGO_P,
                MONTO = MONTO_P,
                FECHA_PAGO = FECHA_PAGO_P
            WHERE COD_PAGO = COD_PAGO_P;
            IF SQL%ROWCOUNT = 0 THEN
                RAISE_APPLICATION_ERROR(-20035, 'PAGO VENTA NO ENCONTRADO');
            END IF;
        WHEN 'D' THEN
            DELETE FROM JRGY_PAGO_VENTA WHERE COD_PAGO = COD_PAGO_P;
            IF SQL%ROWCOUNT = 0 THEN
                RAISE_APPLICATION_ERROR(-20035, 'PAGO VENTA NO ENCONTRADO');
            END IF;
        ELSE
            RAISE_APPLICATION_ERROR(-2003, 'INGRESE C R U D');
    END CASE;
END;
/

-- Tipos auxiliares para gestores (ya creados arriba)

-- Funciones de apoyo
CREATE OR REPLACE FUNCTION FN_CALC_IVA(MONTO IN NUMBER) RETURN NUMBER IS
BEGIN
    RETURN ROUND(MONTO * 0.19, 2);
END;
/

CREATE OR REPLACE FUNCTION FN_CALC_COMISION(COD_EMPLEADO_P IN NUMBER, MONTO_VENTA IN NUMBER) RETURN NUMBER IS
    PCT NUMBER;
BEGIN
    SELECT NVL(COMISION, 0) INTO PCT FROM JRGY_EMPLEADO WHERE COD_EMPLEADO = COD_EMPLEADO_P;
    RETURN ROUND(MONTO_VENTA * (PCT / 100), 2);
EXCEPTION
    WHEN NO_DATA_FOUND THEN
        RETURN 0;
END;
/

CREATE OR REPLACE FUNCTION FN_STOCK_DISP(COD_PRODUCTO_P IN NUMBER) RETURN NUMBER IS
    STK NUMBER;
BEGIN
    SELECT NVL(STOCK_PRODUCTO, 0) INTO STK FROM JRGY_PRODUCTO WHERE COD_PRODUCTO = COD_PRODUCTO_P;
    RETURN STK;
EXCEPTION
    WHEN NO_DATA_FOUND THEN
        RETURN 0;
END;
/

-- Gestor: registrar venta con detalle, stock y movimientos
CREATE OR REPLACE PROCEDURE JRGY_PRO_REGISTRAR_VENTA (
    COD_USUARIO_P IN NUMBER,
    COD_EMPLEADO_P IN NUMBER,
    DETALLES_P IN DETALLE_VENTA_TAB,
    COD_VENTA_OUT OUT NUMBER,
    TOTAL_OUT OUT NUMBER
)
IS
    V_COD_VENTA NUMBER;
    V_TOTAL NUMBER := 0;
BEGIN
    IF DETALLES_P IS NULL OR DETALLES_P.COUNT = 0 THEN
        RAISE_APPLICATION_ERROR(-20040, 'DEBE ENVIAR DETALLES DE VENTA');
    END IF;

    V_COD_VENTA := SQ_PK_VENTA.NEXTVAL;

    FOR I IN 1 .. DETALLES_P.COUNT LOOP
        IF FN_STOCK_DISP(DETALLES_P(I).COD_PRODUCTO) < DETALLES_P(I).CANTIDAD THEN
            RAISE_APPLICATION_ERROR(-20041, 'STOCK INSUFICIENTE PARA PRODUCTO ' || DETALLES_P(I).COD_PRODUCTO);
        END IF;
        V_TOTAL := V_TOTAL + (DETALLES_P(I).CANTIDAD * DETALLES_P(I).PRECIO_PRODUCTO);
    END LOOP;

    INSERT INTO JRGY_VENTA (COD_VENTA, COD_USUARIO, COD_EMPLEADO, FECHA_VENTA)
    VALUES (V_COD_VENTA, COD_USUARIO_P, COD_EMPLEADO_P, SYSDATE);

    FOR I IN 1 .. DETALLES_P.COUNT LOOP
        INSERT INTO JRGY_DETALLE_VENTA (COD_VENTA, COD_PRODUCTO, CANTIDAD, PRECIO_PRODUCTO, PRECIO_TOTAL)
        VALUES (V_COD_VENTA, DETALLES_P(I).COD_PRODUCTO, DETALLES_P(I).CANTIDAD, DETALLES_P(I).PRECIO_PRODUCTO, DETALLES_P(I).CANTIDAD * DETALLES_P(I).PRECIO_PRODUCTO);

        UPDATE JRGY_PRODUCTO
        SET STOCK_PRODUCTO = STOCK_PRODUCTO - DETALLES_P(I).CANTIDAD
        WHERE COD_PRODUCTO = DETALLES_P(I).COD_PRODUCTO;

        INSERT INTO JRGY_MOVIMIENTO_STOCK (COD_MOVIMIENTO, COD_PRODUCTO, TIPO_MOVIMIENTO, CANTIDAD, FECHA_MOVIMIENTO, MOTIVO)
        VALUES (SQ_PK_MOVIMIENTO_STOCK.NEXTVAL, DETALLES_P(I).COD_PRODUCTO, 'SALIDA', DETALLES_P(I).CANTIDAD, SYSDATE, 'VENTA ' || V_COD_VENTA);
    END LOOP;

    COD_VENTA_OUT := V_COD_VENTA;
    TOTAL_OUT := V_TOTAL;
    COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE;
END;
/

-- Gestor: registrar pedido (recalcula total)
CREATE OR REPLACE PROCEDURE JRGY_PRO_REGISTRAR_PEDIDO (
    COD_EMPLEADO_P IN NUMBER,
    DETALLES_P IN DETALLE_PEDIDO_TAB,
    COD_PEDIDO_OUT OUT NUMBER,
    TOTAL_OUT OUT NUMBER
)
IS
    V_COD_PEDIDO NUMBER;
    V_TOTAL NUMBER := 0;
BEGIN
    IF DETALLES_P IS NULL OR DETALLES_P.COUNT = 0 THEN
        RAISE_APPLICATION_ERROR(-20042, 'DEBE ENVIAR DETALLES DE PEDIDO');
    END IF;

    V_COD_PEDIDO := SQ_PK_PEDIDO.NEXTVAL;

    FOR I IN 1 .. DETALLES_P.COUNT LOOP
        V_TOTAL := V_TOTAL + (DETALLES_P(I).CANTIDAD_PRODUCTO * DETALLES_P(I).PRECIO_COMPRA);
    END LOOP;

    INSERT INTO JRGY_PEDIDO (COD_PEDIDO, VALOR_TOTAL, FECHA_PEDIDO, COD_EMPLEADO)
    VALUES (V_COD_PEDIDO, V_TOTAL, SYSDATE, COD_EMPLEADO_P);

    FOR I IN 1 .. DETALLES_P.COUNT LOOP
        INSERT INTO JRGY_DETALLE_PEDIDO (COD_PEDIDO, COD_PROVEEDOR, COD_PRODUCTO, NOMBRE_PRODUCTO, CANTIDAD_PRODUCTO, PRECIO_COMPRA, PRECIO_TOTAL)
        VALUES (
            V_COD_PEDIDO,
            DETALLES_P(I).COD_PROVEEDOR,
            DETALLES_P(I).COD_PRODUCTO,
            DETALLES_P(I).NOMBRE_PRODUCTO,
            DETALLES_P(I).CANTIDAD_PRODUCTO,
            DETALLES_P(I).PRECIO_COMPRA,
            DETALLES_P(I).CANTIDAD_PRODUCTO * DETALLES_P(I).PRECIO_COMPRA
        );

        UPDATE JRGY_PRODUCTO
        SET STOCK_PRODUCTO = NVL(STOCK_PRODUCTO, 0) + DETALLES_P(I).CANTIDAD_PRODUCTO
        WHERE COD_PRODUCTO = DETALLES_P(I).COD_PRODUCTO;

        INSERT INTO JRGY_MOVIMIENTO_STOCK (COD_MOVIMIENTO, COD_PRODUCTO, TIPO_MOVIMIENTO, CANTIDAD, FECHA_MOVIMIENTO, MOTIVO)
        VALUES (SQ_PK_MOVIMIENTO_STOCK.NEXTVAL, DETALLES_P(I).COD_PRODUCTO, 'ENTRADA', DETALLES_P(I).CANTIDAD_PRODUCTO, SYSDATE, 'PEDIDO ' || V_COD_PEDIDO);
    END LOOP;

    COD_PEDIDO_OUT := V_COD_PEDIDO;
    TOTAL_OUT := V_TOTAL;
    COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE;
END;
/

-- Gestor: pago de habitación con detalle y cambio de estado
CREATE OR REPLACE PROCEDURE JRGY_PRO_PAGO_HABITACION (
    COD_USUARIO_P IN NUMBER,
    DETALLES_P IN DETALLE_ESTADIA_TAB,
    COD_PAGO_OUT OUT NUMBER,
    TOTAL_OUT OUT NUMBER
)
IS
    V_COD_PAGO NUMBER;
    V_TOTAL NUMBER := 0;
BEGIN
    IF DETALLES_P IS NULL OR DETALLES_P.COUNT = 0 THEN
        RAISE_APPLICATION_ERROR(-20043, 'DEBE ENVIAR DETALLES DE ESTADIA');
    END IF;

    V_COD_PAGO := SQ_PK_PAGO_HAB.NEXTVAL;

    FOR I IN 1 .. DETALLES_P.COUNT LOOP
        V_TOTAL := V_TOTAL + (DETALLES_P(I).PRECIO_HABITACION * DETALLES_P(I).DIAS);
    END LOOP;

    INSERT INTO JRGY_PAGO_HABITACION (COD_PAGO_HABITACION, FECHA_PAGO, VALOR_TOTAL_PAGO, COD_USUARIO)
    VALUES (V_COD_PAGO, SYSDATE, V_TOTAL, COD_USUARIO_P);

    FOR I IN 1 .. DETALLES_P.COUNT LOOP
        INSERT INTO JRGY_DETALLE_PAGO_HABITACION (COD_PAGO_HABITACION, COD_HABITACION, FECHA_ESTADIA, PRECIO_HABITACION, DIAS)
        VALUES (V_COD_PAGO, DETALLES_P(I).COD_HABITACION, DETALLES_P(I).FECHA_ESTADIA, DETALLES_P(I).PRECIO_HABITACION, DETALLES_P(I).DIAS);

        UPDATE JRGY_HABITACION
        SET COD_ESTADO_HABITACION = (
            SELECT COD_ESTADO_HABITACION
            FROM JRGY_CAT_ESTADO_HABITACION
            WHERE UPPER(ESTADO_HABITACION) = 'OCUPADA'
        )
        WHERE COD_HABITACION = DETALLES_P(I).COD_HABITACION;
    END LOOP;

    COD_PAGO_OUT := V_COD_PAGO;
    TOTAL_OUT := V_TOTAL;
    COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE;
END;
/

-- Gestor: recalcular stock desde movimientos
CREATE OR REPLACE PROCEDURE JRGY_PRO_RECALC_STOCK (
    COD_PRODUCTO_P IN NUMBER
)
IS
    V_STOCK NUMBER := 0;
BEGIN
    SELECT NVL(SUM(CASE WHEN TIPO_MOVIMIENTO = 'ENTRADA' THEN CANTIDAD WHEN TIPO_MOVIMIENTO = 'SALIDA' THEN -CANTIDAD ELSE 0 END), 0)
    INTO V_STOCK
    FROM JRGY_MOVIMIENTO_STOCK
    WHERE COD_PRODUCTO = COD_PRODUCTO_P;

    UPDATE JRGY_PRODUCTO SET STOCK_PRODUCTO = V_STOCK WHERE COD_PRODUCTO = COD_PRODUCTO_P;
    IF SQL%ROWCOUNT = 0 THEN
        RAISE_APPLICATION_ERROR(-20044, 'PRODUCTO NO ENCONTRADO');
    END IF;
    COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE;
END;
/

-- Gestor: asignar rol a usuario
CREATE OR REPLACE PROCEDURE JRGY_PRO_ASIGNAR_ROL (
    COD_USUARIO_P IN NUMBER,
    COD_ROL_P IN NUMBER
)
IS
    CURR SYS_REFCURSOR;
BEGIN
    CRUD_USUARIO_ROL('C', COD_USUARIO_P, COD_ROL_P, CURR);
END;
/

-- Reportes
CREATE OR REPLACE PACKAGE PKG_REPORTES AS
    TYPE CURSOR_P IS REF CURSOR;
    PROCEDURE REP_TOP_PRODUCTOS_MES (ANIO IN NUMBER, MES IN NUMBER, CURSOR_OUT OUT CURSOR_P);
    PROCEDURE REP_OCUPACION_HABITACIONES (CURSOR_OUT OUT CURSOR_P);
    PROCEDURE REP_COMPRAS_POR_PROVEEDOR (CURSOR_OUT OUT CURSOR_P);
END PKG_REPORTES;
/

CREATE OR REPLACE PACKAGE BODY PKG_REPORTES AS
    PROCEDURE REP_TOP_PRODUCTOS_MES (ANIO IN NUMBER, MES IN NUMBER, CURSOR_OUT OUT CURSOR_P) IS
    BEGIN
        OPEN CURSOR_OUT FOR
            SELECT dv.COD_PRODUCTO,
                   SUM(dv.CANTIDAD) AS TOTAL_VENDIDO,
                   SUM(dv.PRECIO_TOTAL) AS TOTAL_MONTO
            FROM JRGY_VENTA v
            JOIN JRGY_DETALLE_VENTA dv ON dv.COD_VENTA = v.COD_VENTA
            WHERE EXTRACT(YEAR FROM v.FECHA_VENTA) = ANIO
              AND EXTRACT(MONTH FROM v.FECHA_VENTA) = MES
            GROUP BY dv.COD_PRODUCTO
            ORDER BY TOTAL_VENDIDO DESC;
    END;

    PROCEDURE REP_OCUPACION_HABITACIONES (CURSOR_OUT OUT CURSOR_P) IS
    BEGIN
        OPEN CURSOR_OUT FOR
            SELECT CEH.ESTADO_HABITACION,
                   COUNT(*) AS TOTAL
            FROM JRGY_HABITACION H
            LEFT JOIN JRGY_CAT_ESTADO_HABITACION CEH ON CEH.COD_ESTADO_HABITACION = H.COD_ESTADO_HABITACION
            GROUP BY CEH.ESTADO_HABITACION;
    END;

    PROCEDURE REP_COMPRAS_POR_PROVEEDOR (CURSOR_OUT OUT CURSOR_P) IS
    BEGIN
        OPEN CURSOR_OUT FOR
            SELECT dp.COD_PROVEEDOR,
                   SUM(dp.PRECIO_TOTAL) AS TOTAL_COMPRADO,
                   COUNT(*) AS LINEAS
            FROM JRGY_DETALLE_PEDIDO dp
            GROUP BY dp.COD_PROVEEDOR
            ORDER BY TOTAL_COMPRADO DESC;
    END;
END PKG_REPORTES;
/

-- Reportes de ingresos/egresos/balance (para API /api/reports/*)
CREATE OR REPLACE PROCEDURE JRGY_PRO_REPORTE_INGRESOS_RESERVAS(
    P_FECHA_DESDE IN DATE,
    P_FECHA_HASTA IN DATE,
    CUR OUT SYS_REFCURSOR
) AS
BEGIN
    OPEN CUR FOR
        SELECT TRUNC(R.FECHA_INICIO) AS FECHA,
               SUM(NVL(R.TOTAL_HABITACION, 0) + NVL(R.TOTAL_SERVICIOS, 0)) AS MONTO
        FROM JRGY_RESERVA R
        WHERE (P_FECHA_DESDE IS NULL OR R.FECHA_INICIO >= P_FECHA_DESDE)
          AND (P_FECHA_HASTA IS NULL OR R.FECHA_FIN <= P_FECHA_HASTA)
        GROUP BY TRUNC(R.FECHA_INICIO)
        ORDER BY TRUNC(R.FECHA_INICIO);
END;
/

CREATE OR REPLACE PROCEDURE JRGY_PRO_REPORTE_INGRESOS_VENTAS(
    P_FECHA_DESDE IN DATE,
    P_FECHA_HASTA IN DATE,
    CUR OUT SYS_REFCURSOR
) AS
BEGIN
    OPEN CUR FOR
        SELECT TRUNC(V.FECHA_VENTA) AS FECHA,
               SUM(NVL(DV.PRECIO_TOTAL, NVL(DV.CANTIDAD, 0) * NVL(DV.PRECIO_PRODUCTO, 0))) AS MONTO
        FROM JRGY_VENTA V
        JOIN JRGY_DETALLE_VENTA DV ON DV.COD_VENTA = V.COD_VENTA
        WHERE (P_FECHA_DESDE IS NULL OR V.FECHA_VENTA >= P_FECHA_DESDE)
          AND (P_FECHA_HASTA IS NULL OR V.FECHA_VENTA <= P_FECHA_HASTA)
        GROUP BY TRUNC(V.FECHA_VENTA)
        ORDER BY TRUNC(V.FECHA_VENTA);
END;
/

CREATE OR REPLACE PROCEDURE JRGY_PRO_REPORTE_EGRESOS_COMPRAS(
    P_FECHA_DESDE IN DATE,
    P_FECHA_HASTA IN DATE,
    CUR OUT SYS_REFCURSOR
) AS
BEGIN
    OPEN CUR FOR
        SELECT TRUNC(P.FECHA_PEDIDO) AS FECHA,
               SUM(NVL(DP.PRECIO_TOTAL, NVL(DP.CANTIDAD_PRODUCTO, 0) * NVL(DP.PRECIO_COMPRA, 0))) AS MONTO
        FROM JRGY_PEDIDO P
        JOIN JRGY_DETALLE_PEDIDO DP ON DP.COD_PEDIDO = P.COD_PEDIDO
        WHERE (P_FECHA_DESDE IS NULL OR P.FECHA_PEDIDO >= P_FECHA_DESDE)
          AND (P_FECHA_HASTA IS NULL OR P.FECHA_PEDIDO <= P_FECHA_HASTA)
        GROUP BY TRUNC(P.FECHA_PEDIDO)
        ORDER BY TRUNC(P.FECHA_PEDIDO);
END;
/

CREATE OR REPLACE PROCEDURE JRGY_PRO_REPORTE_BALANCE(
    P_FECHA_DESDE IN DATE,
    P_FECHA_HASTA IN DATE,
    CUR OUT SYS_REFCURSOR
) AS
BEGIN
    OPEN CUR FOR
        WITH ING_RES AS (
            SELECT NVL(SUM(NVL(R.TOTAL_HABITACION, 0) + NVL(R.TOTAL_SERVICIOS, 0)), 0) AS TOTAL
            FROM JRGY_RESERVA R
            WHERE (P_FECHA_DESDE IS NULL OR R.FECHA_INICIO >= P_FECHA_DESDE)
              AND (P_FECHA_HASTA IS NULL OR R.FECHA_FIN <= P_FECHA_HASTA)
        ),
        ING_VEN AS (
            SELECT NVL(SUM(NVL(DV.PRECIO_TOTAL, NVL(DV.CANTIDAD, 0) * NVL(DV.PRECIO_PRODUCTO, 0))), 0) AS TOTAL
            FROM JRGY_VENTA V
            JOIN JRGY_DETALLE_VENTA DV ON DV.COD_VENTA = V.COD_VENTA
            WHERE (P_FECHA_DESDE IS NULL OR V.FECHA_VENTA >= P_FECHA_DESDE)
              AND (P_FECHA_HASTA IS NULL OR V.FECHA_VENTA <= P_FECHA_HASTA)
        ),
        EGR_COM AS (
            SELECT NVL(SUM(NVL(DP.PRECIO_TOTAL, NVL(DP.CANTIDAD_PRODUCTO, 0) * NVL(DP.PRECIO_COMPRA, 0))), 0) AS TOTAL
            FROM JRGY_PEDIDO P
            JOIN JRGY_DETALLE_PEDIDO DP ON DP.COD_PEDIDO = P.COD_PEDIDO
            WHERE (P_FECHA_DESDE IS NULL OR P.FECHA_PEDIDO >= P_FECHA_DESDE)
              AND (P_FECHA_HASTA IS NULL OR P.FECHA_PEDIDO <= P_FECHA_HASTA)
        )
        SELECT IR.TOTAL AS INGRESOS_RESERVAS,
               IV.TOTAL AS INGRESOS_VENTAS,
               EC.TOTAL AS EGRESOS_COMPRAS,
               (IR.TOTAL + IV.TOTAL - EC.TOTAL) AS UTILIDAD
        FROM ING_RES IR, ING_VEN IV, EGR_COM EC;
END;
/

PROMPT Triggers de negocio...
-- 7) Triggers de negocio
CREATE OR REPLACE TRIGGER TRG_VALIDA_STOCK_VENTA
    BEFORE INSERT OR UPDATE ON JRGY_DETALLE_VENTA
    FOR EACH ROW
DECLARE
    V_STOCK NUMBER;
BEGIN
    SELECT NVL(STOCK_PRODUCTO,0) INTO V_STOCK FROM JRGY_PRODUCTO WHERE COD_PRODUCTO = :NEW.COD_PRODUCTO;
    IF :NEW.CANTIDAD > V_STOCK THEN
        RAISE_APPLICATION_ERROR(-20050, 'STOCK INSUFICIENTE PARA PRODUCTO ' || :NEW.COD_PRODUCTO);
    END IF;
END;
/

CREATE OR REPLACE TRIGGER TRG_HAB_OCUPADA_ON_DETALLE
    AFTER INSERT ON JRGY_DETALLE_PAGO_HABITACION
    FOR EACH ROW
BEGIN
    UPDATE JRGY_HABITACION
    SET COD_ESTADO_HABITACION = (
        SELECT COD_ESTADO_HABITACION
        FROM JRGY_CAT_ESTADO_HABITACION
        WHERE UPPER(ESTADO_HABITACION) = 'OCUPADA'
    )
    WHERE COD_HABITACION = :NEW.COD_HABITACION;
END;
/

CREATE OR REPLACE TRIGGER TRG_HAB_LIBRE_ON_DETALLE_DEL
    AFTER DELETE ON JRGY_DETALLE_PAGO_HABITACION
    FOR EACH ROW
BEGIN
    UPDATE JRGY_HABITACION
    SET COD_ESTADO_HABITACION = (
        SELECT COD_ESTADO_HABITACION
        FROM JRGY_CAT_ESTADO_HABITACION
        WHERE UPPER(ESTADO_HABITACION) = 'LIBRE'
    )
    WHERE COD_HABITACION = :OLD.COD_HABITACION;
END;
/

CREATE OR REPLACE TRIGGER TRG_RESERVA_NO_OVERLAP
    BEFORE INSERT OR UPDATE ON JRGY_RESERVA
    FOR EACH ROW
DECLARE
    v_current_id NUMBER := NVL(:NEW.COD_RESERVA, :OLD.COD_RESERVA);
    v_dummy NUMBER;
BEGIN
    -- Si solo cambia estado u otros campos sin modificar fechas ni habitación, omite validación.
    IF UPDATING
       AND :NEW.COD_HABITACION = :OLD.COD_HABITACION
       AND :NEW.FECHA_INICIO = :OLD.FECHA_INICIO
       AND :NEW.FECHA_FIN = :OLD.FECHA_FIN THEN
        RETURN;
    END IF;

    -- Validacion de fechas
    IF :NEW.FECHA_FIN < :NEW.FECHA_INICIO THEN
        RAISE_APPLICATION_ERROR(-20060, 'La fecha fin debe ser mayor o igual a la de inicio');
    END IF;

    -- Evita solapes de reservas en la misma habitacion
    BEGIN
        SELECT 1
        INTO v_dummy
        FROM JRGY_RESERVA
        WHERE COD_HABITACION = :NEW.COD_HABITACION
          AND (:NEW.FECHA_INICIO <= FECHA_FIN AND :NEW.FECHA_FIN >= FECHA_INICIO)
          AND (v_current_id IS NULL OR COD_RESERVA <> v_current_id)
        FOR UPDATE NOWAIT;

        RAISE_APPLICATION_ERROR(-20061, 'La habitacion ya esta reservada en ese rango de fechas');
    EXCEPTION
        WHEN NO_DATA_FOUND THEN
            NULL;
        WHEN OTHERS THEN
            IF SQLCODE = -54 THEN
                RAISE_APPLICATION_ERROR(-20062, 'Reserva en curso para esta habitacion, intenta de nuevo');
            ELSE
                RAISE;
            END IF;
    END;
END;
/

-- Sincroniza estado de habitacion según el estado de la reserva
CREATE OR REPLACE TRIGGER TRG_RESERVA_SYNC_ESTADO_HAB
    AFTER INSERT OR UPDATE OF COD_ESTADO_RESERVA ON JRGY_RESERVA
    FOR EACH ROW
DECLARE
    v_est_en_proceso   NUMBER;
    v_est_finalizada   NUMBER;
    v_est_cancelada    NUMBER;
    v_est_checkout_sol NUMBER;
    v_hab_ocupada      NUMBER;
    v_hab_libre        NUMBER;
    v_activos          NUMBER := 0;
BEGIN
    SELECT COD_ESTADO_RESERVA INTO v_est_en_proceso
    FROM JRGY_CAT_ESTADO_RESERVA
    WHERE REPLACE(UPPER(ESTADO_RESERVA), '_', ' ') = 'EN PROCESO';

    SELECT COD_ESTADO_RESERVA INTO v_est_finalizada
    FROM JRGY_CAT_ESTADO_RESERVA
    WHERE REPLACE(UPPER(ESTADO_RESERVA), '_', ' ') = 'FINALIZADA';

    SELECT COD_ESTADO_RESERVA INTO v_est_cancelada
    FROM JRGY_CAT_ESTADO_RESERVA
    WHERE REPLACE(UPPER(ESTADO_RESERVA), '_', ' ') = 'CANCELADA';

    SELECT COD_ESTADO_RESERVA INTO v_est_checkout_sol
    FROM JRGY_CAT_ESTADO_RESERVA
    WHERE REPLACE(UPPER(ESTADO_RESERVA), '_', ' ') = 'CHECKOUT SOLICITADO';

    SELECT COD_ESTADO_HABITACION INTO v_hab_ocupada
    FROM JRGY_CAT_ESTADO_HABITACION
    WHERE REPLACE(UPPER(ESTADO_HABITACION), '_', ' ') = 'OCUPADA';

    SELECT COD_ESTADO_HABITACION INTO v_hab_libre
    FROM JRGY_CAT_ESTADO_HABITACION
    WHERE REPLACE(UPPER(ESTADO_HABITACION), '_', ' ') = 'LIBRE';

    -- Al pasar a EN PROCESO, marca la habitación como OCUPADA
    IF :NEW.COD_ESTADO_RESERVA = v_est_en_proceso THEN
        UPDATE JRGY_HABITACION
        SET COD_ESTADO_HABITACION = v_hab_ocupada
        WHERE COD_HABITACION = :NEW.COD_HABITACION;
    ELSIF :NEW.COD_ESTADO_RESERVA IN (v_est_finalizada, v_est_cancelada) THEN
        -- Al finalizar/cancelar, libera solo si no hay otra reserva activa en la misma habitación
        SELECT COUNT(*) INTO v_activos
        FROM JRGY_RESERVA r
        WHERE r.COD_HABITACION = :NEW.COD_HABITACION
          AND r.COD_RESERVA <> :NEW.COD_RESERVA
          AND r.COD_ESTADO_RESERVA IN (v_est_en_proceso, v_est_checkout_sol);

        IF v_activos = 0 THEN
            UPDATE JRGY_HABITACION
            SET COD_ESTADO_HABITACION = v_hab_libre
            WHERE COD_HABITACION = :NEW.COD_HABITACION;
        END IF;
    END IF;
END;
/

PROMPT Sincronizacion de secuencias base (usuario, empleado, cliente)...
DECLARE
    PROCEDURE sync_seq(p_seq_name VARCHAR2, p_table VARCHAR2, p_column VARCHAR2) IS
        v_curr NUMBER;
        v_next NUMBER;
    BEGIN
        EXECUTE IMMEDIATE 'SELECT NVL(MAX(' || p_column || '), 0) + 1 FROM ' || p_table INTO v_next;

        BEGIN
            SELECT last_number INTO v_curr FROM user_sequences WHERE sequence_name = UPPER(p_seq_name);
        EXCEPTION
            WHEN NO_DATA_FOUND THEN
                RETURN; -- La secuencia no existe, se omite el ajuste
        END;

        IF v_curr < v_next THEN
            EXECUTE IMMEDIATE 'ALTER SEQUENCE ' || p_seq_name || ' INCREMENT BY ' || (v_next - v_curr);
            EXECUTE IMMEDIATE 'SELECT ' || p_seq_name || '.NEXTVAL FROM dual' INTO v_curr;
            EXECUTE IMMEDIATE 'ALTER SEQUENCE ' || p_seq_name || ' INCREMENT BY 1';
        END IF;
    END;
BEGIN
    sync_seq('SQ_PK_EMPLEADO', 'JRGY_EMPLEADO', 'COD_EMPLEADO');
    sync_seq('SQ_PK_CLIENTE', 'JRGY_CLIENTE', 'COD_CLIENTE');
END;
/

PROMPT Datos iniciales (usuarios semilla)...
DECLARE
    v_admin_role_id NUMBER;
    v_employee_role_id NUMBER;
    v_user_role_id NUMBER;
    v_user_id NUMBER;
    v_estado_activo NUMBER;
    v_estado_laboral_activo NUMBER;
    v_dummy NUMBER;

    FUNCTION ensure_user(
        p_cod_usuario NUMBER,
        p_nombre VARCHAR2,
        p_apellido1 VARCHAR2,
        p_apellido2 VARCHAR2,
        p_email VARCHAR2,
        p_telefono NUMBER,
        p_hash VARCHAR2,
        p_cod_estado NUMBER
    ) RETURN NUMBER IS
        v_id NUMBER;
    BEGIN
        BEGIN
            SELECT COD_USUARIO INTO v_id FROM JRGY_USUARIO WHERE LOWER(EMAIL_USUARIO) = LOWER(p_email);
        EXCEPTION
            WHEN NO_DATA_FOUND THEN
                INSERT INTO JRGY_USUARIO (
                    COD_USUARIO,
                    NOMBRE_USUARIO,
                    APELLIDO1_USUARIO,
                    APELLIDO2_USUARIO,
                    EMAIL_USUARIO,
                    TELEFONO_USUARIO,
                    CONTRASENA_HASH,
                    COD_ESTADO_USUARIO
                ) VALUES (
                    p_cod_usuario,
                    p_nombre,
                    p_apellido1,
                    p_apellido2,
                    p_email,
                    p_telefono,
                    p_hash,
                    p_cod_estado
                );
                v_id := p_cod_usuario;
        END;
        RETURN v_id;
    END;

    PROCEDURE ensure_user_role(p_usuario_id NUMBER, p_role_id NUMBER) IS
    BEGIN
        BEGIN
            SELECT 1 INTO v_dummy FROM JRGY_USUARIO_ROL WHERE COD_USUARIO = p_usuario_id AND COD_ROL = p_role_id;
        EXCEPTION
            WHEN NO_DATA_FOUND THEN
                INSERT INTO JRGY_USUARIO_ROL (COD_USUARIO, COD_ROL) VALUES (p_usuario_id, p_role_id);
        END;
    END;

    PROCEDURE ensure_empleado(p_usuario_id NUMBER) IS
        v_exists NUMBER;
    BEGIN
        BEGIN
            SELECT COD_EMPLEADO INTO v_exists FROM JRGY_EMPLEADO WHERE COD_USUARIO = p_usuario_id;
        EXCEPTION
            WHEN NO_DATA_FOUND THEN
                INSERT INTO JRGY_EMPLEADO (
                    COD_USUARIO,
                    COD_DEPARTAMENTO,
                    CARGO,
                    FECHA_CONTRATACION,
                    SALARIO,
                    COMISION,
                    COD_ESTADO_LABORAL
                ) VALUES (
                    p_usuario_id,
                    NULL,
                    'Recepcionista',
                    SYSDATE,
                    850000,
                    0,
                    v_estado_laboral_activo
                );
        END;
    END;

    PROCEDURE ensure_cliente(p_usuario_id NUMBER) IS
        v_exists NUMBER;
    BEGIN
        BEGIN
            SELECT COD_CLIENTE INTO v_exists FROM JRGY_CLIENTE WHERE COD_USUARIO = p_usuario_id;
        EXCEPTION
            WHEN NO_DATA_FOUND THEN
                INSERT INTO JRGY_CLIENTE (COD_USUARIO, FECHA_ALTA) VALUES (p_usuario_id, SYSDATE);
        END;
    END;
BEGIN
    -- Asegura estado ACTIVO en catálogo de estado de usuario.
    BEGIN
        SELECT COD_ESTADO_USUARIO INTO v_estado_activo
        FROM JRGY_CAT_ESTADO_USUARIO
        WHERE UPPER(ESTADO_USUARIO) = 'ACTIVO';
    EXCEPTION
        WHEN NO_DATA_FOUND THEN
            v_estado_activo := 1;
            INSERT INTO JRGY_CAT_ESTADO_USUARIO (COD_ESTADO_USUARIO, ESTADO_USUARIO)
            VALUES (v_estado_activo, 'ACTIVO');
    END;

    -- Asegura estados laborales.
    BEGIN
        SELECT COD_ESTADO_LABORAL INTO v_estado_laboral_activo
        FROM JRGY_CAT_ESTADO_LABORAL
        WHERE UPPER(ESTADO_LABORAL) = 'ACTIVO';
    EXCEPTION
        WHEN NO_DATA_FOUND THEN
            v_estado_laboral_activo := 1;
            INSERT INTO JRGY_CAT_ESTADO_LABORAL (COD_ESTADO_LABORAL, ESTADO_LABORAL)
            VALUES (v_estado_laboral_activo, 'ACTIVO');
    END;
    -- Otros estados laborales (SUSPENDIDO, INACTIVO, DESPEDIDO, RENUNCIADO) se siembran en el bloque de catálogos.

    -- Obtiene IDs de roles.
    SELECT COD_ROL INTO v_admin_role_id FROM JRGY_ROL WHERE UPPER(NOMBRE_ROL) = 'ADMIN';
    SELECT COD_ROL INTO v_employee_role_id FROM JRGY_ROL WHERE UPPER(NOMBRE_ROL) = 'EMPLOYEE';
    SELECT COD_ROL INTO v_user_role_id FROM JRGY_ROL WHERE UPPER(NOMBRE_ROL) = 'USER';

    -- Admin semilla.
    v_user_id := ensure_user(
        11111111,
        'Gustavo_admin_page',
        'Gallegos',
        'Harnisch',
        'gustavo.admin@example.com',
        123456789,
        '$2a$10$TEzTimE.MHdyd9edy0W6Dua67ktRlgy2eC4p2FsV23jqc0MVyhu8m',
        v_estado_activo
    );
    ensure_user_role(v_user_id, v_admin_role_id);

    -- Empleado semilla.
    v_user_id := ensure_user(
        22222222,
        'Gustavo',
        'Empleado',
        'Demo',
        'gustavo.empleado@example.com',
        222333444,
        '$2a$10$zBuRY6j5e71C/oJQKD4D.eiUwKzhSlW5OGjagq2l4dHrClhFp1kS.',
        v_estado_activo
    );
    ensure_user_role(v_user_id, v_employee_role_id);
    ensure_empleado(v_user_id);

    -- Cliente semilla.
    v_user_id := ensure_user(
        33333333,
        'Gustavo',
        'Cliente',
        'Demo',
        'gustavo.cliente@example.com',
        333444555,
        '$2a$10$0XjtE1K9zwiX5EsnmV6N8ukKR5vATvI3/cKBKbPTkQoeISfUFS8EW',
        v_estado_activo
    );
    ensure_user_role(v_user_id, v_user_role_id);
    ensure_cliente(v_user_id);
END;
/

PROMPT Datos iniciales (habitaciones demo reales)...
DECLARE
    v_estado_libre NUMBER;
    v_tipo_simple NUMBER;
    v_tipo_matrimonial NUMBER;
    v_tipo_confort NUMBER;
    v_tipo_mat_fam NUMBER;
    v_tipo_suite NUMBER;

    PROCEDURE ensure_room(p_nro NUMBER, p_capacidad NUMBER, p_tipo NUMBER, p_precio NUMBER) IS
        v_id NUMBER;
    BEGIN
        BEGIN
            SELECT COD_HABITACION INTO v_id FROM JRGY_HABITACION WHERE NRO_HABITACION = p_nro;
        EXCEPTION
            WHEN NO_DATA_FOUND THEN
                INSERT INTO JRGY_HABITACION (NRO_HABITACION, CAPACIDAD, COD_TIPO_HABITACION, COD_ESTADO_HABITACION, PRECIO_BASE)
                VALUES (p_nro, p_capacidad, p_tipo, v_estado_libre, p_precio);
        END;
    END;
BEGIN
    SELECT COD_ESTADO_HABITACION INTO v_estado_libre FROM JRGY_CAT_ESTADO_HABITACION WHERE UPPER(ESTADO_HABITACION) = 'LIBRE';
    SELECT COD_TIPO_HABITACION INTO v_tipo_simple FROM JRGY_CAT_TIPO_HABITACION WHERE UPPER(TIPO_HABITACION) = 'SIMPLE';
    SELECT COD_TIPO_HABITACION INTO v_tipo_matrimonial FROM JRGY_CAT_TIPO_HABITACION WHERE UPPER(TIPO_HABITACION) = 'MATRIMONIAL';
    SELECT COD_TIPO_HABITACION INTO v_tipo_confort FROM JRGY_CAT_TIPO_HABITACION WHERE UPPER(TIPO_HABITACION) = 'CONFORT';
    SELECT COD_TIPO_HABITACION INTO v_tipo_mat_fam FROM JRGY_CAT_TIPO_HABITACION WHERE UPPER(TIPO_HABITACION) = 'MATRIMONIAL_FAMILIAR';
    SELECT COD_TIPO_HABITACION INTO v_tipo_suite FROM JRGY_CAT_TIPO_HABITACION WHERE UPPER(TIPO_HABITACION) = 'SUITE';

    -- Simple
    ensure_room(101, 1, v_tipo_simple, 45000);
    ensure_room(102, 1, v_tipo_simple, 45000);
    ensure_room(103, 1, v_tipo_simple, 45000);

    -- Matrimonial (capacidad 2)
    ensure_room(201, 2, v_tipo_matrimonial, 60000);
    ensure_room(202, 2, v_tipo_matrimonial, 60000);
    ensure_room(203, 2, v_tipo_matrimonial, 60000);

    -- Confort (2 camas, capacidad 2)
    ensure_room(301, 2, v_tipo_confort, 70000);
    ensure_room(302, 2, v_tipo_confort, 70000);
    ensure_room(303, 2, v_tipo_confort, 70000);

    -- Matrimonial familiar (1 matrimonial + 2 simples, capacidad 4)
    ensure_room(401, 4, v_tipo_mat_fam, 90000);
    ensure_room(402, 4, v_tipo_mat_fam, 90000);
    ensure_room(403, 4, v_tipo_mat_fam, 90000);

    -- Suite (3 camas individuales, capacidad 3)
    ensure_room(501, 3, v_tipo_suite, 85000);
    ensure_room(502, 3, v_tipo_suite, 85000);
    ensure_room(503, 3, v_tipo_suite, 85000);
END;
/
