Guía rápida: Pagos, balances e ingresos/egresos
===============================================
Objetivo
- Definir cómo calcular y consultar ganancias/pérdidas combinando ingresos (reservas/ventas) y egresos (compras a proveedores), solo para ADMIN/EMPLOYEE.
- Unificar el uso de procedimientos (sin SQL directo) para reportes financieros básicos.

Estado actual en BD
- Ingresos:
  * Reservas: JRGY_RESERVA (totales habitación/servicios) y eventos; pagos habitaciones en JRGY_PAGO_HABITACION + JRGY_DETALLE_PAGO_HABITACION.
  * Servicios en reservas: JRGY_RESERVA_SERVICIO / procs de reserva-servicio.
  * Ventas de productos: JRGY_VENTA y JRGY_DETALLE_VENTA; pagos en JRGY_PAGO_VENTA (modo de pago).
- Egresos:
  * Compras: JRGY_PEDIDO + JRGY_DETALLE_PEDIDO (producto, cantidad, precio_compra).
  * Movimientos de stock (entradas/salidas) en JRGY_MOVIMIENTO_STOCK.
- Catálogo de medios de pago: JRGY_CAT_MODO_PAGO.

Procedimientos recomendados (reporting)
- Ingresos:
  * JRGY_PRO_REPORTE_INGRESOS_RESERVAS(p_fecha_desde, p_fecha_hasta, cur OUT): suma por día/mes de reservas y servicios asociados.
  * JRGY_PRO_REPORTE_INGRESOS_VENTAS(p_fecha_desde, p_fecha_hasta, cur OUT): suma ventas de productos (detalle_venta).
- Egresos:
  * JRGY_PRO_REPORTE_EGRESOS_COMPRAS(p_fecha_desde, p_fecha_hasta, cur OUT): suma de pedidos/detalle_pedido (precio_compra*cantidad).
  * (Opcional) JRGY_PRO_REPORTE_STOCK_VALORIZADO(cur OUT): stock actual * costo último o costo promedio (definir política).
- Balance:
  * JRGY_PRO_REPORTE_BALANCE(p_fecha_desde, p_fecha_hasta, cur OUT): ingresos - egresos agregados; devolver ingresos_reservas, ingresos_ventas, egresos_compras y utilidad.

Roles y permisos
- ADMIN: acceso a todos los reportes; puede ver y exportar balances.
- EMPLOYEE: puede consultar reportes operativos (ingresos/egresos) si se le otorga permiso de rol; no modifica catálogos financieros.
- USER: sin acceso.

Pautas de implementación backend/front
- Backend: exponer endpoints /api/reports/... que llamen a los procs anteriores; sin SQL directo. Validar rol ADMIN (y EMPLOYEE si aplica).
- Front admin: vista de reportes con filtros de fecha y tarjetas de resumen (ingresos, egresos, utilidad). Permitir exportar CSV.

Notas de diseño
- Decidir política de costo para stock valorizado (último costo vs. promedio ponderado).
- Pagos: si se quiere reflejar caja vs. devengado, agregar campos de fecha de pago real en compras y reservas. De momento usar fecha de pedido/venta/reserva.
- Considerar timezone y cerrar periodos por día/mes en los procs.

Comportamiento esperado por rol
- ADMIN:
  * Puede consultar, filtrar por fecha y exportar reportes de ingresos, egresos y balance.
  * Ve detalle por categoría (reservas habitación, servicios en reserva, ventas de productos, compras a proveedores) y subtotales diarios/mensuales.
  * Puede delegar lectura a EMPLOYEE marcando permiso en rol (configurable en backend).
- EMPLOYEE:
  * Solo lectura: ve ingresos y egresos para operar (stock, caja) pero no modifica catálogos financieros.
  * No puede exportar datos sensibles si no tiene flag de permiso.
- USER:
  * Sin acceso a reportes; solo ve sus propias transacciones en sus flujos (no forma parte del balance global).

Relación tablas → reportes
- Ingresos:
  * Habitación: JRGY_RESERVA (TOTAL_RESERVA, TOTAL_HAB) y JRGY_PAGO_HABITACION/DETALLE_PAGO_HABITACION para trazabilidad de cobros.
  * Servicios en reserva: JRGY_RESERVA_SERVICIO (TOTAL_ITEM) vinculado a reserva; usar validaciones de horario/estado servicio.
  * Ventas de productos: JRGY_VENTA + JRGY_DETALLE_VENTA, modo de pago en JRGY_PAGO_VENTA.
  * Nota: evitar doble conteo; si se suman pagos, debe evitarse sumar también totales devengados en el mismo periodo (definir política).
- Egresos:
  * Compras: JRGY_PEDIDO + JRGY_DETALLE_PEDIDO (precio_compra*cantidad).
  * Movimientos stock: JRGY_MOVIMIENTO_STOCK puede alimentar un reporte de valorización o ajustes (SALIDA/ENTRADA con motivo).

Endpoints sugeridos (backend)
- GET /api/reports/ingresos?desde=YYYY-MM-DD&hasta=YYYY-MM-DD -> llama a proc ingresos reservas + ingresos ventas; retorna lista por fecha + subtotales.
- GET /api/reports/egresos?desde=YYYY-MM-DD&hasta=YYYY-MM-DD -> proc compras; opcional valorizado de stock si se agrega.
- GET /api/reports/balance?desde=YYYY-MM-DD&hasta=YYYY-MM-DD -> proc balance; retorna ingresos_reservas, ingresos_ventas, egresos_compras, utilidad, desglose diario.
- Autorización: require ADMIN; EMPLOYEE solo si el rol incluye permiso (hasRole + flag).

Front (vista reportes)
- Filtros de fecha (desde/hasta), botón exportar CSV.
- Tarjetas resumen: Ingresos reservas, Ingresos ventas, Egresos compras, Utilidad.
- Gráficos simples (línea/área) por día; tabla con desglose por origen (habitaciones/servicios/ventas vs compras).
- Mensajes claros si no hay datos en rango.

Pendientes para cerrar con código
- Crear procs de reporte mencionados (si no existen) o documentar nombres finales en memoria_ia.txt.
- Añadir rutas en backend (/api/reports/*) que consuman exclusivamente los procs.
- Implementar página `/admin/reports` en frontend con UI anterior.
- Decidir política de devengado vs pagado y reflejarla en los procs para evitar doble conteo.

Implementado en código
- Backend: rutas /api/reports/ingresos, /api/reports/egresos, /api/reports/balance con validación ADMIN/EMPLOYEE (ver backend/src/routes/reports.js).
- Frontend: página `/admin/reports` accesible desde navbar admin, con filtros y tarjetas/tablas (ver frontend/src/pages/admin/AdminReports.jsx).
